<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AV Project Management Tool - Enhanced Edition</title>
    
    <!-- Enhanced Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* ==================== SHARED STYLES ==================== */
        :root {
            --primary-50: #f0f9ff;
            --primary-100: #e0f2fe;
            --primary-200: #bae6fd;
            --primary-300: #7dd3fc;
            --primary-400: #38bdf8;
            --primary-500: #0ea5e9;
            --primary-600: #0284c7;
            --primary-700: #0369a1;
            --primary-800: #075985;
            --primary-900: #0c4a6e;
            
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            
            --success-50: #f0fdf4;
            --success-100: #dcfce7;
            --success-200: #bbf7d0;
            --success-300: #86efac;
            --success-400: #4ade80;
            --success-500: #22c55e;
            --success-600: #16a34a;
            
            --warning-50: #fffbeb;
            --warning-100: #fef3c7;
            --warning-200: #fde68a;
            --warning-300: #fcd34d;
            --warning-400: #fbbf24;
            --warning-500: #f59e0b;
            --warning-600: #d97706;
            
            --danger-50: #fef2f2;
            --danger-100: #fee2e2;
            --danger-200: #fecaca;
            --danger-300: #fca5a5;
            --danger-400: #f87171;
            --danger-500: #ef4444;
            --danger-600: #dc2626;
            
            --transition-speed: 200ms;
            --animation-speed: 300ms;
        }

        /* Dark Mode Variables */
        [data-theme="dark"] {
            --primary-50: #000000;
            --primary-100: #111111;
            --primary-200: #1a1a1a;
            --primary-300: #2a2a2a;
            --primary-400: #3a3a3a;
            --primary-500: #0ea5e9;
            --primary-600: #38bdf8;
            --primary-700: #7dd3fc;
            --primary-800: #bae6fd;
            --primary-900: #e0f2fe;
            
            --gray-50: #000000;
            --gray-100: #000000;
            --gray-200: #111111;
            --gray-300: #1a1a1a;
            --gray-400: #666666;
            --gray-500: #888888;
            --gray-600: #aaaaaa;
            --gray-700: #cccccc;
            --gray-800: #e0e0e0;
            --gray-900: #e8e8e8;
            
            --success-50: #000000;
            --success-100: #111111;
            --success-200: #1a1a1a;
            --success-500: #22c55e;
            --success-600: #16a34a;
            
            --warning-50: #000000;
            --warning-100: #111111;
            --warning-200: #1a1a1a;
            --warning-500: #fbbf24;
            --warning-600: #f59e0b;
            
            --danger-50: #000000;
            --danger-100: #111111;
            --danger-200: #1a1a1a;
            --danger-500: #ef4444;
            --danger-600: #dc2626;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: background-color var(--transition-speed) ease,
                        border-color var(--transition-speed) ease,
                        box-shadow var(--transition-speed) ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--gray-100);
            color: var(--gray-900);
            font-size: 14px;
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 1rem 1.5rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            animation: slideIn var(--animation-speed) ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            max-width: 400px;
        }

        [data-theme="dark"] .notification {
            background: #1a1a1a;
            color: #e8e8e8;
            border: 1px solid #333333;
        }

        .notification-success {
            border-left: 4px solid var(--success-500);
        }

        .notification-error {
            border-left: 4px solid var(--danger-500);
        }

        .notification-warning {
            border-left: 4px solid var(--warning-500);
        }

        .notification-info {
            border-left: 4px solid var(--primary-500);
        }

        .notification-icon {
            font-size: 1.25rem;
        }

        .notification-content {
            flex: 1;
        }

        .notification-close {
            cursor: pointer;
            opacity: 0.6;
            transition: opacity var(--transition-speed);
        }

        .notification-close:hover {
            opacity: 1;
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--gray-300);
            border-top-color: var(--primary-500);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            animation: fadeIn var(--animation-speed);
        }

        [data-theme="dark"] .loading-overlay {
            background: rgba(0, 0, 0, 0.9);
        }

        /* Navigation System */
        .app-navigation {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--gray-900);
            z-index: 1000;
            padding: 1rem 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            animation: slideDown var(--animation-speed) ease;
        }

        .nav-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.25rem;
        }

        .nav-title {
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .nav-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            font-size: 0.75rem;
            color: white;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-500);
            animation: pulse 2s infinite;
        }

        .status-indicator.offline {
            background: var(--warning-500);
        }

        .nav-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-btn {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .nav-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Theme Toggle */
        .theme-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
            color: white;
            font-size: 1.25rem;
            transition: all var(--transition-speed);
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Navigation Dark Mode Overrides */
        [data-theme="dark"] .app-navigation {
            background: #000000;
            border-bottom: 1px solid #333333;
        }

        [data-theme="dark"] .nav-title {
            color: #e8e8e8;
        }

        [data-theme="dark"] .nav-status {
            background: rgba(255, 255, 255, 0.05);
            color: #e8e8e8;
        }

        [data-theme="dark"] .theme-toggle {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #333333;
            color: #e8e8e8;
        }

        [data-theme="dark"] .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .nav-btn.secondary {
            background: rgba(255, 255, 255, 0.05);
            color: #e8e8e8;
        }

        /* Page Containers */
        .page-container {
            display: none;
            padding-top: 80px;
            min-height: 100vh;
            background: var(--gray-50);
            animation: fadeIn var(--animation-speed);
        }

        .page-container.active {
            display: block;
        }

        /* ==================== LANDING PAGE STYLES ==================== */
        .landing-page {
            position: relative;
            z-index: 1;
        }

        .landing-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header Section */
        .landing-header {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--gray-200);
            animation: fadeIn var(--animation-speed) ease;
        }

        [data-theme="dark"] .landing-header {
            background: #000000;
            border-color: #333333;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 2rem;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.25rem;
            box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.2);
        }

        .app-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--gray-900);
        }


        .subtitle {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-top: 0.25rem;
        }



        /* Action Buttons */
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.875rem 1.75rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px -2px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 2px solid var(--gray-200);
        }

        [data-theme="dark"] .btn-secondary {
            background: #1a1a1a;
            color: #e8e8e8;
            border-color: #666666;
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--gray-50);
            border-color: var(--gray-300);
        }

        [data-theme="dark"] .btn-secondary:hover:not(:disabled) {
            background: #333333;
            border-color: #888888;
        }

        .btn-icon {
            font-size: 1.125rem;
        }

        /* Search and Filter Bar */
        .controls-bar {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
            border: 1px solid var(--gray-200);
            animation: fadeIn var(--animation-speed) ease 0.1s both;
        }

        [data-theme="dark"] .controls-bar {
            background: #000000;
            border-color: #333333;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 2px solid var(--gray-200);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all var(--transition-speed);
            background: white;
            color: var(--gray-900);
        }

        [data-theme="dark"] .search-input {
            background: #1a1a1a;
            border-color: #666666;
            color: #e8e8e8;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .filter-select {
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            background: white;
            color: var(--gray-900);
            cursor: pointer;
            transition: all var(--transition-speed);
            min-width: 150px;
        }

        [data-theme="dark"] .filter-select {
            background: #1a1a1a;
            border-color: #666666;
            color: #e8e8e8;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        /* Analytics Dashboard */
        .analytics-dashboard {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-200);
            animation: fadeIn var(--animation-speed) ease 0.2s both;
        }

        [data-theme="dark"] .analytics-dashboard {
            background: #000000;
            border-color: #333333;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-100);
        }

        [data-theme="dark"] .dashboard-header {
            border-bottom-color: #333333;
        }

        .dashboard-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
        }


        .dashboard-subtitle {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-top: 0.25rem;
        }


        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            transition: all var(--transition-speed);
            position: relative;
            overflow: hidden;
            animation: fadeIn var(--animation-speed) ease;
        }

        [data-theme="dark"] .metric-card {
            background: #1a1a1a;
            border-color: #333333;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-500), var(--primary-600));
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .metric-icon {
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid var(--primary-200);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.25rem;
        }

        [data-theme="dark"] .metric-icon {
            background: #333333;
            border-color: var(--primary-400);
            color: #e8e8e8;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }


        .metric-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 500;
        }


        .metric-trend {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
        }

        .trend-up {
            color: var(--success-600);
            background: var(--success-50);
        }

        .trend-down {
            color: var(--danger-600);
            background: var(--danger-50);
        }

        [data-theme="dark"] .trend-up {
            color: var(--success-400);
            background: rgba(74, 222, 128, 0.1);
        }

        [data-theme="dark"] .trend-down {
            color: var(--danger-400);
            background: rgba(248, 113, 113, 0.1);
        }

        /* Chart Container */
        .chart-container {
            background: var(--gray-50);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 2rem;
            min-height: 300px;
            position: relative;
            border: 1px solid var(--gray-200);
        }

        [data-theme="dark"] .chart-container {
            background: #1a1a1a;
            border-color: #333333;
        }

        .chart-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 250px;
            color: var(--gray-400);
            font-size: 0.875rem;
        }

        /* Gantt Chart Styles */
        .gantt-container {
            width: 100%;
            overflow-x: auto;
            overflow-y: auto;
            max-height: 500px;
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
        }

        [data-theme="dark"] .gantt-container {
            background: #000000;
        }

        .gantt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--gray-200);
        }

        [data-theme="dark"] .gantt-header {
            border-bottom-color: #333333;
        }

        .gantt-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--gray-900);
        }


        .gantt-legend {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .gantt-chart {
            position: relative;
            min-width: 800px;
        }

        .gantt-timeline-header {
            display: flex;
            height: 40px;
            border-bottom: 2px solid var(--gray-300);
            margin-left: 250px;
            background: var(--gray-100);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        [data-theme="dark"] .gantt-timeline-header {
            background: var(--gray-700);
            border-bottom-color: var(--gray-600);
        }

        .timeline-month {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid var(--gray-300);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-700);
            min-width: 120px;
        }

        [data-theme="dark"] .timeline-month {
            border-right-color: var(--gray-600);
            color: var(--gray-300);
        }

        .gantt-rows {
            position: relative;
        }

        .gantt-row {
            display: flex;
            min-height: 36px;
            border-bottom: 1px solid var(--gray-200);
            position: relative;
            transition: background var(--transition-speed);
        }

        [data-theme="dark"] .gantt-row {
            border-bottom-color: var(--gray-700);
        }

        .gantt-row:hover {
            background: var(--primary-50);
        }

        [data-theme="dark"] .gantt-row:hover {
            background: rgba(56, 189, 248, 0.1);
        }

        .gantt-row.phase-header {
            background: linear-gradient(90deg, var(--gray-800) 250px, var(--gray-100) 250px);
            color: white;
            font-weight: 700;
            min-height: 40px;
        }

        [data-theme="dark"] .gantt-row.phase-header {
            background: linear-gradient(90deg, var(--gray-900) 250px, var(--gray-700) 250px);
        }

        .gantt-task-name {
            width: 250px;
            padding: 0.5rem;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            border-right: 2px solid var(--gray-300);
            background: white;
            position: sticky;
            left: 0;
            z-index: 5;
        }

        [data-theme="dark"] .gantt-task-name {
            background: var(--gray-800);
            border-right-color: var(--gray-600);
        }

        .phase-header .gantt-task-name {
            background: var(--gray-800);
            color: white;
            font-weight: 700;
        }

        [data-theme="dark"] .phase-header .gantt-task-name {
            background: var(--gray-900);
        }

        .gantt-task-bar-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            padding: 0.25rem 0;
        }

        .gantt-task-bar {
            position: absolute;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 0.5rem;
            font-size: 0.625rem;
            color: white;
            font-weight: 600;
            transition: all var(--transition-speed);
            cursor: pointer;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .gantt-task-bar:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
            z-index: 2;
        }

        .gantt-task-bar.completed {
            background: linear-gradient(90deg, var(--success-500), var(--success-600));
        }

        .gantt-task-bar.in-progress {
            background: linear-gradient(90deg, var(--primary-500), var(--primary-600));
        }

        .gantt-task-bar.not-started {
            background: linear-gradient(90deg, var(--gray-400), var(--gray-500));
        }

        .gantt-task-bar.overdue {
            background: linear-gradient(90deg, var(--danger-500), var(--danger-600));
            animation: pulseOverdue 2s infinite;
        }

        @keyframes pulseOverdue {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .gantt-task-progress {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px 0 0 4px;
            transition: width 500ms ease;
        }

        .gantt-task-label {
            position: relative;
            z-index: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .gantt-grid-lines {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 250px;
            right: 0;
            pointer-events: none;
            z-index: 0;
        }

        .grid-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 1px;
            background: var(--gray-200);
        }

        [data-theme="dark"] .grid-line {
            background: var(--gray-700);
        }

        .grid-line.today {
            background: var(--danger-500);
            width: 2px;
            z-index: 3;
        }

        .grid-line.today::before {
            content: 'TODAY';
            position: absolute;
            top: -20px;
            left: -20px;
            font-size: 0.625rem;
            font-weight: 700;
            color: var(--danger-500);
            background: white;
            padding: 0.125rem 0.25rem;
            border-radius: 2px;
        }

        [data-theme="dark"] .grid-line.today::before {
            background: var(--gray-800);
        }

        [data-theme="dark"] .gantt-tooltip {
            background: #1a1a1a;
            color: #e8e8e8;
            border: 1px solid #333333;
        }

        .gantt-tooltip {
            position: absolute;
            background: var(--gray-900);
            color: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            pointer-events: none;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            max-width: 300px;
        }

        .gantt-tooltip.active {
            display: block;
        }

        .tooltip-title {
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .tooltip-info {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
        }

        /* Projects Grid */
        .projects-section {
            margin-top: 2rem;
            animation: fadeIn var(--animation-speed) ease 0.3s both;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .project-count {
            background: var(--primary-100);
            color: var(--primary-700);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        [data-theme="dark"] .project-count {
            background: rgba(56, 189, 248, 0.2);
            color: var(--primary-400);
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 1.5rem;
        }

        /* Project Card */
        .project-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all var(--transition-speed);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--gray-200);
            animation: fadeIn var(--animation-speed) ease;
        }

        [data-theme="dark"] .project-card {
            background: #1a1a1a;
            border-color: #333333;
        }

        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-200);
        }

        [data-theme="dark"] .project-card:hover {
            border-color: var(--primary-600);
        }

        .project-card.loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .project-info {
            flex: 1;
        }

        .project-name {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }


        .project-type {
            display: inline-block;
            background: var(--primary-100);
            color: var(--primary-700);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.688rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        [data-theme="dark"] .project-type {
            background: rgba(56, 189, 248, 0.2);
            color: var(--primary-400);
        }

        .project-type.upgrade {
            background: var(--warning-100);
            color: var(--warning-700);
        }

        [data-theme="dark"] .project-type.upgrade {
            background: rgba(251, 191, 36, 0.2);
            color: var(--warning-400);
        }

        .project-type.break-fix {
            background: var(--danger-100);
            color: var(--danger-700);
        }

        [data-theme="dark"] .project-type.break-fix {
            background: rgba(248, 113, 113, 0.2);
            color: var(--danger-400);
        }

        /* Health Status Light */
        .health-indicator {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .health-indicator.green {
            background: var(--success-500);
            box-shadow: 0 0 12px rgba(34, 197, 94, 0.3);
        }

        .health-indicator.yellow {
            background: var(--warning-500);
            box-shadow: 0 0 12px rgba(245, 158, 11, 0.3);
        }

        .health-indicator.red {
            background: var(--danger-500);
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.3);
        }

        /* Phase Timeline */
        .phase-timeline {
            margin: 1.5rem 0;
            position: relative;
        }

        .timeline-track {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] .timeline-track {
            background: var(--gray-700);
        }

        .timeline-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--success-500), var(--success-600));
            border-radius: 4px;
            transition: width 500ms ease;
            position: relative;
        }

        .phase-indicators {
            display: flex;
            justify-content: space-between;
            margin-top: 0.75rem;
        }

        .phase-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--gray-300);
            position: relative;
            transition: all var(--transition-speed);
        }

        [data-theme="dark"] .phase-dot {
            background: var(--gray-700);
            border-color: var(--gray-600);
        }

        .phase-dot.completed {
            background: var(--success-500);
            border-color: var(--success-600);
        }

        .phase-dot.current {
            background: var(--primary-500);
            border-color: var(--primary-600);
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.2);
        }

        .phase-label {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.625rem;
            font-weight: 600;
            color: var(--gray-600);
            white-space: nowrap;
        }

        /* Progress Ring */
        .progress-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
        }

        .progress-ring-container {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-bg {
            fill: none;
            stroke: var(--gray-200);
            stroke-width: 6;
        }

        [data-theme="dark"] .progress-ring-bg {
            stroke: var(--gray-700);
        }

        .progress-ring-fill {
            fill: none;
            stroke: url(#progress-gradient);
            stroke-width: 6;
            stroke-linecap: round;
            transition: stroke-dasharray 500ms ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--primary-600);
        }

        /* Project Stats */
        .project-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-value {
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--gray-900);
        }


        .stat-label {
            font-size: 0.688rem;
            color: var(--gray-600);
        }


        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        [data-theme="dark"] .quick-actions {
            border-top-color: var(--gray-700);
        }

        .action-btn {
            flex: 1;
            padding: 0.5rem;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-700);
            cursor: pointer;
            transition: all var(--transition-speed);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }

        [data-theme="dark"] .action-btn {
            background: var(--gray-700);
            border-color: var(--gray-600);
            color: var(--gray-300);
        }

        .action-btn:hover {
            background: var(--primary-50);
            border-color: var(--primary-300);
            color: var(--primary-700);
        }

        [data-theme="dark"] .action-btn:hover {
            background: rgba(56, 189, 248, 0.1);
            border-color: var(--primary-600);
            color: var(--primary-400);
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            animation: fadeIn var(--animation-speed);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideDown var(--animation-speed) ease;
        }

        [data-theme="dark"] .modal-content {
            background: #1a1a1a;
        }

        .modal-header {
            padding: 2rem;
            border-bottom: 1px solid var(--gray-200);
        }

        [data-theme="dark"] .modal-header {
            border-bottom-color: #333333;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
        }


        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        [data-theme="dark"] .modal-footer {
            border-top-color: #333333;
        }

        /* Template Selection */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .template-card {
            border: 2px solid var(--gray-200);
            border-radius: 0.75rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all var(--transition-speed);
            text-align: center;
        }

        [data-theme="dark"] .template-card {
            background: #1a1a1a;
            border-color: #333333;
        }

        .template-card:hover {
            border-color: var(--primary-300);
            background: var(--primary-50);
        }

        [data-theme="dark"] .template-card:hover {
            border-color: var(--primary-600);
            background: rgba(56, 189, 248, 0.1);
        }

        .template-card.selected {
            border-color: var(--primary-500);
            background: var(--primary-50);
        }

        [data-theme="dark"] .template-card.selected {
            border-color: var(--primary-500);
            background: rgba(56, 189, 248, 0.15);
        }

        .template-icon {
            width: 60px;
            height: 60px;
            background: white;
            border: 2px solid var(--primary-200);
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
        }

        [data-theme="dark"] .template-icon {
            background: var(--gray-700);
            border-color: var(--primary-600);
        }

        .template-name {
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }


        .template-description {
            font-size: 0.875rem;
            color: var(--gray-600);
        }


        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }


        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all var(--transition-speed);
            background: white;
            color: var(--gray-900);
        }

        [data-theme="dark"] .form-input {
            background: #1a1a1a;
            border-color: #666666;
            color: #e8e8e8;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .form-error {
            color: var(--danger-600);
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        /* ==================== PROJECT TRACKER STYLES ==================== */
        .tracker-page {
            background: var(--gray-50);
            min-height: 100vh;
        }

        .tracker-header {
            background: white;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid var(--gray-200);
        }

        [data-theme="dark"] .tracker-header {
            background: #000000;
            border-bottom-color: #333333;
        }

        .tracker-header-content {
            max-width: 1400px;
            margin: 0 auto;
        }

        .tracker-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .tracker-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .tracker-actions {
            display: flex;
            gap: 0.75rem;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        /* Analytics Section */
        .analytics-section {
            background: white;
            border-radius: 0.75rem;
            padding: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-200);
            margin-bottom: 2rem;
            animation: fadeIn var(--animation-speed);
        }

        [data-theme="dark"] .analytics-section {
            background: #1a1a1a;
            border-color: #333333;
        }

        /* Controls Section */
        .controls-section {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-200);
            margin-bottom: 2rem;
            animation: fadeIn var(--animation-speed) 0.1s both;
        }

        [data-theme="dark"] .controls-section {
            background: #1a1a1a;
            border-color: #333333;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            align-items: end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .enhanced-select {
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            transition: all var(--transition-speed);
            cursor: pointer;
            color: var(--gray-900);
        }

        [data-theme="dark"] .enhanced-select {
            background: #1a1a1a;
            border-color: #666666;
            color: #e8e8e8;
        }

        .enhanced-select:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            min-height: 32px;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-500), #16a34a);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-500), #d97706);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-500), #dc2626);
        }

        /* Table Section */
        .table-section {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--gray-200);
            overflow: hidden;
            animation: fadeIn var(--animation-speed) 0.2s both;
        }

        [data-theme="dark"] .table-section {
            background: #1a1a1a;
            border-color: #333333;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        [data-theme="dark"] .table-header {
            background: #1a1a1a;
            border-bottom-color: #333333;
        }

        .table-container {
            overflow-x: auto;
            max-height: 70vh;
        }

        .enhanced-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .enhanced-table th {
            background: var(--gray-800);
            color: white;
            padding: 0.75rem 0.5rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 100;
            white-space: nowrap;
        }

        [data-theme="dark"] .enhanced-table th {
            background: #1a1a1a;
        }

        .enhanced-table td {
            padding: 0.5rem;
            border-bottom: 1px solid var(--gray-200);
            vertical-align: middle;
            font-size: 0.813rem;
        }

        [data-theme="dark"] .enhanced-table td {
            border-bottom-color: #333333;
        }

        .enhanced-table tr:hover td {
            background: var(--primary-50);
        }

        [data-theme="dark"] .enhanced-table tr:hover td {
            background: rgba(56, 189, 248, 0.05);
        }

        .phase-header {
            background: linear-gradient(135deg, var(--gray-800), var(--gray-900));
            color: white;
            font-weight: 700;
        }

        [data-theme="dark"] .phase-header {
            background: linear-gradient(135deg, var(--gray-200), var(--gray-100));
        }

        .phase-header td {
            padding: 1rem 1.5rem;
            font-size: 1rem;
            border-bottom: 2px solid var(--primary-500);
        }

        .phase-header-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .phase-progress {
            margin-left: auto;
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .task-row {
            position: relative;
            transition: all var(--transition-speed);
        }

        .task-input, .task-textarea {
            width: 100%;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.813rem;
            background: white;
            transition: all var(--transition-speed);
            font-family: inherit;
            color: var(--gray-900);
        }

        [data-theme="dark"] .task-input,
        [data-theme="dark"] .task-textarea {
            background: #1a1a1a;
            border-color: #666666;
            color: #e8e8e8;
        }

        .task-input:focus, .task-textarea:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.1);
        }

        .task-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Priority and Status Selects */
        .priority-select, .status-select {
            border: none;
            border-radius: 1rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.688rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            width: 100%;
            transition: all var(--transition-speed);
        }

        .priority-select.priority-low {
            background-color: var(--gray-100);
            color: var(--gray-700);
        }

        .priority-select.priority-medium {
            background-color: var(--primary-50);
            color: var(--primary-700);
        }

        .priority-select.priority-high {
            background-color: var(--warning-50);
            color: var(--warning-600);
        }

        .priority-select.priority-critical {
            background-color: var(--danger-50);
            color: var(--danger-600);
        }

        .status-select.status-not-started {
            background-color: var(--gray-100);
            color: var(--gray-700);
        }

        .status-select.status-in-progress {
            background-color: var(--primary-50);
            color: var(--primary-700);
        }

        .status-select.status-completed {
            background-color: var(--success-50);
            color: var(--success-600);
        }

        [data-theme="dark"] .priority-select.priority-low {
            background-color: rgba(148, 163, 184, 0.2);
            color: var(--gray-400);
        }

        [data-theme="dark"] .priority-select.priority-medium {
            background-color: rgba(56, 189, 248, 0.2);
            color: var(--primary-400);
        }

        [data-theme="dark"] .priority-select.priority-high {
            background-color: rgba(251, 191, 36, 0.2);
            color: var(--warning-400);
        }

        [data-theme="dark"] .priority-select.priority-critical {
            background-color: rgba(248, 113, 113, 0.2);
            color: var(--danger-400);
        }

        [data-theme="dark"] .status-select.status-not-started {
            background-color: rgba(148, 163, 184, 0.2);
            color: var(--gray-400);
        }

        [data-theme="dark"] .status-select.status-in-progress {
            background-color: rgba(56, 189, 248, 0.2);
            color: var(--primary-400);
        }

        [data-theme="dark"] .status-select.status-completed {
            background-color: rgba(74, 222, 128, 0.2);
            color: var(--success-400);
        }

        /* Health Lights */
        .health-light-container {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 100%;
        }

        .health-light {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            transition: all var(--transition-speed);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .health-light.green {
            background: var(--success-500);
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.3);
        }

        .health-light.yellow {
            background: var(--warning-500);
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.3);
        }

        .health-light.red {
            background: var(--danger-500);
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
        }

        .health-dropdown {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            min-width: 120px;
            overflow: hidden;
            margin-top: 5px;
            animation: fadeIn var(--animation-speed);
        }

        [data-theme="dark"] .health-dropdown {
            background: #1a1a1a;
            border-color: #333333;
        }

        .health-dropdown.active {
            display: block;
        }

        .health-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background var(--transition-speed);
        }

        .health-option:hover {
            background: var(--gray-50);
        }

        [data-theme="dark"] .health-option:hover {
            background: var(--gray-700);
        }

        .health-option-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .health-option-light.green { background: #22c55e; }
        .health-option-light.yellow { background: #f59e0b; }
        .health-option-light.red { background: #ef4444; }

        .task-checkbox {
            width: 18px;
            height: 18px;
            margin: 0 auto;
            display: block;
            cursor: pointer;
            accent-color: var(--primary-500);
        }

        .task-actions {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }

        .delete-task-btn {
            opacity: 0;
            transition: opacity var(--transition-speed);
            background: var(--danger-500);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            line-height: 1;
        }

        .task-row:hover .delete-task-btn {
            opacity: 1;
        }

        .delete-task-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .task-name-cell {
            position: relative;
        }

        .editable-task-name {
            background: transparent;
            border: 1px solid transparent;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: inherit;
            font-weight: inherit;
            width: 100%;
            transition: all var(--transition-speed);
            color: var(--gray-900);
            cursor: text;
        }

        [data-theme="dark"] .editable-task-name {
            color: var(--gray-100);
        }

        .editable-task-name:hover {
            background: rgba(14, 165, 233, 0.05);
            border-color: rgba(14, 165, 233, 0.2);
        }

        .editable-task-name:focus {
            outline: none;
            background: white;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.1);
        }

        [data-theme="dark"] .editable-task-name:focus {
            background: #1a1a1a;
        }

        /* Overdue task styling */
        .task-input.overdue {
            background-color: var(--danger-50);
            border-color: var(--danger-300);
            color: var(--danger-700);
        }

        [data-theme="dark"] .task-input.overdue {
            background-color: rgba(239, 68, 68, 0.1);
            border-color: var(--danger-500);
            color: var(--danger-400);
        }

        /* Column widths */
        .enhanced-table th:nth-child(1),
        .enhanced-table td:nth-child(1) { width: 50px; }
        .enhanced-table th:nth-child(2),
        .enhanced-table td:nth-child(2) { width: 80px; }
        .enhanced-table th:nth-child(3),
        .enhanced-table td:nth-child(3) { width: 280px; min-width: 280px; }
        .enhanced-table th:nth-child(4),
        .enhanced-table td:nth-child(4) { width: 100px; }
        .enhanced-table th:nth-child(5),
        .enhanced-table td:nth-child(5) { width: 80px; }
        .enhanced-table th:nth-child(6),
        .enhanced-table td:nth-child(6) { width: 90px; }
        .enhanced-table th:nth-child(7),
        .enhanced-table td:nth-child(7) { width: 50px; }
        .enhanced-table th:nth-child(8),
        .enhanced-table td:nth-child(8) { width: 90px; }
        .enhanced-table th:nth-child(9),
        .enhanced-table td:nth-child(9) { width: 90px; }
        .enhanced-table th:nth-child(10),
        .enhanced-table td:nth-child(10) { width: 350px; min-width: 350px; }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--gray-200);
            border-top-color: var(--primary-500);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Error and Success Messages */
        .error-message {
            background: var(--danger-50);
            border: 1px solid var(--danger-200);
            color: var(--danger-700);
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            font-size: 0.875rem;
        }

        .success-message {
            background: var(--success-50);
            border: 1px solid var(--success-200);
            color: var(--success-700);
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            font-size: 0.875rem;
        }

        /* Drag and Drop */
        .draggable {
            cursor: move;
        }

        .dragging {
            opacity: 0.5;
        }

        .drag-over {
            background: var(--primary-50);
        }

        /* Hidden elements */
        .hidden {
            display: none !important;
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
                color: black;
            }

            .app-navigation,
            .nav-actions,
            .header-actions,
            .controls-bar,
            .action-buttons,
            .quick-actions,
            .delete-task-btn,
            .theme-toggle {
                display: none !important;
            }

            .page-container {
                padding-top: 0;
            }

            .project-card,
            .analytics-dashboard,
            .table-section {
                box-shadow: none;
                border: 1px solid #ccc;
                page-break-inside: avoid;
            }

            .enhanced-table {
                font-size: 10pt;
            }

            .enhanced-table th {
                background: #f0f0f0;
                color: black;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .projects-grid {
                grid-template-columns: 1fr;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
                align-items: stretch;
            }

            .nav-content {
                flex-direction: column;
                gap: 1rem;
            }

            .gantt-container {
                font-size: 0.75rem;
            }

            .gantt-task-name {
                width: 150px;
            }

            .gantt-timeline-header {
                margin-left: 150px;
            }
        }

        /* Keyboard focus indicators */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: 2px solid var(--primary-500);
            outline-offset: 2px;
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Selection colors */
        ::selection {
            background: var(--primary-200);
            color: var(--gray-900);
        }

        [data-theme="dark"] ::selection {
            background: var(--primary-700);
            color: var(--gray-100);
        }

        /* Visual Reports Styles */

        .report-card {
            transition: all 0.3s ease;
        }

        .report-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: var(--blue-500) !important;
        }

        .executive-kpi {
            position: relative;
            overflow: hidden;
        }

        .executive-kpi::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--blue-500), var(--blue-600));
        }

        .metric-trend {
            font-size: 0.75rem;
            margin-top: 0.5rem;
            font-weight: 600;
        }

        .metric-trend.positive {
            color: var(--green-600);
        }

        .metric-trend.negative {
            color: var(--red-600);
        }

        .metric-trend.neutral {
            color: var(--gray-600);
        }

        .btn.small {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        .btn.small.selected {
            background: var(--blue-600);
            color: white;
            border-color: var(--blue-600);
        }

        .chart-container {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .health-indicator {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .progress-bar-mini {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin: 0.25rem 0;
        }

        .progress-fill-mini {
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-fill-mini.green {
            background: var(--green-500);
        }

        .progress-fill-mini.yellow {
            background: var(--yellow-500);
        }

        .progress-fill-mini.red {
            background: var(--red-500);
        }

        .project-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background: white;
            margin-bottom: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .project-item.performing {
            border-left: 4px solid var(--green-500);
        }

        .project-item.at-risk {
            border-left: 4px solid var(--red-500);
        }

        .project-name {
            font-weight: 600;
            color: var(--gray-900);
        }

        .project-progress {
            font-size: 0.875rem;
            color: var(--gray-600);
        }
    </style>
</head>

<body>
    <!-- Global Navigation -->
    <nav class="app-navigation">
        <div class="nav-content">
            <div class="nav-brand">
                <div class="nav-logo">AV</div>
                <div class="nav-title">AV Project Management Tool</div>
                <div class="nav-status">
                    <span class="status-indicator" id="connectionStatus"></span>
                    <span id="connectionText">Connecting...</span>
                </div>
            </div>
            <div class="nav-actions">
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                    <span id="themeIcon"></span>
                </button>
                <button class="nav-btn secondary" onclick="navigateToDashboard()" id="dashboardBtn">
                     Dashboard
                </button>
                <button class="nav-btn secondary" onclick="createBackup()" title="Backup data">
                     Backup
                </button>
                <label class="nav-btn secondary" style="margin: 0;">
                     Import
                    <input type="file" accept=".json" onchange="handleImport(event)" style="display: none;">
                </label>
                <button class="nav-btn secondary" onclick="showExecutiveReporting()" title="Executive Reports & Analytics">
                     Reports
                </button>
                <button class="nav-btn" onclick="showCreateProjectModal()">
                     New Project
                </button>
            </div>
        </div>
    </nav>

    <!-- Landing Page / Dashboard -->
    <div class="page-container landing-page active" id="landingPage">
        <div class="landing-container">
            <!-- Header -->
            <header class="landing-header">
                <div class="header-content">
                    <div class="logo-section">
                        <div class="logo">AV</div>
                        <div>
                            <h1 class="app-title">AV Project Management Hub</h1>
                            <div class="subtitle">Executive Dashboard - All Projects Overview</div>
                        </div>
                    </div>
                    
                    <div class="header-actions">
                        <button class="btn" onclick="showCreateProjectModal()">
                            <span class="btn-icon"></span>
                            Create New Project
                        </button>
                        <button class="btn btn-secondary" onclick="exportAllProjects()">
                            <span class="btn-icon"></span>
                            Export All
                        </button>
                        <button class="btn btn-secondary" onclick="window.print()">
                            <span class="btn-icon"></span>
                            Print Report
                        </button>
                    </div>
                </div>
            </header>

            <!-- Search and Filter Bar -->
            <div class="controls-bar">
                <div class="search-box">
                    <span class="search-icon"></span>
                    <input 
                        type="text" 
                        class="search-input" 
                        placeholder="Search projects by name..."
                        id="searchInput"
                    >
                </div>
                
                <select class="filter-select" id="typeFilter" onchange="filterProjects()">
                    <option value="all">All Types</option>
                    <option value="new-build">New Build</option>
                    <option value="upgrade">Upgrade</option>
                    <option value="break-fix">Break Fix</option>
                </select>
                
                <select class="filter-select" id="statusFilter" onchange="filterProjects()">
                    <option value="active">Active Projects</option>
                    <option value="all">All Projects</option>
                    <option value="at-risk">At Risk</option>
                    <option value="on-track">On Track</option>
                    <option value="completed">Completed</option>
                </select>
                
                <select class="filter-select" id="phaseFilterDashboard" onchange="filterProjects()">
                    <option value="all">All Phases</option>
                    <option value="1">Phase 1: Logistics</option>
                    <option value="2">Phase 2: AV Setup</option>
                    <option value="3">Phase 3: Installation</option>
                    <option value="4">Phase 4: Testing</option>
                    <option value="5">Phase 5: Closeout</option>
                </select>
            </div>

            <!-- Analytics Dashboard -->
            <div class="analytics-dashboard" id="analyticsDashboard">
                <div class="dashboard-header">
                    <div>
                        <h2 class="dashboard-title">Executive Dashboard</h2>
                        <div class="dashboard-subtitle" id="dashboardSubtitle">Click on any project card below to view its interactive Gantt chart</div>
                    </div>
                    <button class="btn btn-secondary" onclick="refreshDashboard()">
                        <span class="loading" style="display: none;"></span>
                        <span> Refresh</span>
                    </button>
                </div>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-icon"></div>
                        <div class="metric-value" id="totalProjects">0</div>
                        <div class="metric-label">Total Projects</div>
                        <div class="metric-trend trend-up"> 3 this month</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-icon"></div>
                        <div class="metric-value" id="completionRate">0%</div>
                        <div class="metric-label">Avg Completion</div>
                        <div class="metric-trend trend-up"> 5% from last week</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-icon"></div>
                        <div class="metric-value" id="atRiskCount">0</div>
                        <div class="metric-label">At Risk</div>
                        <div class="metric-trend trend-down"> 1 resolved</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-icon"></div>
                        <div class="metric-value" id="activeProjects">0</div>
                        <div class="metric-label">Active Projects</div>
                        <div class="metric-trend trend-up"> On schedule</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-icon"></div>
                        <div class="metric-value" id="dueSoon">0</div>
                        <div class="metric-label">Due This Week</div>
                        <div class="metric-trend trend-up"> Attention needed</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-icon"></div>
                        <div class="metric-value" id="teamUtilization">0%</div>
                        <div class="metric-label">Team Utilization</div>
                        <div class="metric-trend trend-up"> High capacity</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-placeholder">
                        <div> Interactive Gantt chart will appear here when a project is selected</div>
                    </div>
                </div>
            </div>

            <!-- Projects Grid -->
            <div class="projects-section">
                <div class="section-header">
                    <h2 class="section-title">Active Projects</h2>
                    <div class="project-count" id="projectCount">0 projects</div>
                </div>
                
                <div class="projects-grid" id="projectsGrid">
                    <!-- Projects will be dynamically loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Project Tracker Page -->
    <div class="page-container tracker-page" id="trackerPage">
        <!-- Tracker Header -->
        <header class="tracker-header">
            <div class="tracker-header-content">
                <div class="tracker-header-top">
                    <div>
                        <h1 class="tracker-title" id="trackerTitle">Project Tracker</h1>
                    </div>
                    
                    <div class="tracker-actions">
                        <button class="btn btn-success" onclick="saveProject()" id="saveProjectBtn">
                             Save Project
                        </button>
                        <button class="btn btn-secondary" onclick="exportProject()">
                             Export
                        </button>
                        <button class="btn btn-secondary" onclick="window.print()">
                             Print
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Dashboard -->
        <main class="dashboard">
            <!-- Analytics Section -->
            <section class="analytics-section">
                <h2 class="section-title"> Project Analytics Dashboard</h2>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="overallProgress">0%</div>
                        <div class="metric-label">Overall Progress</div>
                        <div class="metric-trend trend-up">
                            <span></span> On track
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-value" id="phase1Progress">0%</div>
                        <div class="metric-label">Phase 1: Logistics</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-value" id="phase2Progress">0%</div>
                        <div class="metric-label">Phase 2: AV Setup</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-value" id="phase3Progress">0%</div>
                        <div class="metric-label">Phase 3: Installation</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-value" id="phase4Progress">0%</div>
                        <div class="metric-label">Phase 4: Testing</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-value" id="phase5Progress">0%</div>
                        <div class="metric-label">Phase 5: Closeout</div>
                    </div>
                </div>
            </section>

            <!-- Controls Section -->
            <section class="controls-section">
                <div class="controls-grid">
                    <div class="control-group">
                        <label class="control-label">View Filter</label>
                        <select class="enhanced-select" id="viewFilter" onchange="filterTrackerTasks()">
                            <option value="all">All Tasks</option>
                            <option value="incomplete">Incomplete Only</option>
                            <option value="complete">Complete Only</option>
                            <option value="overdue">Overdue Tasks</option>
                            <option value="critical">Critical Priority</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">Phase Filter</label>
                        <select class="enhanced-select" id="phaseFilter" onchange="filterTrackerTasks()">
                            <option value="all">All Phases</option>
                            <option value="1">Phase 1: Logistics</option>
                            <option value="2">Phase 2: AV Setup</option>
                            <option value="3">Phase 3: Installation</option>
                            <option value="4">Phase 4: Testing</option>
                            <option value="5">Phase 5: Closeout</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">Quick Actions</label>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="addTask()">
                                 Add Task
                            </button>
                            <button class="btn btn-secondary" onclick="exportToExcel()">
                                 Export Excel
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Task Table -->
            <section class="table-section">
                <div class="table-header">
                    <h2 class="section-title"> Project Tasks</h2>
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="addTask()">
                             Add Task
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="enhanced-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Actions</th>
                                <th>Task Name</th>
                                <th>Owner</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Health</th>
                                <th>Start</th>
                                <th>Due</th>
                                <th>Notes / Details</th>
                            </tr>
                        </thead>
                        <tbody id="taskTableBody">
                            <!-- Tasks will be dynamically loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Create Project Modal -->
    <div class="modal" id="createProjectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Project</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select Project Template</label>
                    <div class="template-grid">
                        <div class="template-card selected" onclick="selectTemplate(this, 'new-build')">
                            <div class="template-icon"></div>
                            <div class="template-name">New AV Build</div>
                            <div class="template-description">Complete installation from scratch</div>
                        </div>
                        <div class="template-card" onclick="selectTemplate(this, 'upgrade')">
                            <div class="template-icon"></div>
                            <div class="template-name">AV Upgrade</div>
                            <div class="template-description">Upgrade existing AV systems</div>
                        </div>
                        <div class="template-card" onclick="selectTemplate(this, 'break-fix')">
                            <div class="template-icon"></div>
                            <div class="template-name">Break Fix</div>
                            <div class="template-description">Repair and troubleshooting</div>
                        </div>
                        <div class="template-card" onclick="selectTemplate(this, 'blank')">
                            <div class="template-icon"></div>
                            <div class="template-name">Blank Project</div>
                            <div class="template-description">Start from scratch</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Project Name *</label>
                    <input type="text" class="form-input" id="newProjectName" placeholder="Enter project name">
                    <div class="form-error" id="projectNameError" style="display: none;"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Project Manager *</label>
                    <input type="text" class="form-input" id="newProjectManager" placeholder="Enter project manager name">
                    <div class="form-error" id="projectManagerError" style="display: none;"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Site/Location</label>
                    <input type="text" class="form-input" id="newProjectLocation" placeholder="Enter site location">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Target Completion Date *</label>
                    <input type="date" class="form-input" id="newProjectDate">
                    <div class="form-error" id="projectDateError" style="display: none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn" onclick="createProject()" id="createProjectBtn">Create Project</button>
            </div>
        </div>
    </div>

    <!-- Visual Reports Landing Modal -->
    <div class="modal" id="executiveReportingModal">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
            <!-- Reports Landing Page -->
            <div id="reportsLandingPage">
                <div class="modal-header">
                    <h2 class="modal-title"> AV Team Reports & Analytics</h2>
                    <p style="color: var(--gray-600); margin-top: 0.5rem;">Visual insights and data-driven reports for organizational visibility</p>
                </div>
                <div class="modal-body">
                    <!-- Report Types Grid -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; color: var(--gray-900);"> Available Reports</h3>
                        <div class="template-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                            <div class="template-card report-card" onclick="showVisualReport('executive-summary')" style="cursor: pointer; border: 2px solid #e2e8f0;">
                                <div class="template-icon"></div>
                                <div class="template-name">Executive Summary</div>
                                <div class="template-description">High-level KPIs and portfolio overview</div>
                                <div style="margin-top: 1rem; font-size: 0.875rem; color: var(--blue-600); font-weight: 600;">View Interactive Report </div>
                            </div>
                            <div class="template-card report-card" onclick="showVisualReport('portfolio-analysis')" style="cursor: pointer; border: 2px solid #e2e8f0;">
                                <div class="template-icon"></div>
                                <div class="template-name">Portfolio Analysis</div>
                                <div class="template-description">Cross-project insights and trends</div>
                                <div style="margin-top: 1rem; font-size: 0.875rem; color: var(--blue-600); font-weight: 600;">View Interactive Report </div>
                            </div>
                            <div class="template-card report-card" onclick="showVisualReport('resource-utilization')" style="cursor: pointer; border: 2px solid #e2e8f0;">
                                <div class="template-icon"></div>
                                <div class="template-name">Resource Utilization</div>
                                <div class="template-description">Team capacity and workload analysis</div>
                                <div style="margin-top: 1rem; font-size: 0.875rem; color: var(--blue-600); font-weight: 600;">View Interactive Report </div>
                            </div>
                            <div class="template-card report-card" onclick="showVisualReport('risk-assessment')" style="cursor: pointer; border: 2px solid #e2e8f0;">
                                <div class="template-icon"></div>
                                <div class="template-name">Risk Assessment</div>
                                <div class="template-description">Project risks and bottlenecks</div>
                                <div style="margin-top: 1rem; font-size: 0.875rem; color: var(--blue-600); font-weight: 600;">View Interactive Report </div>
                            </div>
                            <div class="template-card report-card" onclick="showVisualReport('trend-analysis')" style="cursor: pointer; border: 2px solid #e2e8f0;">
                                <div class="template-icon"></div>
                                <div class="template-name">Trend Analysis</div>
                                <div class="template-description">Performance trends over time</div>
                                <div style="margin-top: 1rem; font-size: 0.875rem; color: var(--blue-600); font-weight: 600;">View Interactive Report </div>
                            </div>
                            <div class="template-card report-card" onclick="showVisualReport('project-details')" style="cursor: pointer; border: 2px solid #e2e8f0;">
                                <div class="template-icon"></div>
                                <div class="template-name">Project Details</div>
                                <div class="template-description">Detailed project breakdowns</div>
                                <div style="margin-top: 1rem; font-size: 0.875rem; color: var(--blue-600); font-weight: 600;">View Interactive Report </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Metrics Preview -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; color: var(--gray-900);"> Portfolio Overview</h3>
                        <div class="metrics-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                            <div class="metric-card">
                                <div class="metric-value" id="quickTotalProjects">0</div>
                                <div class="metric-label">Total Projects</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="quickActiveProjects">0</div>
                                <div class="metric-label">Active Projects</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="quickOverallProgress">0%</div>
                                <div class="metric-label">Portfolio Progress</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="quickTotalTasks">0</div>
                                <div class="metric-label">Total Tasks</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="quickCompletedTasks">0</div>
                                <div class="metric-label">Completed Tasks</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="quickAtRiskProjects">0</div>
                                <div class="metric-label">Projects At Risk</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                </div>
            </div>

            <!-- Individual Visual Report Pages (hidden by default) -->
            
            <!-- Executive Summary Visual Report -->
            <div id="executiveSummaryReport" style="display: none;">
                <div class="modal-header">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="backToReportsLanding()" style="padding: 0.5rem;"> Back</button>
                        <div>
                            <h2 class="modal-title"> Executive Summary Report</h2>
                            <p style="color: var(--gray-600); margin: 0;">High-level portfolio KPIs and performance metrics</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="refreshVisualReport('executive-summary')"> Refresh</button>
                        <button class="btn" onclick="exportCurrentReport()"> Export Data</button>
                    </div>
                </div>
                <div class="modal-body">
                    <!-- Time Period Selection -->
                    <div style="margin-bottom: 2rem; padding: 1rem; background: var(--gray-50); border-radius: 0.5rem;">
                        <h4 style="margin-bottom: 1rem;"> Reporting Period</h4>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                            <button class="btn btn-secondary small selected" onclick="selectTimePeriod(this, 'current-month')" data-period="current-month">This Month</button>
                            <button class="btn btn-secondary small" onclick="selectTimePeriod(this, 'last-month')" data-period="last-month">Last Month</button>
                            <button class="btn btn-secondary small" onclick="selectTimePeriod(this, 'current-quarter')" data-period="current-quarter">This Quarter</button>
                            <button class="btn btn-secondary small" onclick="selectTimePeriod(this, 'last-quarter')" data-period="last-quarter">Last Quarter</button>
                            <button class="btn btn-secondary small" onclick="selectTimePeriod(this, 'current-year')" data-period="current-year">This Year</button>
                            <button class="btn btn-secondary small" onclick="selectTimePeriod(this, 'custom')" data-period="custom">Custom Range</button>
                        </div>
                        <div id="customDateRangeReport" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <input type="date" id="reportStartDateVisual" class="form-input" onchange="updateVisualReport()">
                                <input type="date" id="reportEndDateVisual" class="form-input" onchange="updateVisualReport()">
                            </div>
                        </div>
                        <div id="periodDescription" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--gray-600);"></div>
                    </div>

                    <!-- Executive KPI Dashboard -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem;"> Key Performance Indicators</h4>
                        <div class="metrics-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                            <div class="metric-card executive-kpi">
                                <div class="metric-value" id="execTotalProjects">0</div>
                                <div class="metric-label">Active Projects</div>
                                <div class="metric-trend" id="execProjectsTrend"></div>
                            </div>
                            <div class="metric-card executive-kpi">
                                <div class="metric-value" id="execPortfolioProgress">0%</div>
                                <div class="metric-label">Portfolio Progress</div>
                                <div class="metric-trend" id="execProgressTrend"></div>
                            </div>
                            <div class="metric-card executive-kpi">
                                <div class="metric-value" id="execOnTimeDelivery">0%</div>
                                <div class="metric-label">On-Time Delivery</div>
                                <div class="metric-trend" id="execDeliveryTrend"></div>
                            </div>
                            <div class="metric-card executive-kpi">
                                <div class="metric-value" id="execResourceUtil">0%</div>
                                <div class="metric-label">Resource Utilization</div>
                                <div class="metric-trend" id="execResourceTrend"></div>
                            </div>
                            <div class="metric-card executive-kpi">
                                <div class="metric-value" id="execCriticalRisks">0</div>
                                <div class="metric-label">Critical Issues</div>
                                <div class="metric-trend" id="execRisksTrend"></div>
                            </div>
                            <div class="metric-card executive-kpi">
                                <div class="metric-value" id="execAvgVelocity">0</div>
                                <div class="metric-label">Avg Velocity (tasks/week)</div>
                                <div class="metric-trend" id="execVelocityTrend"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Project Health Overview -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem;"> Project Health Status</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <div class="chart-container">
                                <h5 style="margin-bottom: 1rem;">Health Distribution</h5>
                                <div id="healthChart" style="height: 200px; display: flex; align-items: center; justify-content: center; background: var(--gray-50); border-radius: 0.5rem;">
                                    <div style="text-align: center;">
                                        <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 1rem;">
                                            <div class="health-indicator" style="display: flex; align-items: center; gap: 0.5rem;">
                                                <div style="width: 1rem; height: 1rem; background: #22c55e; border-radius: 50%;"></div>
                                                <span id="greenProjects">0</span> On Track
                                            </div>
                                            <div class="health-indicator" style="display: flex; align-items: center; gap: 0.5rem;">
                                                <div style="width: 1rem; height: 1rem; background: #f59e0b; border-radius: 50%;"></div>
                                                <span id="yellowProjects">0</span> At Risk
                                            </div>
                                            <div class="health-indicator" style="display: flex; align-items: center; gap: 0.5rem;">
                                                <div style="width: 1rem; height: 1rem; background: #ef4444; border-radius: 50%;"></div>
                                                <span id="redProjects">0</span> Critical
                                            </div>
                                        </div>
                                        <div id="healthProgressBars"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-container">
                                <h5 style="margin-bottom: 1rem;">Risk Assessment</h5>
                                <div id="riskChart" style="height: 200px; display: flex; align-items: center; justify-content: center; background: var(--gray-50); border-radius: 0.5rem;">
                                    <div style="text-align: center;">
                                        <div id="riskSummary" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Top Performing & At-Risk Projects -->
                    <div style="margin-bottom: 2rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div>
                                <h4 style="margin-bottom: 1rem; color: #22c55e;"> Top Performing Projects</h4>
                                <div id="topPerformingProjects" style="background: var(--gray-50); border-radius: 0.5rem; padding: 1rem;"></div>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 1rem; color: #ef4444;"> Projects Needing Attention</h4>
                                <div id="atRiskProjects" style="background: var(--gray-50); border-radius: 0.5rem; padding: 1rem;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Portfolio Analysis Visual Report -->
            <div id="portfolioAnalysisReport" style="display: none;">
                <div class="modal-header">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="backToReportsLanding()" style="padding: 0.5rem;"> Back</button>
                        <div>
                            <h2 class="modal-title"> Portfolio Analysis Report</h2>
                            <p style="color: var(--gray-600); margin: 0;">Project comparison, prioritization, and resource allocation insights</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="refreshVisualReport('portfolio-analysis')"> Refresh</button>
                        <button class="btn" onclick="exportCurrentReport()"> Export Data</button>
                    </div>
                </div>
                <div class="modal-body">
                    <!-- Portfolio Comparison Matrix -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem;"> Project Priority Matrix</h4>
                        <div id="portfolioMatrix" style="background: var(--gray-50); border-radius: 0.5rem; padding: 1.5rem; height: 400px; position: relative;"></div>
                    </div>

                    <!-- Resource Allocation Overview -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem;"> Resource Distribution</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div class="chart-container">
                                <h5>Projects by Type</h5>
                                <div id="projectTypeChart"></div>
                            </div>
                            <div class="chart-container">
                                <h5>Task Distribution</h5>
                                <div id="taskDistributionChart"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Comparative Performance Table -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem;"> Project Performance Comparison</h4>
                        <div style="background: white; border-radius: 0.5rem; overflow: hidden;">
                            <table id="portfolioComparisonTable" style="width: 100%; border-collapse: collapse;">
                                <thead style="background: var(--gray-100);">
                                    <tr>
                                        <th style="padding: 1rem; text-align: left; cursor: pointer;" onclick="sortPortfolioTable('name')">Project Name </th>
                                        <th style="padding: 1rem; text-align: left; cursor: pointer;" onclick="sortPortfolioTable('progress')">Progress </th>
                                        <th style="padding: 1rem; text-align: left; cursor: pointer;" onclick="sortPortfolioTable('velocity')">Velocity </th>
                                        <th style="padding: 1rem; text-align: left; cursor: pointer;" onclick="sortPortfolioTable('efficiency')">Efficiency </th>
                                        <th style="padding: 1rem; text-align: left; cursor: pointer;" onclick="sortPortfolioTable('priority')">Priority </th>
                                        <th style="padding: 1rem; text-align: left;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="portfolioTableBody">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resource Utilization Visual Report -->
            <div id="resourceUtilizationReport" style="display: none;">
                <div class="modal-header">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="backToReportsLanding()" style="padding: 0.5rem;"> Back</button>
                        <div>
                            <h2 class="modal-title"> Resource Utilization Report</h2>
                            <p style="color: var(--gray-600); margin: 0;">Team capacity, workload distribution, and bottleneck analysis</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="refreshVisualReport('resource-utilization')"> Refresh</button>
                        <button class="btn" onclick="exportCurrentReport()"> Export Data</button>
                    </div>
                </div>
                <div class="modal-body">
                    <!-- Team Workload Overview -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem;"> Team Workload Distribution</h4>
                        <div id="teamWorkloadChart" style="background: var(--gray-50); border-radius: 0.5rem; padding: 1.5rem; min-height: 300px;"></div>
                    </div>

                    <!-- Capacity Analysis -->
                    <div style="margin-bottom: 2rem;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                            <div class="chart-container">
                                <h5>Capacity Utilization</h5>
                                <div id="capacityChart"></div>
                            </div>
                            <div class="chart-container">
                                <h5>Skill Distribution</h5>
                                <div id="skillDistributionChart"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Individual Team Member Details -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem;"> Individual Performance</h4>
                        <div id="teamMemberDetails" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;"></div>
                    </div>
                </div>
            </div>

            <!-- Risk Assessment Visual Report -->
            <div id="riskAssessmentReport" style="display: none;">
                <div class="modal-header">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="backToReportsLanding()" style="padding: 0.5rem;"> Back</button>
                        <div>
                            <h2 class="modal-title"> Risk Assessment Report</h2>
                            <p style="color: var(--gray-600); margin: 0;">Risk identification, impact analysis, and mitigation planning</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="refreshVisualReport('risk-assessment')"> Refresh</button>
                        <button class="btn" onclick="exportCurrentReport()"> Export Data</button>
                    </div>
                </div>
                <div class="modal-body">
                    <!-- Risk Heat Map -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem;"> Risk Heat Map</h4>
                        <div id="riskHeatMap" style="background: var(--gray-50); border-radius: 0.5rem; padding: 1.5rem; height: 300px; position: relative;"></div>
                    </div>

                    <!-- Critical Issues -->
                    <div style="margin-bottom: 2rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div>
                                <h4 style="margin-bottom: 1rem; color: var(--red-600);"> Critical Issues</h4>
                                <div id="criticalIssues" style="background: var(--gray-50); border-radius: 0.5rem; padding: 1rem;"></div>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 1rem; color: var(--yellow-600);"> Emerging Risks</h4>
                                <div id="emergingRisks" style="background: var(--gray-50); border-radius: 0.5rem; padding: 1rem;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Mitigation Actions -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem;"> Recommended Actions</h4>
                        <div id="riskActions" style="background: white; border-radius: 0.5rem; padding: 1.5rem;"></div>
                    </div>
                </div>
            </div>

            <!-- Trend Analysis Visual Report -->
            <div id="trendAnalysisReport" style="display: none;">
                <div class="modal-header">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="backToReportsLanding()" style="padding: 0.5rem;"> Back</button>
                        <div>
                            <h2 class="modal-title"> Trend Analysis Report</h2>
                            <p style="color: var(--gray-600); margin: 0;">Performance trends, forecasting, and historical insights</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="refreshVisualReport('trend-analysis')"> Refresh</button>
                        <button class="btn" onclick="exportCurrentReport()"> Export Data</button>
                    </div>
                </div>
                <div class="modal-body">
                    <!-- Trend Charts -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem;"> Performance Trends</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div class="chart-container">
                                <h5>Portfolio Progress Over Time</h5>
                                <div id="progressTrendChart" style="height: 200px;"></div>
                            </div>
                            <div class="chart-container">
                                <h5>Task Completion Velocity</h5>
                                <div id="velocityTrendChart" style="height: 200px;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Forecasting -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem;"> Forecasting</h4>
                        <div id="forecastingSection" style="background: var(--gray-50); border-radius: 0.5rem; padding: 1.5rem;"></div>
                    </div>

                    <!-- Historical Insights -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem;"> Historical Insights</h4>
                        <div id="historicalInsights" style="background: white; border-radius: 0.5rem; padding: 1.5rem;"></div>
                    </div>
                </div>
            </div>

            <!-- Project Details Visual Report -->
            <div id="projectDetailsReport" style="display: none;">
                <div class="modal-header">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="backToReportsLanding()" style="padding: 0.5rem;"> Back</button>
                        <div>
                            <h2 class="modal-title"> Project Details Report</h2>
                            <p style="color: var(--gray-600); margin: 0;">Deep-dive analysis and detailed project breakdowns</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="refreshVisualReport('project-details')"> Refresh</button>
                        <button class="btn" onclick="exportCurrentReport()"> Export Data</button>
                    </div>
                </div>
                <div class="modal-body">
                    <!-- Project Selector -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem;"> Select Project for Analysis</h4>
                        <select id="projectSelector" class="form-input" onchange="loadProjectDetails(this.value)" style="width: 100%; max-width: 400px;">
                            <option value="">Select a project...</option>
                        </select>
                    </div>

                    <!-- Selected Project Analysis -->
                    <div id="selectedProjectAnalysis" style="display: none;">
                        <!-- Project Overview -->
                        <div style="margin-bottom: 2rem;">
                            <h4 style="margin-bottom: 1rem;"> Project Overview</h4>
                            <div id="projectOverviewCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;"></div>
                        </div>

                        <!-- Task Timeline -->
                        <div style="margin-bottom: 2rem;">
                            <h4 style="margin-bottom: 1rem;"> Task Timeline</h4>
                            <div id="taskTimeline" style="background: var(--gray-50); border-radius: 0.5rem; padding: 1.5rem; min-height: 300px;"></div>
                        </div>

                        <!-- Detailed Task List -->
                        <div style="margin-bottom: 2rem;">
                            <h4 style="margin-bottom: 1rem;"> Task Details</h4>
                            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                <button class="btn btn-secondary small" onclick="filterTasks('all')">All Tasks</button>
                                <button class="btn btn-secondary small" onclick="filterTasks('completed')">Completed</button>
                                <button class="btn btn-secondary small" onclick="filterTasks('in-progress')">In Progress</button>
                                <button class="btn btn-secondary small" onclick="filterTasks('overdue')">Overdue</button>
                            </div>
                            <div id="detailedTaskList" style="background: white; border-radius: 0.5rem; overflow: hidden;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== GLOBAL VARIABLES ====================
        // Version tracking
        const APP_VERSION = '6.2.1';
        const DEBUG_MODE = localStorage.getItem('debugMode') === 'true';
        
        // Core state variables
        let projects = {};
        let currentProjectId = null;
        let selectedTemplate = 'new-build';
        let taskIdCounter = 100;
        let isOnline = false;
        let currentTheme = localStorage.getItem('theme') || 'light';
        
        // Debug logging function
        function debugLog(message, data) {
            if (DEBUG_MODE) {
                console.log(`[DEBUG v${APP_VERSION}] ${message}`, data || '');
            }
        }
        
        // History management for undo/redo
        const history = {
            stack: [],
            index: -1,
            
            push(state) {
                if (!state) {
                    debugLog('Warning: Attempted to push null state to history');
                    return;
                }
                this.stack = this.stack.slice(0, this.index + 1);
                this.stack.push(JSON.stringify(state));
                this.index++;
                if (this.stack.length > 50) {
                    this.stack.shift();
                    this.index--;
                }
            },
            
            undo() {
                if (this.index > 0) {
                    this.index--;
                    return JSON.parse(this.stack[this.index]);
                }
                return null;
            },
            
            redo() {
                if (this.index < this.stack.length - 1) {
                    this.index++;
                    return JSON.parse(this.stack[this.index]);
                }
                return null;
            }
        };
        
        // Configure API endpoint for database functionality
        let apiEndpoint = null; // Currently set to offline mode

        // ==================== UTILITY FUNCTIONS WITH NULL CHECKS ====================
        
        // HTML escaping for security
        function escapeHtml(text) {
            if (text === null || text === undefined) {
                return '';
            }
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
        
        // Generate secure IDs
        function generateSecureId() {
            if (crypto && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Generate task ID
        function generateTaskId() {
            return 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Debounce function for performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Theme toggle with null checks
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) {
                themeIcon.textContent = currentTheme === 'light' ? '' : '';
            }
        }
        
        // Apply theme on load with null checks
        function applyTheme() {
            document.documentElement.setAttribute('data-theme', currentTheme);
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) {
                themeIcon.textContent = currentTheme === 'light' ? '' : '';
            }
        }
        
        // Notification system with validation
        function showNotification(message, type = 'info') {
            if (!message) {
                debugLog('Warning: Empty notification message');
                return;
            }
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            const icons = {
                success: '',
                error: '',
                warning: '',
                info: ''
            };
            
            notification.innerHTML = `
                <span class="notification-icon">${icons[type] || icons.info}</span>
                <span class="notification-content">${escapeHtml(message)}</span>
                <span class="notification-close" onclick="this.parentElement.remove()"></span>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // Set loading state on elements with null checks
        function setLoadingState(element, isLoading, text = 'Loading...') {
            if (!element) {
                debugLog('Warning: setLoadingState called with null element');
                return;
            }
            
            if (isLoading) {
                element.classList.add('loading');
                element.setAttribute('data-original-content', element.innerHTML);
                element.innerHTML = `<span class="spinner"></span> ${escapeHtml(text)}`;
                element.disabled = true;
            } else {
                element.classList.remove('loading');
                const originalContent = element.getAttribute('data-original-content');
                if (originalContent) {
                    element.innerHTML = originalContent;
                }
                element.disabled = false;
            }
        }
        
        // Validate project data with comprehensive checks
        function validateProjectData(data) {
            const errors = [];
            
            if (!data) {
                errors.push('Project data is required');
                return errors;
            }
            
            if (!data.name || data.name.trim().length < 3) {
                errors.push('Project name must be at least 3 characters');
            }
            
            if (!data.manager || data.manager.trim().length < 2) {
                errors.push('Project manager name is required');
            }
            
            if (!data.targetDate) {
                errors.push('Target completion date is required');
            } else {
                const targetDate = new Date(data.targetDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                if (targetDate < today) {
                    errors.push('Target date cannot be in the past');
                }
            }
            
            return errors;
        }
        
        // Create backup with error handling
        function createBackup() {
            try {
                const backup = {
                    version: APP_VERSION,
                    timestamp: new Date().toISOString(),
                    projects: projects || {},
                    metadata: {
                        totalProjects: Object.keys(projects || {}).length,
                        theme: currentTheme
                    }
                };
                
                const blob = new Blob([JSON.stringify(backup, null, 2)], 
                                      { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `av-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showNotification('Backup created successfully', 'success');
            } catch (error) {
                console.error('Backup creation error:', error);
                showNotification('Error creating backup', 'error');
            }
        }
        
        // Import backup with validation
        function handleImport(event) {
            const file = event.target.files?.[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const result = e.target?.result;
                    if (!result) {
                        throw new Error('No file content');
                    }
                    
                    const backup = JSON.parse(result);
                    if (backup.version && backup.projects) {
                        if (confirm('This will replace all current projects. Continue?')) {
                            projects = backup.projects || {};
                            saveToLocal(projects);
                            renderProjects();
                            updateDashboardMetrics();
                            history.push(projects);
                            showNotification('Backup imported successfully', 'success');
                        }
                    } else {
                        throw new Error('Invalid backup format');
                    }
                } catch (error) {
                    showNotification('Invalid backup file', 'error');
                    console.error('Import error:', error);
                }
            };
            
            reader.onerror = () => {
                showNotification('Error reading file', 'error');
            };
            
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // ==================== DATABASE SERVICE WITH ERROR HANDLING ====================
        const dbService = {
            async checkConnection() {
                if (window.location.protocol === 'file:' || !apiEndpoint) {
                    return false;
                }
                try {
                    const response = await fetch(`${apiEndpoint}/health`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    return response.ok;
                } catch (error) {
                    debugLog('Database connection not available', error);
                    return false;
                }
            },

            async fetchProjects() {
                if (!apiEndpoint) return null;
                
                try {
                    const response = await fetch(`${apiEndpoint}/projects`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (response.ok) {
                        return await response.json();
                    }
                    throw new Error('Failed to fetch projects');
                } catch (error) {
                    debugLog('Database fetch error', error);
                    return null;
                }
            },

            async saveProject(project) {
                if (!apiEndpoint || !project || !project.id) return null;
                
                try {
                    const response = await fetch(`${apiEndpoint}/projects/${project.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(project)
                    });
                    if (response.ok) {
                        return await response.json();
                    }
                    throw new Error('Failed to save project');
                } catch (error) {
                    debugLog('Database save error', error);
                    return null;
                }
            },

            async createProject(project) {
                if (!apiEndpoint || !project) return null;
                
                try {
                    const response = await fetch(`${apiEndpoint}/projects`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(project)
                    });
                    if (response.ok) {
                        return await response.json();
                    }
                    throw new Error('Failed to create project');
                } catch (error) {
                    debugLog('Database create error', error);
                    return null;
                }
            },

            async deleteProject(projectId) {
                if (!apiEndpoint || !projectId) return false;
                
                try {
                    const response = await fetch(`${apiEndpoint}/projects/${projectId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    return response.ok;
                } catch (error) {
                    debugLog('Database delete error', error);
                    return false;
                }
            }
        };

        // ==================== INITIALIZATION WITH NULL CHECKS ====================
        document.addEventListener('DOMContentLoaded', function() {
            debugLog(`AV Project Management Tool v${APP_VERSION} initializing...`);
            
            applyTheme();
            initializeApp();
            checkDatabaseConnection();
            loadProjects();
            setDefaultDate();
            setupKeyboardShortcuts();
            setupDebouncedSearch();
        });

        async function checkDatabaseConnection() {
            try {
                isOnline = await dbService.checkConnection();
                updateConnectionStatus(isOnline);
                
                if (apiEndpoint && window.location.protocol !== 'file:') {
                    setInterval(async () => {
                        try {
                            const newStatus = await dbService.checkConnection();
                            if (newStatus !== isOnline) {
                                isOnline = newStatus;
                                updateConnectionStatus(isOnline);
                                if (isOnline) {
                                    syncLocalToDatabase();
                                }
                            }
                        } catch (error) {
                            debugLog('Connection check failed', error);
                        }
                    }, 30000);
                }
            } catch (error) {
                debugLog('Initial connection check failed', error);
                isOnline = false;
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(online) {
            const statusIndicator = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');
            
            if (statusIndicator) {
                if (online) {
                    statusIndicator.classList.remove('offline');
                } else {
                    statusIndicator.classList.add('offline');
                }
            }
            
            if (statusText) {
                statusText.textContent = online ? 'Online' : 'Offline Mode';
            }
        }

        async function syncLocalToDatabase() {
            if (!isOnline || !apiEndpoint) return;
            
            try {
                const localProjects = getLocalProjects();
                for (const projectId in localProjects) {
                    if (localProjects[projectId]) {
                        await dbService.saveProject(localProjects[projectId]);
                    }
                }
                showNotification('Projects synced to database', 'success');
            } catch (error) {
                debugLog('Sync to database failed', error);
            }
        }

        function initializeApp() {
            debugLog('AV Project Management Tool Enhanced Edition initialized');
            
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project');
            
            if (projectId && projects[projectId]) {
                loadProject(projectId);
            } else {
                showLandingPage();
            }
        }

        function setDefaultDate() {
            const dateInput = document.getElementById('newProjectDate');
            if (dateInput) {
                const today = new Date();
                const nextMonth = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
                dateInput.value = nextMonth.toISOString().split('T')[0];
            }
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + S to save
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    if (currentProjectId) saveProject();
                }
                
                // Ctrl/Cmd + N for new project
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    showCreateProjectModal();
                }
                
                // Ctrl/Cmd + Z for undo
                if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                    e.preventDefault();
                    undo();
                }
                
                // Ctrl/Cmd + Shift + Z for redo
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'z') {
                    e.preventDefault();
                    redo();
                }
                
                // ESC to close modals
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
        }

        function setupDebouncedSearch() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                const debouncedSearch = debounce(searchProjects, 300);
                searchInput.addEventListener('keyup', debouncedSearch);
            }
        }

        function undo() {
            const previousState = history.undo();
            if (previousState) {
                projects = previousState;
                saveToLocal(projects);
                renderProjects();
                updateDashboardMetrics();
                if (currentProjectId && projects[currentProjectId]) {
                    renderTrackerTasks(projects[currentProjectId].tasks || []);
                    updateAllProgress();
                }
                showNotification('Undo successful', 'info');
            }
        }

        function redo() {
            const nextState = history.redo();
            if (nextState) {
                projects = nextState;
                saveToLocal(projects);
                renderProjects();
                updateDashboardMetrics();
                if (currentProjectId && projects[currentProjectId]) {
                    renderTrackerTasks(projects[currentProjectId].tasks || []);
                    updateAllProgress();
                }
                showNotification('Redo successful', 'info');
            }
        }

        // ==================== NAVIGATION WITH NULL CHECKS ====================
        function showLandingPage() {
            const landingPage = document.getElementById('landingPage');
            const trackerPage = document.getElementById('trackerPage');
            const dashboardBtn = document.getElementById('dashboardBtn');
            
            if (landingPage) landingPage.classList.add('active');
            if (trackerPage) trackerPage.classList.remove('active');
            if (dashboardBtn) dashboardBtn.style.display = 'none';
            
            // Clear current project when returning to dashboard
            currentProjectId = null;
            
            // Re-render projects to ensure latest data is shown
            renderProjects();
            updateDashboardMetrics();
            
            // Clear URL parameter - with error handling for iframe environments
            try {
                if (window.location.protocol !== 'about:') {
                    window.history.pushState({}, '', window.location.pathname);
                }
            } catch (e) {
                // Ignore history errors in restricted environments
                debugLog('History API not available in this environment');
            }
        }

        function showTrackerPage() {
            const landingPage = document.getElementById('landingPage');
            const trackerPage = document.getElementById('trackerPage');
            const dashboardBtn = document.getElementById('dashboardBtn');
            
            if (landingPage) landingPage.classList.remove('active');
            if (trackerPage) trackerPage.classList.add('active');
            if (dashboardBtn) dashboardBtn.style.display = 'block';
        }

        function navigateToDashboard() {
            // Save current project data before navigating away
            if (currentProjectId) {
                saveProjects();
            }
            window.location.href = window.location.pathname;
        }

        // ==================== PROJECT MANAGEMENT WITH NULL CHECKS ====================
        async function loadProjects() {
            try {
                if (isOnline && apiEndpoint) {
                    const dbProjects = await dbService.fetchProjects();
                    if (dbProjects) {
                        projects = dbProjects;
                        saveToLocal(projects);
                    } else {
                        projects = getLocalProjects();
                    }
                } else {
                    projects = getLocalProjects();
                }
                
                // Migrate data for enhanced reporting
                migrateDataForReporting();
                
                renderProjects();
                updateDashboardMetrics();
                history.push(projects);
            } catch (error) {
                console.error('Error loading projects:', error);
                projects = getLocalProjects();
                migrateDataForReporting();
                renderProjects();
                updateDashboardMetrics();
            }
        }

        function getLocalProjects() {
            try {
                const savedProjects = localStorage.getItem('avProjects');
                return savedProjects ? JSON.parse(savedProjects) : {};
            } catch (error) {
                console.error('Error loading local projects:', error);
                return {};
            }
        }

        function saveToLocal(projectsData) {
            if (!projectsData) {
                debugLog('Warning: Attempted to save null projects data');
                return;
            }
            
            try {
                localStorage.setItem('avProjects', JSON.stringify(projectsData));
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                showNotification('Error saving data locally', 'error');
            }
        }

        async function saveProjects() {
            try {
                saveToLocal(projects);
                history.push(projects);
                
                if (isOnline && currentProjectId && apiEndpoint) {
                    const project = projects[currentProjectId];
                    if (project) {
                        const saved = await dbService.saveProject(project);
                        if (!saved) {
                            showNotification('Project saved locally, will sync when online', 'warning');
                        } else {
                            showNotification('Project saved successfully', 'success');
                        }
                    }
                }
            } catch (error) {
                console.error('Error saving projects:', error);
                saveToLocal(projects);
                showNotification('Error saving project. Data saved locally.', 'error');
            }
        }

        async function createProject() {
            // Get form elements with null checks
            const nameInput = document.getElementById('newProjectName');
            const managerInput = document.getElementById('newProjectManager');
            const locationInput = document.getElementById('newProjectLocation');
            const dateInput = document.getElementById('newProjectDate');
            
            if (!nameInput || !managerInput || !dateInput) {
                showNotification('Form elements not found', 'error');
                return;
            }
            
            const projectName = nameInput.value;
            const projectManager = managerInput.value;
            const projectLocation = locationInput?.value || '';
            const targetDate = dateInput.value;
            
            // Clear previous errors
            document.querySelectorAll('.form-error').forEach(el => {
                el.style.display = 'none';
                el.textContent = '';
            });
            
            // Validate data
            const projectData = {
                name: projectName,
                manager: projectManager,
                location: projectLocation,
                targetDate: targetDate,
                template: selectedTemplate
            };
            
            const errors = validateProjectData(projectData);
            
            if (errors.length > 0) {
                // Show errors
                errors.forEach(error => {
                    if (error.includes('Project name')) {
                        const errorEl = document.getElementById('projectNameError');
                        if (errorEl) {
                            errorEl.textContent = error;
                            errorEl.style.display = 'block';
                        }
                    }
                    if (error.includes('manager')) {
                        const errorEl = document.getElementById('projectManagerError');
                        if (errorEl) {
                            errorEl.textContent = error;
                            errorEl.style.display = 'block';
                        }
                    }
                    if (error.includes('date')) {
                        const errorEl = document.getElementById('projectDateError');
                        if (errorEl) {
                            errorEl.textContent = error;
                            errorEl.style.display = 'block';
                        }
                    }
                });
                return;
            }
            
            const createBtn = document.getElementById('createProjectBtn');
            if (createBtn) {
                setLoadingState(createBtn, true, 'Creating...');
            }
            
            try {
                const projectId = generateSecureId();
                
                projectData.id = projectId;
                projectData.createdDate = new Date().toISOString();
                projectData.status = 'active';
                projectData.health = 'green';
                projectData.currentPhase = 1;
                projectData.overallProgress = 0;
                projectData.tasks = generateTemplateTasks(selectedTemplate, projectName);
                
                // Enhanced tracking fields for executive reporting
                projectData.actualStartDate = null;
                projectData.completedDate = null;
                projectData.estimatedBudget = 0;
                projectData.actualBudget = 0;
                projectData.estimatedHours = 0;
                projectData.actualHours = 0;
                projectData.clientDepartment = '';
                projectData.stakeholders = [];
                projectData.riskLevel = 'low';
                projectData.statusHistory = [{
                    status: 'active',
                    timestamp: new Date().toISOString(),
                    changedBy: projectData.manager || 'System',
                    notes: 'Project created'
                }];
                
                if (isOnline && apiEndpoint) {
                    try {
                        const savedProject = await dbService.createProject(projectData);
                        if (savedProject) {
                            projectData.id = savedProject.id || projectId;
                        }
                    } catch (error) {
                        debugLog('Could not save to database, saving locally', error);
                    }
                }
                
                projects[projectData.id] = projectData;
                saveToLocal(projects);
                history.push(projects);
                
                closeModal();
                loadProject(projectData.id);
                showNotification('Project created successfully', 'success');
                
            } catch (error) {
                console.error('Error creating project:', error);
                showNotification('Error creating project. Please try again.', 'error');
            } finally {
                if (createBtn) {
                    setLoadingState(createBtn, false);
                    createBtn.innerHTML = 'Create Project';
                }
            }
        }

        function generateTemplateTasks(template, projectName) {
            const baseTasks = {
                'new-build': [
                    // Phase 1
                    { phase: 1, name: 'Create Project Folder in Egnyte', priority: 'high', status: 'not-started' },
                    { phase: 1, name: 'Create SNOW Ticket for Project', priority: 'medium', status: 'not-started' },
                    { phase: 1, name: 'Initial Project Information Gathered', priority: 'high', status: 'not-started' },
                    { phase: 1, name: 'RACI Gathered to Determine Stakeholders', priority: 'high', status: 'not-started' },
                    { phase: 1, name: 'Kick-off Meeting', priority: 'critical', status: 'not-started' },
                    { phase: 1, name: 'Request Vendor Quote', priority: 'high', status: 'not-started' },
                    { phase: 1, name: 'Submit Finalized Quote for Approval', priority: 'critical', status: 'not-started' },
                    { phase: 1, name: 'Create SNOW Request for PO', priority: 'critical', status: 'not-started' },
                    // Phase 2
                    { phase: 2, name: 'Request Hardware MAC and Serial Numbers', priority: 'high', status: 'not-started' },
                    { phase: 2, name: 'Verify Installation Dates with Stakeholders', priority: 'critical', status: 'not-started' },
                    { phase: 2, name: 'Verify Space Name with Stakeholders', priority: 'high', status: 'not-started' },
                    // Phase 3
                    { phase: 3, name: 'AV Vendor Delivery and Installation', priority: 'critical', status: 'not-started' },
                    // Phase 4
                    { phase: 4, name: 'Comprehensive System Testing', priority: 'critical', status: 'not-started' },
                    // Phase 5
                    { phase: 5, name: 'Documentation Handover', priority: 'critical', status: 'not-started' }
                ],
                'upgrade': [
                    // Phase 1
                    { phase: 1, name: 'Assess Current System', priority: 'critical', status: 'not-started' },
                    { phase: 1, name: 'Document Upgrade Requirements', priority: 'high', status: 'not-started' },
                    { phase: 1, name: 'Request Upgrade Quote', priority: 'high', status: 'not-started' },
                    // Phase 2
                    { phase: 2, name: 'Schedule Upgrade Window', priority: 'critical', status: 'not-started' },
                    { phase: 2, name: 'Backup Current Configuration', priority: 'critical', status: 'not-started' },
                    // Phase 3
                    { phase: 3, name: 'Install Upgraded Components', priority: 'critical', status: 'not-started' },
                    // Phase 4
                    { phase: 4, name: 'Test Upgraded System', priority: 'critical', status: 'not-started' },
                    // Phase 5
                    { phase: 5, name: 'User Training on New Features', priority: 'high', status: 'not-started' }
                ],
                'break-fix': [
                    // Phase 1
                    { phase: 1, name: 'Diagnose Issue', priority: 'critical', status: 'not-started' },
                    { phase: 1, name: 'Document Problem Details', priority: 'high', status: 'not-started' },
                    // Phase 2
                    { phase: 2, name: 'Order Replacement Parts', priority: 'critical', status: 'not-started' },
                    // Phase 3
                    { phase: 3, name: 'Replace/Repair Components', priority: 'critical', status: 'not-started' },
                    // Phase 4
                    { phase: 4, name: 'Test Repair', priority: 'critical', status: 'not-started' },
                    // Phase 5
                    { phase: 5, name: 'Close Ticket', priority: 'high', status: 'not-started' }
                ],
                'blank': []
            };
            
            const tasks = baseTasks[template] || [];
            
            return tasks.map((task, index) => ({
                id: generateTaskId(),
                ...task,
                assignedTo: '',
                health: 'green',
                startDate: new Date().toISOString().split('T')[0],
                dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                notes: '',
                completed: false,
                // Enhanced tracking fields for executive reporting
                completedDate: null,
                actualStartDate: null,
                statusHistory: [{
                    status: 'not-started',
                    timestamp: new Date().toISOString(),
                    changedBy: 'System'
                }],
                assignmentHistory: [],
                estimatedHours: 0,
                actualHours: 0
            }));
        }

        function loadProject(projectId) {
            if (!projectId) {
                showNotification('Invalid project ID', 'error');
                showLandingPage();
                return;
            }
            
            const project = projects[projectId];
            if (!project) {
                showNotification('Project not found', 'error');
                showLandingPage();
                return;
            }
            
            currentProjectId = projectId;
            
            const trackerTitle = document.getElementById('trackerTitle');
            if (trackerTitle) {
                trackerTitle.textContent = project.name || 'Unnamed Project';
            }
            
            renderTrackerTasks(project.tasks || []);
            updateAllProgress();
            showTrackerPage();
            
            // Update URL without causing a page reload - with error handling
            try {
                if (window.location.protocol !== 'about:') {
                    const newUrl = window.location.pathname + '?project=' + projectId;
                    window.history.pushState({ project: projectId }, '', newUrl);
                }
            } catch (e) {
                // Ignore history errors in restricted environments
                debugLog('History API not available in this environment');
            }
            
            // Ensure the data is saved
            saveProjects();
        }

        function renderTrackerTasks(tasks) {
            const tableBody = document.getElementById('taskTableBody');
            if (!tableBody) {
                debugLog('Warning: taskTableBody element not found');
                return;
            }
            
            tableBody.innerHTML = '';
            
            const phases = [1, 2, 3, 4, 5];
            const phaseNames = [
                'PHASE 1: PRE-INSTALLATION  LOGISTICS',
                'PHASE 2: PRE-INSTALLATION - AV SETUP',
                'PHASE 3: INSTALLATION AND COMMISSIONING',
                'PHASE 4: POST-INSTALLATION TESTING',
                'PHASE 5: PROJECT CLOSEOUT'
            ];
            
            phases.forEach((phase, index) => {
                const phaseHeader = document.createElement('tr');
                phaseHeader.className = 'phase-header';
                phaseHeader.innerHTML = `
                    <td colspan="10">
                        <div class="phase-header-content">
                            <strong>${escapeHtml(phaseNames[index])}</strong>
                            <div class="phase-progress" id="phase${phase}ProgressText">
                                Progress: 0%
                            </div>
                        </div>
                    </td>
                `;
                tableBody.appendChild(phaseHeader);
                
                const phaseTasks = (tasks || []).filter(task => task && task.phase === phase);
                phaseTasks.forEach(task => {
                    if (task) {
                        const taskRow = createTaskRow(task);
                        if (taskRow) {
                            tableBody.appendChild(taskRow);
                        }
                    }
                });
                
                if (phaseTasks.length === 0) {
                    const emptyRow = document.createElement('tr');
                    emptyRow.className = 'task-row';
                    emptyRow.innerHTML = `
                        <td colspan="10" style="text-align: center; color: var(--gray-400); padding: 1rem;">
                            No tasks in this phase. Click "Add Task" to create one.
                        </td>
                    `;
                    tableBody.appendChild(emptyRow);
                }
            });
        }

        // ==================== CRITICAL FUNCTIONS WITH NULL CHECKS ====================
        
        // Create a task row for the table with comprehensive null checks
        function createTaskRow(task) {
            if (!task || !task.id) {
                debugLog('Warning: Invalid task data', task);
                return null;
            }
            
            const row = document.createElement('tr');
            row.className = 'task-row';
            row.setAttribute('data-task-id', task.id);
            
            // Determine if task is overdue
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dueDate = task.dueDate ? new Date(task.dueDate) : null;
            const isOverdue = dueDate && dueDate < today && !task.completed;
            
            row.innerHTML = `
                <td>
                    <input type="checkbox" 
                           class="task-checkbox" 
                           ${task.completed ? 'checked' : ''}
                           data-phase="${task.phase || 1}"
                           onchange="updateTaskCompletion('${task.id}')">
                </td>
                <td>
                    <div class="task-actions">
                        <button class="delete-task-btn" onclick="deleteTask('${task.id}')" title="Delete task"></button>
                    </div>
                </td>
                <td class="task-name-cell">
                    <input type="text" 
                           class="editable-task-name" 
                           value="${escapeHtml(task.name || '')}"
                           onchange="updateTaskField('${task.id}', 'name', this.value)"
                           placeholder="Enter task name...">
                </td>
                <td>
                    <input type="text" 
                           class="task-input" 
                           value="${escapeHtml(task.assignedTo || '')}"
                           onchange="updateTaskField('${task.id}', 'assignedTo', this.value)"
                           placeholder="Assign to...">
                </td>
                <td>
                    <select class="priority-select priority-${task.priority || 'medium'}" 
                            onchange="updateTaskField('${task.id}', 'priority', this.value); updatePriorityClass(this);">
                        <option value="low" ${task.priority === 'low' ? 'selected' : ''}>Low</option>
                        <option value="medium" ${(task.priority === 'medium' || !task.priority) ? 'selected' : ''}>Medium</option>
                        <option value="high" ${task.priority === 'high' ? 'selected' : ''}>High</option>
                        <option value="critical" ${task.priority === 'critical' ? 'selected' : ''}>Critical</option>
                    </select>
                </td>
                <td>
                    <select class="status-select status-${task.status || 'not-started'}" 
                            onchange="updateTaskField('${task.id}', 'status', this.value); updateStatusClass(this);">
                        <option value="not-started" ${(task.status === 'not-started' || !task.status) ? 'selected' : ''}>Not Started</option>
                        <option value="in-progress" ${task.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                        <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
                    </select>
                </td>
                <td>
                    <div class="health-light-container">
                        <div class="health-light ${task.health || 'green'}" 
                             data-health="${task.health || 'green'}"
                             onclick="toggleHealthDropdown(this)"></div>
                        <div class="health-dropdown">
                            <div class="health-option" onclick="setHealth(this, 'green', '${task.id}')">
                                <div class="health-option-light green"></div>
                                <span>On Track</span>
                            </div>
                            <div class="health-option" onclick="setHealth(this, 'yellow', '${task.id}')">
                                <div class="health-option-light yellow"></div>
                                <span>At Risk</span>
                            </div>
                            <div class="health-option" onclick="setHealth(this, 'red', '${task.id}')">
                                <div class="health-option-light red"></div>
                                <span>Critical</span>
                            </div>
                        </div>
                    </div>
                </td>
                <td>
                    <input type="date" 
                           class="task-input" 
                           value="${task.startDate || ''}"
                           onchange="updateTaskField('${task.id}', 'startDate', this.value)">
                </td>
                <td>
                    <input type="date" 
                           class="task-input ${isOverdue ? 'overdue' : ''}" 
                           value="${task.dueDate || ''}"
                           onchange="updateTaskField('${task.id}', 'dueDate', this.value)">
                </td>
                <td>
                    <textarea class="task-textarea" 
                              onchange="updateTaskField('${task.id}', 'notes', this.value)"
                              placeholder="Add notes...">${escapeHtml(task.notes || '')}</textarea>
                </td>
            `;
            
            return row;
        }

        // Add a new task to the current project with null checks
        function addTask() {
            if (!currentProjectId) {
                showNotification('Please select or create a project first', 'warning');
                return;
            }
            
            const project = projects[currentProjectId];
            if (!project) {
                showNotification('Project not found', 'error');
                return;
            }
            
            // Ensure tasks array exists
            if (!project.tasks) {
                project.tasks = [];
            }
            
            // Determine the current phase based on incomplete tasks
            let currentPhase = 1;
            const incompleteTasks = project.tasks.filter(t => t && !t.completed);
            if (incompleteTasks.length > 0 && incompleteTasks[0].phase) {
                currentPhase = incompleteTasks[0].phase;
            }
            
            // Prompt for phase selection
            const phaseSelect = prompt('Select phase for new task:\n1 - Logistics\n2 - AV Setup\n3 - Installation\n4 - Testing\n5 - Closeout', currentPhase);
            
            if (!phaseSelect || !['1','2','3','4','5'].includes(phaseSelect)) {
                return;
            }
            
            const newTask = {
                id: generateTaskId(),
                phase: parseInt(phaseSelect),
                name: 'New Task',
                assignedTo: '',
                priority: 'medium',
                status: 'not-started',
                health: 'green',
                startDate: new Date().toISOString().split('T')[0],
                dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                notes: '',
                completed: false
            };
            
            project.tasks.push(newTask);
            
            // Re-sort tasks by phase
            project.tasks.sort((a, b) => (a?.phase || 0) - (b?.phase || 0));
            
            // Save and re-render
            saveProjects();
            renderTrackerTasks(project.tasks);
            updateAllProgress();
            
            showNotification('New task added successfully', 'success');
            
            // Focus on the new task name field
            setTimeout(() => {
                const newRow = document.querySelector(`tr[data-task-id="${newTask.id}"]`);
                if (newRow) {
                    const nameInput = newRow.querySelector('.editable-task-name');
                    if (nameInput) {
                        nameInput.focus();
                        nameInput.select();
                    }
                }
            }, 100);
        }

        // Delete a task with null checks
        function deleteTask(taskId) {
            if (!currentProjectId || !taskId) {
                debugLog('Warning: deleteTask called with invalid parameters', { currentProjectId, taskId });
                return;
            }
            
            const project = projects[currentProjectId];
            if (!project || !project.tasks) {
                showNotification('Project or tasks not found', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to delete this task?')) {
                project.tasks = project.tasks.filter(t => t && t.id !== taskId);
                
                saveProjects();
                renderTrackerTasks(project.tasks);
                updateAllProgress();
                
                showNotification('Task deleted successfully', 'success');
            }
        }

        // Update task field with null checks
        function updateTaskField(taskId, field, value) {
            if (!currentProjectId || !taskId || !field) {
                debugLog('Warning: updateTaskField called with invalid parameters', { currentProjectId, taskId, field });
                return;
            }
            
            const project = projects[currentProjectId];
            if (!project || !project.tasks) {
                debugLog('Warning: Project or tasks not found');
                return;
            }
            
            const task = project.tasks.find(t => t && t.id === taskId);
            
            if (!task) {
                debugLog('Warning: Task not found', taskId);
                return;
            }
            
            // Store previous value for history tracking
            const previousValue = task[field];
            task[field] = value;
            
            // Add to history for executive reporting
            if (field === 'status' && previousValue !== value) {
                if (!task.statusHistory) task.statusHistory = [];
                task.statusHistory.push({
                    status: value,
                    previousStatus: previousValue,
                    timestamp: new Date().toISOString(),
                    changedBy: task.assignedTo || 'Unknown'
                });
                
                // Track when task actually starts
                if (value === 'in-progress' && !task.actualStartDate) {
                    task.actualStartDate = new Date().toISOString();
                }
            }
            
            // Track assignment changes
            if (field === 'assignedTo' && previousValue !== value) {
                if (!task.assignmentHistory) task.assignmentHistory = [];
                task.assignmentHistory.push({
                    assignedTo: value,
                    previousAssignee: previousValue,
                    timestamp: new Date().toISOString()
                });
            }
            
            // CRITICAL: Sync completion status with status field changes
            if (field === 'status') {
                const taskRow = document.querySelector(`tr[data-task-id="${taskId}"]`);
                const checkbox = taskRow ? taskRow.querySelector('.task-checkbox') : null;
                
                if (value === 'completed') {
                    // STATUS CHANGED TO COMPLETED - CHECK THE CHECKBOX
                    task.completed = true;
                    task.completedDate = new Date().toISOString();
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                    // Remove overdue styling when completed
                    const dueDateInput = taskRow ? taskRow.querySelector('td:nth-child(9) input') : null;
                    if (dueDateInput) {
                        dueDateInput.classList.remove('overdue');
                    }
                    showNotification(`Task "${task.name}" marked as complete!`, 'success');
                } else {
                    // STATUS CHANGED AWAY FROM COMPLETED - UNCHECK THE CHECKBOX
                    task.completed = false;
                    task.completedDate = null;
                    if (checkbox) {
                        checkbox.checked = false;
                    }
                    // Check if task should be marked as overdue
                    if (taskRow) {
                        const dueDateInput = taskRow.querySelector('td:nth-child(9) input');
                        if (dueDateInput && dueDateInput.value) {
                            const dueDate = new Date(dueDateInput.value);
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            if (dueDate < today) {
                                dueDateInput.classList.add('overdue');
                            }
                        }
                    }
                }
            }
            
            // Check if due date makes task overdue
            if (field === 'dueDate') {
                const taskRow = document.querySelector(`tr[data-task-id="${taskId}"]`);
                if (taskRow) {
                    const dueDateInput = taskRow.querySelector('td:nth-child(9) input');
                    if (dueDateInput) {
                        const dueDate = new Date(value);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        
                        if (dueDate < today && !task.completed) {
                            dueDateInput.classList.add('overdue');
                        } else {
                            dueDateInput.classList.remove('overdue');
                        }
                    }
                }
            }
            
            saveProjects();
            updateAllProgress();
        }

        // Update task completion with null checks
        function updateTaskCompletion(taskId) {
            if (!currentProjectId || !taskId) {
                debugLog('Warning: updateTaskCompletion called with invalid parameters');
                return;
            }
            
            const project = projects[currentProjectId];
            if (!project || !project.tasks) {
                debugLog('Warning: Project or tasks not found');
                return;
            }
            
            const task = project.tasks.find(t => t && t.id === taskId);
            
            if (!task) {
                debugLog('Warning: Task not found', taskId);
                return;
            }
            
            // Get the checkbox to see its current state
            const taskRow = document.querySelector(`tr[data-task-id="${taskId}"]`);
            const checkbox = taskRow ? taskRow.querySelector('.task-checkbox') : null;
            
            if (checkbox) {
                // CHECKBOX IS MASTER CONTROL - Update task based on checkbox state
                task.completed = checkbox.checked;
                
                // ALWAYS sync status with checkbox state
                if (checkbox.checked) {
                    task.status = 'completed';
                } else {
                    task.status = 'not-started';
                }
                
                // IMMEDIATELY update the status dropdown to match checkbox
                const statusSelect = taskRow.querySelector('.status-select');
                if (statusSelect) {
                    statusSelect.value = task.status;
                    statusSelect.className = `status-select status-${task.status}`;
                }
                
                // Update due date styling
                const dueDateInput = taskRow.querySelector('td:nth-child(9) input');
                if (dueDateInput) {
                    if (task.completed) {
                        dueDateInput.classList.remove('overdue');
                    } else {
                        // Check if it should be marked as overdue
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const dueDate = task.dueDate ? new Date(task.dueDate) : null;
                        if (dueDate && dueDate < today) {
                            dueDateInput.classList.add('overdue');
                        }
                    }
                }
                
                // Save and update everything
                saveProjects();
                updateAllProgress();
                
                // Show completion notification
                if (task.completed) {
                    showNotification(` Task "${task.name}" marked as complete!`, 'success');
                } else {
                    showNotification(` Task "${task.name}" marked as incomplete`, 'info');
                }
            }
        }

        // ==================== PROJECT CARDS WITH NULL CHECKS ====================
        function renderProjects() {
            const grid = document.getElementById('projectsGrid');
            if (!grid) {
                debugLog('Warning: projectsGrid element not found');
                return;
            }
            
            grid.innerHTML = '';

            Object.values(projects || {}).forEach(project => {
                if (project) {
                    const card = createProjectCard(project);
                    if (card) {
                        grid.appendChild(card);
                    }
                }
            });
            
            updateProjectCount();
        }

        function createProjectCard(project) {
            if (!project || !project.id) {
                debugLog('Warning: Invalid project data for card creation');
                return null;
            }
            
            const card = document.createElement('div');
            card.className = 'project-card';
            card.setAttribute('data-project-id', project.id);
            
            const tasks = project.tasks || [];
            const completedTasks = tasks.filter(t => t && t.completed).length;
            const totalTasks = tasks.length;
            
            // Calculate phase completion accurately
            // A phase is only complete if ALL tasks in that phase are complete
            const phaseCompletion = {};
            const phases = [1, 2, 3, 4, 5];
            
            phases.forEach(phase => {
                const phaseTasks = tasks.filter(t => t && t.phase === phase);
                if (phaseTasks.length > 0) {
                    const phaseCompletedTasks = phaseTasks.filter(t => t.completed).length;
                    phaseCompletion[phase] = {
                        total: phaseTasks.length,
                        completed: phaseCompletedTasks,
                        isComplete: phaseCompletedTasks === phaseTasks.length,
                        progress: phaseCompletedTasks / phaseTasks.length
                    };
                } else {
                    phaseCompletion[phase] = {
                        total: 0,
                        completed: 0,
                        isComplete: true, // Empty phases are considered complete
                        progress: 1.0
                    };
                }
            });
            
            // Calculate SEQUENTIAL phase progress (can't advance past incomplete phases)
            let sequentialProgress = 0;
            let currentPhase = 1;
            
            for (let phase = 1; phase <= 5; phase++) {
                if (phaseCompletion[phase].isComplete) {
                    // This phase is 100% complete, add 20% to total progress
                    sequentialProgress += 20; // 100% / 5 phases = 20% per phase
                } else {
                    // This is the current working phase - add partial progress
                    currentPhase = phase;
                    const phaseProgress = phaseCompletion[phase].progress || 0;
                    sequentialProgress += phaseProgress * 20; // Partial progress within this phase
                    break; // Can't progress past this incomplete phase
                }
            }
            
            // If all phases are complete, we're at 100%
            const allComplete = phases.every(p => phaseCompletion[p].isComplete);
            if (allComplete) {
                sequentialProgress = 100;
                currentPhase = 5;
            }
            
            const progress = Math.round(sequentialProgress);
            
            const targetDate = project.targetDate ? new Date(project.targetDate) : new Date();
            const today = new Date();
            const daysRemaining = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            
            let health = 'green';
            if (daysRemaining < 0) health = 'red';
            else if (daysRemaining < 7) health = 'yellow';
            
            const typeClass = project.template === 'upgrade' ? 'upgrade' : 
                             project.template === 'break-fix' ? 'break-fix' : '';
            
            const templateDisplay = (project.template || 'unknown').replace('-', ' ');
            
            card.innerHTML = `
                <div class="project-header">
                    <div class="project-info">
                        <div class="project-name">${escapeHtml(project.name || 'Unnamed Project')}</div>
                        <span class="project-type ${typeClass}">${escapeHtml(templateDisplay)}</span>
                    </div>
                    <div class="health-indicator ${health}"></div>
                </div>
                
                <div class="phase-timeline">
                    <div class="timeline-track">
                        <div class="timeline-progress" style="width: ${progress}%;"></div>
                    </div>
                    <div class="phase-indicators">
                        ${phases.map(p => {
                            // Phase dot should be:
                            // - completed: if all tasks in this phase are done
                            // - current: if this is the first incomplete phase
                            // - default: if it's a future phase
                            let dotClass = '';
                            if (phaseCompletion[p].isComplete) {
                                dotClass = 'completed';
                            } else if (p === currentPhase) {
                                dotClass = 'current';
                            }
                            
                            return `
                                <div class="phase-dot ${dotClass}">
                                    <span class="phase-label">P${p}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <div class="progress-section">
                    <div class="progress-ring-container">
                        <svg class="progress-ring" width="80" height="80">
                            <defs>
                                <linearGradient id="progress-gradient-${project.id}" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#22c55e;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#16a34a;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <circle class="progress-ring-bg" cx="40" cy="40" r="35"></circle>
                            <circle class="progress-ring-fill" cx="40" cy="40" r="35" 
                                    stroke="url(#progress-gradient-${project.id})"
                                    stroke-dasharray="${progress * 2.2} 220" stroke-dashoffset="0"></circle>
                        </svg>
                        <div class="progress-text">${progress}%</div>
                    </div>
                    
                    <div class="project-stats">
                        <div class="stat-item">
                            <span class="stat-value">${escapeHtml(project.manager || 'Unassigned')}</span>
                            <span class="stat-label">Project Manager</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${daysRemaining > 0 ? daysRemaining + ' days' : Math.abs(daysRemaining) + ' days overdue'}</span>
                            <span class="stat-label">Time Remaining</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${completedTasks} / ${totalTasks}</span>
                            <span class="stat-label">Tasks Complete</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">Phase ${currentPhase}</span>
                            <span class="stat-label">Current Phase</span>
                        </div>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <button class="action-btn" onclick="event.stopPropagation(); openProject('${project.id}')">
                        <span></span> View
                    </button>
                    <button class="action-btn" onclick="event.stopPropagation(); quickView('${project.id}')">
                        <span></span> Quick View
                    </button>
                    <button class="action-btn" onclick="event.stopPropagation(); cloneProject('${project.id}')">
                        <span></span> Clone
                    </button>
                    <button class="action-btn" onclick="event.stopPropagation(); exportProjectData('${project.id}')">
                        <span></span> Export
                    </button>
                </div>
            `;
            
            card.onclick = (e) => {
                if (e.target.closest('.action-btn')) return;
                selectProject(card, project.id);
            };
            
            return card;
        }

        function openProject(projectId) {
            if (!projectId) return;
            loadProject(projectId);
        }

        function quickView(projectId) {
            const project = projects[projectId];
            if (!project) {
                showNotification('Project not found', 'error');
                return;
            }
            
            const tasks = project.tasks || [];
            const completedTasks = tasks.filter(t => t && t.completed).length;
            const totalTasks = tasks.length;
            const atRisk = tasks.filter(t => t && t.health === 'red').length;
            
            // Calculate phase status
            const phases = [1, 2, 3, 4, 5];
            const phaseNames = ['Logistics', 'AV Setup', 'Installation', 'Testing', 'Closeout'];
            let phaseStatus = [];
            let currentPhase = 5;
            
            for (let i = 0; i < phases.length; i++) {
                const phase = phases[i];
                const phaseTasks = tasks.filter(t => t && t.phase === phase);
                if (phaseTasks.length > 0) {
                    const phaseComplete = phaseTasks.filter(t => t.completed).length;
                    const percentage = Math.round((phaseComplete / phaseTasks.length) * 100);
                    
                    if (percentage === 100) {
                        phaseStatus.push(` Phase ${phase} (${phaseNames[i]}): Complete`);
                    } else if (percentage > 0) {
                        phaseStatus.push(` Phase ${phase} (${phaseNames[i]}): ${percentage}% Complete`);
                        if (currentPhase === 5) currentPhase = phase; // First incomplete phase
                    } else {
                        phaseStatus.push(` Phase ${phase} (${phaseNames[i]}): Not Started`);
                        if (currentPhase === 5) currentPhase = phase; // First incomplete phase
                    }
                }
            }
            
            const details = ` Quick View: ${project.name || 'Unnamed Project'}
            
 Overall Progress: ${Math.round((completedTasks / totalTasks) * 100)}%
 Total Tasks: ${totalTasks}
 Completed: ${completedTasks}
 Remaining: ${totalTasks - completedTasks}
 At Risk: ${atRisk}

 Manager: ${project.manager || 'Unassigned'}
 Location: ${project.location || 'Not specified'}
 Target Date: ${project.targetDate || 'Not set'}
 Current Phase: ${currentPhase}

Phase Status:
${phaseStatus.join('\n')}

Click "View" to see detailed task list and Gantt chart!`;
            
            showNotification(details.replace(/\n/g, '<br>'), 'info');
        }

        function cloneProject(projectId) {
            const project = projects[projectId];
            if (!project) {
                showNotification('Project not found', 'error');
                return;
            }
            
            if (confirm(`Clone project "${project.name || 'Unnamed'}" as a template for a new project?`)) {
                showCreateProjectModal();
                
                const nameInput = document.getElementById('newProjectName');
                const managerInput = document.getElementById('newProjectManager');
                const locationInput = document.getElementById('newProjectLocation');
                
                if (nameInput) nameInput.value = `Copy of ${project.name || 'Unnamed'}`;
                if (managerInput) managerInput.value = project.manager || '';
                if (locationInput) locationInput.value = project.location || '';
                
                selectedTemplate = project.template || 'new-build';
                
                // Update template selection
                document.querySelectorAll('.template-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                const templateCards = document.querySelectorAll('.template-card');
                templateCards.forEach(card => {
                    if (card.onclick && card.onclick.toString().includes(selectedTemplate)) {
                        card.classList.add('selected');
                    }
                });
                
                showNotification('Project data copied to form', 'success');
            }
        }

        function exportProjectData(projectId) {
            const project = projects[projectId];
            if (!project) {
                showNotification('Project not found', 'error');
                return;
            }
            
            exportToExcel(project);
        }

        function selectProject(card, projectId) {
            if (!card || !projectId) return;
            
            document.querySelectorAll('.project-card').forEach(c => {
                if (c) c.style.border = '';
            });
            
            card.style.border = '3px solid var(--primary-500)';
            
            updateDashboardForProject(projectId);
            displayGanttChart(projectId);
        }

        function updateDashboardForProject(projectId) {
            const project = projects[projectId];
            if (!project) return;
            
            const subtitle = document.getElementById('dashboardSubtitle');
            if (subtitle) {
                subtitle.textContent = `Gantt Chart View: ${project.name || 'Unnamed'} - Timeline & Task Progress`;
            }
            
            const dashboard = document.getElementById('analyticsDashboard');
            if (dashboard) {
                dashboard.style.opacity = '0.5';
                setTimeout(() => {
                    dashboard.style.opacity = '1';
                }, 300);
            }
        }

        function displayGanttChart(projectId) {
            const project = projects[projectId];
            if (!project) return;
            
            const chartContainer = document.querySelector('.chart-container');
            if (chartContainer) {
                chartContainer.innerHTML = generateGanttChart(project);
                addGanttTooltips();
            }
        }

        function generateGanttChart(project) {
            if (!project) {
                return '<div class="chart-placeholder"><div> Invalid project data</div></div>';
            }
            
            const tasks = project.tasks || [];
            if (tasks.length === 0) {
                return '<div class="chart-placeholder"><div> No tasks available for this project</div></div>';
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let minDate = project.createdDate ? new Date(project.createdDate) : today;
            let maxDate = project.targetDate ? new Date(project.targetDate) : today;
            
            tasks.forEach(task => {
                if (task) {
                    if (task.startDate) {
                        const startDate = new Date(task.startDate);
                        if (startDate < minDate) minDate = startDate;
                    }
                    if (task.dueDate) {
                        const dueDate = new Date(task.dueDate);
                        if (dueDate > maxDate) maxDate = dueDate;
                    }
                }
            });
            
            minDate = new Date(minDate.getTime() - 7 * 24 * 60 * 60 * 1000);
            maxDate = new Date(maxDate.getTime() + 14 * 24 * 60 * 60 * 1000);
            
            const months = [];
            const currentMonth = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
            while (currentMonth <= maxDate) {
                months.push({
                    name: currentMonth.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }),
                    start: new Date(currentMonth),
                    end: new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0)
                });
                currentMonth.setMonth(currentMonth.getMonth() + 1);
            }
            
            const totalDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24));
            const pixelsPerDay = Math.max(3, 1200 / totalDays);
            const chartWidth = totalDays * pixelsPerDay;
            
            let html = `
                <div class="gantt-container">
                    <div class="gantt-header">
                        <div class="gantt-title"> Project Timeline: ${escapeHtml(project.name || 'Unnamed')}</div>
                        <div class="gantt-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--success-500);"></div>
                                <span>Completed</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--primary-500);"></div>
                                <span>In Progress</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--gray-400);"></div>
                                <span>Not Started</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--danger-500);"></div>
                                <span>Overdue</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="gantt-chart">
                        <div class="gantt-timeline-header" style="width: ${250 + chartWidth}px;">
            `;
            
            months.forEach(month => {
                const monthDays = Math.ceil((month.end - month.start) / (1000 * 60 * 60 * 24)) + 1;
                const monthWidth = monthDays * pixelsPerDay;
                html += `<div class="timeline-month" style="width: ${monthWidth}px;">${escapeHtml(month.name)}</div>`;
            });
            
            html += `
                        </div>
                        <div class="gantt-grid-lines" style="width: ${chartWidth}px;">
            `;
            
            const todayPosition = Math.max(0, Math.ceil((today - minDate) / (1000 * 60 * 60 * 24)) * pixelsPerDay);
            html += `<div class="grid-line today" style="left: ${todayPosition}px;"></div>`;
            
            let monthPosition = 0;
            months.forEach(month => {
                const monthDays = Math.ceil((month.end - month.start) / (1000 * 60 * 60 * 24)) + 1;
                const monthWidth = monthDays * pixelsPerDay;
                html += `<div class="grid-line" style="left: ${monthPosition}px;"></div>`;
                monthPosition += monthWidth;
            });
            
            html += `
                        </div>
                        <div class="gantt-rows">
            `;
            
            const phases = [1, 2, 3, 4, 5];
            const phaseNames = [
                'Phase 1: Logistics',
                'Phase 2: AV Setup',
                'Phase 3: Installation',
                'Phase 4: Testing',
                'Phase 5: Closeout'
            ];
            
            phases.forEach((phase, phaseIndex) => {
                const phaseTasks = tasks.filter(t => t && t.phase === phase);
                const phaseCompleted = phaseTasks.length > 0 && phaseTasks.every(t => t.completed);
                const phaseInProgress = phaseTasks.some(t => t.status === 'in-progress' || (t.completed === false && t.status !== 'not-started'));
                
                html += `
                    <div class="gantt-row phase-header">
                        <div class="gantt-task-name">
                            ${escapeHtml(phaseNames[phaseIndex])}
                            ${phaseCompleted ? ' ' : phaseInProgress ? ' ' : ''}
                        </div>
                        <div class="gantt-task-bar-container" style="width: ${chartWidth}px;"></div>
                    </div>
                `;
                
                phaseTasks.forEach(task => {
                    if (!task) return;
                    
                    const startDate = task.startDate ? new Date(task.startDate) : today;
                    const dueDate = task.dueDate ? new Date(task.dueDate) : new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                    
                    const startPosition = Math.max(0, Math.ceil((startDate - minDate) / (1000 * 60 * 60 * 24)) * pixelsPerDay);
                    const duration = Math.max(1, Math.ceil((dueDate - startDate) / (1000 * 60 * 60 * 24)));
                    const barWidth = duration * pixelsPerDay;
                    
                    let statusClass = 'not-started';
                    let progressPercent = 0;
                    
                    if (task.completed || task.status === 'completed') {
                        statusClass = 'completed';
                        progressPercent = 100;
                    } else if (task.status === 'in-progress') {
                        statusClass = 'in-progress';
                        progressPercent = 50;
                    } else if (dueDate < today && !task.completed) {
                        statusClass = 'overdue';
                    }
                    
                    html += `
                        <div class="gantt-row">
                            <div class="gantt-task-name" title="${escapeHtml(task.name || '')}">${escapeHtml(task.name || 'Unnamed Task')}</div>
                            <div class="gantt-task-bar-container" style="width: ${chartWidth}px;">
                                <div class="gantt-task-bar ${statusClass}" 
                                     style="left: ${startPosition}px; width: ${barWidth}px;"
                                     data-task-name="${escapeHtml(task.name || '')}"
                                     data-start="${startDate.toLocaleDateString()}"
                                     data-due="${dueDate.toLocaleDateString()}"
                                     data-status="${task.status || 'not-started'}"
                                     data-owner="${escapeHtml(task.assignedTo || 'Unassigned')}"
                                     data-priority="${task.priority || 'medium'}">
                                    ${progressPercent > 0 ? `<div class="gantt-task-progress" style="width: ${progressPercent}%;"></div>` : ''}
                                    <span class="gantt-task-label">${escapeHtml(task.assignedTo || '')}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                if (phaseTasks.length === 0) {
                    html += `
                        <div class="gantt-row">
                            <div class="gantt-task-name" style="color: var(--gray-400); font-style: italic;">No tasks</div>
                            <div class="gantt-task-bar-container" style="width: ${chartWidth}px;"></div>
                        </div>
                    `;
                }
            });
            
            html += `
                        </div>
                    </div>
                </div>
                <div class="gantt-tooltip">
                    <div class="tooltip-title"></div>
                    <div class="tooltip-info"></div>
                </div>
            `;
            
            return html;
        }

        function addGanttTooltips() {
            const taskBars = document.querySelectorAll('.gantt-task-bar');
            const tooltip = document.querySelector('.gantt-tooltip');
            
            if (!tooltip) return;
            
            taskBars.forEach(bar => {
                if (!bar) return;
                
                bar.addEventListener('mouseenter', (e) => {
                    const name = bar.dataset.taskName || '';
                    const start = bar.dataset.start || '';
                    const due = bar.dataset.due || '';
                    const status = bar.dataset.status || '';
                    const owner = bar.dataset.owner || '';
                    const priority = bar.dataset.priority || '';
                    
                    const titleEl = tooltip.querySelector('.tooltip-title');
                    const infoEl = tooltip.querySelector('.tooltip-info');
                    
                    if (titleEl) titleEl.textContent = name;
                    if (infoEl) {
                        infoEl.innerHTML = `
                            <div class="tooltip-row">
                                <span>Owner:</span>
                                <span>${owner}</span>
                            </div>
                            <div class="tooltip-row">
                                <span>Status:</span>
                                <span>${status.replace('-', ' ')}</span>
                            </div>
                            <div class="tooltip-row">
                                <span>Priority:</span>
                                <span>${priority}</span>
                            </div>
                            <div class="tooltip-row">
                                <span>Start:</span>
                                <span>${start}</span>
                            </div>
                            <div class="tooltip-row">
                                <span>Due:</span>
                                <span>${due}</span>
                            </div>
                        `;
                    }
                    
                    const rect = bar.getBoundingClientRect();
                    const containerEl = document.querySelector('.gantt-container');
                    if (containerEl) {
                        const containerRect = containerEl.getBoundingClientRect();
                        
                        tooltip.style.left = `${rect.left - containerRect.left + rect.width / 2}px`;
                        tooltip.style.top = `${rect.top - containerRect.top - 80}px`;
                        tooltip.classList.add('active');
                    }
                });
                
                bar.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('active');
                });
                
                bar.addEventListener('click', () => {
                    const projectId = Object.keys(projects).find(id => {
                        const project = projects[id];
                        return project && project.tasks && project.tasks.some(t => t && t.name === bar.dataset.taskName);
                    });
                    if (projectId) {
                        loadProject(projectId);
                    }
                });
            });
        }

        // ==================== DASHBOARD METRICS WITH NULL CHECKS ====================
        function updateDashboardMetrics() {
            const projectList = Object.values(projects || {}).filter(p => p);
            
            const totalProjectsEl = document.getElementById('totalProjects');
            if (totalProjectsEl) {
                totalProjectsEl.textContent = projectList.length;
            }
            
            const activeProjects = projectList.filter(p => {
                // A project is active if it has incomplete tasks
                const tasks = p.tasks || [];
                return tasks.some(t => t && !t.completed);
            });
            const activeProjectsEl = document.getElementById('activeProjects');
            if (activeProjectsEl) {
                activeProjectsEl.textContent = activeProjects.length;
            }
            
            let totalProgress = 0;
            projectList.forEach(project => {
                const tasks = project.tasks || [];
                const completed = tasks.filter(t => t && t.completed).length;
                const total = tasks.length;
                totalProgress += total > 0 ? (completed / total) : 0;
            });
            
            const avgProgress = projectList.length > 0 ? Math.round((totalProgress / projectList.length) * 100) : 0;
            const completionRateEl = document.getElementById('completionRate');
            if (completionRateEl) {
                completionRateEl.textContent = avgProgress + '%';
            }
            
            let atRiskCount = 0;
            projectList.forEach(project => {
                const tasks = project.tasks || [];
                const hasRedTasks = tasks.some(t => t && t.health === 'red');
                // Also check if project is overdue
                const targetDate = project.targetDate ? new Date(project.targetDate) : null;
                const today = new Date();
                const isOverdue = targetDate && targetDate < today;
                
                if (hasRedTasks || isOverdue) atRiskCount++;
            });
            
            const atRiskCountEl = document.getElementById('atRiskCount');
            if (atRiskCountEl) {
                atRiskCountEl.textContent = atRiskCount;
            }
            
            let dueSoon = 0;
            const nextWeek = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
            projectList.forEach(project => {
                if (project.targetDate) {
                    const targetDate = new Date(project.targetDate);
                    if (targetDate <= nextWeek && targetDate >= new Date()) {
                        dueSoon++;
                    }
                }
            });
            
            const dueSoonEl = document.getElementById('dueSoon');
            if (dueSoonEl) {
                dueSoonEl.textContent = dueSoon;
            }
            
            // Calculate actual team utilization based on active tasks
            let totalActiveTasks = 0;
            let totalAssignedTasks = 0;
            activeProjects.forEach(project => {
                const tasks = project.tasks || [];
                const activeTasks = tasks.filter(t => t && !t.completed);
                totalActiveTasks += activeTasks.length;
                totalAssignedTasks += activeTasks.filter(t => t.assignedTo && t.assignedTo.trim()).length;
            });
            
            const utilizationPercent = totalActiveTasks > 0 
                ? Math.round((totalAssignedTasks / totalActiveTasks) * 100)
                : 0;
            
            const teamUtilizationEl = document.getElementById('teamUtilization');
            if (teamUtilizationEl) {
                teamUtilizationEl.textContent = utilizationPercent + '%';
            }
            
            updateProjectCount();
        }

        function updateProjectCount() {
            const count = document.querySelectorAll('.project-card:not([style*="display: none"])').length;
            const projectCountEl = document.getElementById('projectCount');
            if (projectCountEl) {
                projectCountEl.textContent = `${count} project${count !== 1 ? 's' : ''}`;
            }
        }

        // ==================== TRACKER FUNCTIONS WITH NULL CHECKS ====================
        function updateAllProgress() {
            if (!currentProjectId) {
                debugLog('Warning: updateAllProgress called without currentProjectId');
                return;
            }
            
            const project = projects[currentProjectId];
            if (!project) {
                debugLog('Warning: Project not found for progress update');
                return;
            }
            
            const phases = [1, 2, 3, 4, 5];
            let totalTasks = 0;
            let completedTasks = 0;
            
            phases.forEach(phase => {
                const phaseTasks = (project.tasks || []).filter(t => t && t.phase === phase);
                const completed = phaseTasks.filter(t => t && t.completed).length;
                const total = phaseTasks.length;
                const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
                
                const progressElement = document.getElementById(`phase${phase}Progress`);
                const progressTextElement = document.getElementById(`phase${phase}ProgressText`);
                
                if (progressElement) progressElement.textContent = `${percentage}%`;
                if (progressTextElement) {
                    // Add visual indicator for phase status
                    let statusText = `Progress: ${percentage}%`;
                    if (percentage === 100 && total > 0) {
                        statusText = ` Complete (${percentage}%)`;
                    } else if (percentage > 0) {
                        statusText = ` In Progress (${percentage}%)`;
                    } else if (total === 0) {
                        statusText = `No tasks`;
                    } else {
                        statusText = ` Not Started (${percentage}%)`;
                    }
                    progressTextElement.textContent = statusText;
                }
                
                totalTasks += total;
                completedTasks += completed;
            });
            
            const overallPercentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            const overallElement = document.getElementById('overallProgress');
            if (overallElement) overallElement.textContent = `${overallPercentage}%`;
            
            project.overallProgress = overallPercentage;
            
            // Update the project cards if we're on the dashboard
            if (document.getElementById('landingPage').classList.contains('active')) {
                renderProjects();
            }
            
            saveProjects();
        }

        async function saveProject() {
            if (!currentProjectId) {
                showNotification('No project selected', 'warning');
                return;
            }
            
            const saveBtn = document.getElementById('saveProjectBtn');
            if (saveBtn) {
                setLoadingState(saveBtn, true, 'Saving...');
            }
            
            try {
                await saveProjects();
                
                if (saveBtn) {
                    setLoadingState(saveBtn, false);
                    saveBtn.innerHTML = ' Saved';
                    setTimeout(() => {
                        saveBtn.innerHTML = ' Save Project';
                    }, 2000);
                }
            } catch (error) {
                console.error('Save error:', error);
                if (saveBtn) {
                    setLoadingState(saveBtn, false);
                    saveBtn.innerHTML = ' Error';
                    setTimeout(() => {
                        saveBtn.innerHTML = ' Save Project';
                    }, 2000);
                }
            }
        }

        function exportProject() {
            if (!currentProjectId) {
                showNotification('No project selected', 'warning');
                return;
            }
            
            const project = projects[currentProjectId];
            if (project) {
                exportToExcel(project);
            }
        }

        function exportToExcel(project) {
            if (!project) {
                // Export all projects
                const allTasks = [];
                Object.values(projects || {}).forEach(proj => {
                    if (proj && proj.tasks) {
                        proj.tasks.forEach(task => {
                            if (task) {
                                allTasks.push({
                                    project: proj.name || 'Unnamed',
                                    ...task
                                });
                            }
                        });
                    }
                });
                
                if (allTasks.length === 0) {
                    showNotification('No projects to export', 'warning');
                    return;
                }
                
                const headers = ['Project', 'Task Name', 'Phase', 'Owner', 'Priority', 'Status', 'Health', 'Start Date', 'Due Date', 'Notes'];
                const csvContent = [
                    headers.join(','),
                    ...allTasks.map(task => [
                        `"${task.project}"`,
                        `"${task.name || ''}"`,
                        task.phase || '',
                        `"${task.assignedTo || ''}"`,
                        task.priority || '',
                        task.status || '',
                        task.health || '',
                        task.startDate || '',
                        task.dueDate || '',
                        `"${(task.notes || '').replace(/"/g, '""')}"`
                    ].join(','))
                ].join('\n');
                
                downloadCSV(csvContent, 'all-projects');
            } else {
                // Export single project
                const tasks = project.tasks || [];
                const headers = ['Task Name', 'Phase', 'Owner', 'Priority', 'Status', 'Health', 'Start Date', 'Due Date', 'Notes', 'Completed'];
                const csvContent = [
                    headers.join(','),
                    ...tasks.map(task => task ? [
                        `"${task.name || ''}"`,
                        task.phase || '',
                        `"${task.assignedTo || ''}"`,
                        task.priority || '',
                        task.status || '',
                        task.health || '',
                        task.startDate || '',
                        task.dueDate || '',
                        `"${(task.notes || '').replace(/"/g, '""')}"`,
                        task.completed ? 'Yes' : 'No'
                    ].join(',') : '').filter(row => row)
                ].join('\n');
                
                const filename = (project.name || 'project').toLowerCase().replace(/\s+/g, '-');
                downloadCSV(csvContent, filename);
            }
            
            showNotification('Export successful', 'success');
        }

        function downloadCSV(content, filename) {
            try {
                const blob = new Blob([content], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Download error:', error);
                showNotification('Error downloading file', 'error');
            }
        }

        function exportAllProjects() {
            exportToExcel(null);
        }

        // ==================== UI HELPERS WITH NULL CHECKS ====================
        function updatePriorityClass(select) {
            if (!select) return;
            select.className = `priority-select priority-${select.value || 'medium'}`;
        }

        function updateStatusClass(select) {
            if (!select) return;
            select.className = `status-select status-${select.value || 'not-started'}`;
        }

        function toggleHealthDropdown(light) {
            if (!light) return;
            
            // Close all other dropdowns
            document.querySelectorAll('.health-dropdown').forEach(dropdown => {
                if (dropdown && dropdown !== light.nextElementSibling) {
                    dropdown.classList.remove('active');
                }
            });
            
            const dropdown = light.nextElementSibling;
            if (dropdown) {
                dropdown.classList.toggle('active');
            }
        }

        function setHealth(option, health, taskId) {
            if (!option) return;
            
            const container = option.closest('.health-light-container');
            if (!container) return;
            
            const light = container.querySelector('.health-light');
            const dropdown = container.querySelector('.health-dropdown');
            
            if (light) {
                light.className = `health-light ${health || 'green'}`;
                light.setAttribute('data-health', health || 'green');
            }
            
            if (dropdown) {
                dropdown.classList.remove('active');
            }
            
            if (taskId && currentProjectId) {
                updateTaskField(taskId, 'health', health);
            }
        }

        // Close health dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.health-light-container')) {
                document.querySelectorAll('.health-dropdown').forEach(dropdown => {
                    if (dropdown) {
                        dropdown.classList.remove('active');
                    }
                });
            }
        });

        // ==================== SEARCH AND FILTER WITH NULL CHECKS ====================
        function searchProjects() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.toLowerCase();
            const cards = document.querySelectorAll('.project-card');
            
            cards.forEach(card => {
                if (!card) return;
                
                const nameEl = card.querySelector('.project-name');
                const managerEl = card.querySelector('.stat-value');
                
                const projectName = nameEl ? nameEl.textContent.toLowerCase() : '';
                const projectManager = managerEl ? managerEl.textContent.toLowerCase() : '';
                
                if (projectName.includes(searchTerm) || projectManager.includes(searchTerm)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
            
            updateProjectCount();
        }

        function filterProjects() {
            const typeFilter = document.getElementById('typeFilter');
            const statusFilter = document.getElementById('statusFilter');
            const phaseFilter = document.getElementById('phaseFilterDashboard');
            
            const typeValue = typeFilter ? typeFilter.value : 'all';
            const statusValue = statusFilter ? statusFilter.value : 'all';
            const phaseValue = phaseFilter ? phaseFilter.value : 'all';
            
            const cards = document.querySelectorAll('.project-card');
            
            cards.forEach(card => {
                if (!card) return;
                
                let show = true;
                const projectId = card.getAttribute('data-project-id');
                const project = projectId ? projects[projectId] : null;
                
                if (!project) {
                    card.style.display = 'none';
                    return;
                }
                
                if (typeValue !== 'all') {
                    if (project.template !== typeValue) show = false;
                }
                
                if (statusValue !== 'all' && show) {
                    const tasks = project.tasks || [];
                    
                    if (statusValue === 'at-risk') {
                        // At risk if has red health tasks OR is overdue
                        const hasRedTasks = tasks.some(t => t && t.health === 'red');
                        const targetDate = project.targetDate ? new Date(project.targetDate) : null;
                        const isOverdue = targetDate && targetDate < new Date();
                        if (!hasRedTasks && !isOverdue) show = false;
                    } else if (statusValue === 'on-track') {
                        // On track if no red tasks AND not overdue
                        const hasRedTasks = tasks.some(t => t && t.health === 'red');
                        const targetDate = project.targetDate ? new Date(project.targetDate) : null;
                        const isOverdue = targetDate && targetDate < new Date();
                        if (hasRedTasks || isOverdue) show = false;
                    } else if (statusValue === 'completed') {
                        // Completed if all tasks are done
                        const allComplete = tasks.every(t => !t || t.completed);
                        if (!allComplete) show = false;
                    } else if (statusValue === 'active') {
                        // Active if has incomplete tasks
                        const hasIncompleteTasks = tasks.some(t => t && !t.completed);
                        if (!hasIncompleteTasks) show = false;
                    }
                }
                
                if (phaseValue !== 'all' && show) {
                    const tasks = project.tasks || [];
                    
                    // Determine actual current phase based on completion
                    const phases = [1, 2, 3, 4, 5];
                    let currentPhase = 5;
                    
                    for (let phase of phases) {
                        const phaseTasks = tasks.filter(t => t && t.phase === phase);
                        if (phaseTasks.length > 0) {
                            const allComplete = phaseTasks.every(t => t.completed);
                            if (!allComplete) {
                                currentPhase = phase;
                                break;
                            }
                        }
                    }
                    
                    if (currentPhase !== parseInt(phaseValue)) show = false;
                }
                
                card.style.display = show ? '' : 'none';
            });
            
            updateProjectCount();
        }

        function filterTrackerTasks() {
            const viewFilterEl = document.getElementById('viewFilter');
            const phaseFilterEl = document.getElementById('phaseFilter');
            
            const viewFilter = viewFilterEl ? viewFilterEl.value : 'all';
            const phaseFilter = phaseFilterEl ? phaseFilterEl.value : 'all';
            
            const rows = document.querySelectorAll('#taskTableBody tr');
            
            let currentPhase = null;
            
            rows.forEach(row => {
                if (!row) return;
                
                if (row.classList.contains('phase-header')) {
                    const phaseText = row.textContent || '';
                    if (phaseText.includes('PHASE 1')) currentPhase = '1';
                    else if (phaseText.includes('PHASE 2')) currentPhase = '2';
                    else if (phaseText.includes('PHASE 3')) currentPhase = '3';
                    else if (phaseText.includes('PHASE 4')) currentPhase = '4';
                    else if (phaseText.includes('PHASE 5')) currentPhase = '5';
                    
                    if (phaseFilter === 'all' || phaseFilter === currentPhase) {
                        row.classList.remove('hidden');
                    } else {
                        row.classList.add('hidden');
                    }
                    return;
                }
                
                let showRow = true;
                
                if (phaseFilter !== 'all') {
                    const checkbox = row.querySelector('.task-checkbox');
                    if (checkbox) {
                        const taskPhase = checkbox.getAttribute('data-phase');
                        if (taskPhase !== phaseFilter) {
                            showRow = false;
                        }
                    }
                }
                
                if (viewFilter !== 'all' && showRow) {
                    const checkbox = row.querySelector('.task-checkbox');
                    const statusSelect = row.querySelector('.status-select');
                    const prioritySelect = row.querySelector('.priority-select');
                    const dueDateInput = row.querySelector('td:nth-child(9) input');
                    
                    const isComplete = checkbox ? checkbox.checked : false;
                    const status = statusSelect ? statusSelect.value : '';
                    const priority = prioritySelect ? prioritySelect.value : '';
                    
                    switch(viewFilter) {
                        case 'incomplete':
                            showRow = !isComplete;
                            break;
                        case 'complete':
                            showRow = isComplete;
                            break;
                        case 'critical':
                            showRow = priority === 'critical';
                            break;
                        case 'overdue':
                            if (dueDateInput && dueDateInput.value) {
                                const due = new Date(dueDateInput.value);
                                const today = new Date();
                                today.setHours(0, 0, 0, 0);
                                showRow = due < today && !isComplete;
                            } else {
                                showRow = false;
                            }
                            break;
                    }
                }
                
                if (showRow) {
                    row.classList.remove('hidden');
                } else {
                    row.classList.add('hidden');
                }
            });
            
            updateAllProgress();
        }

        // ==================== MODAL FUNCTIONS WITH NULL CHECKS ====================
        function showCreateProjectModal() {
            const modal = document.getElementById('createProjectModal');
            if (modal) {
                modal.classList.add('active');
            }
            
            const nameInput = document.getElementById('newProjectName');
            if (nameInput) {
                nameInput.focus();
            }
        }

        function closeModal() {
            // Close all active modals
            document.querySelectorAll('.modal.active').forEach(modal => {
                modal.classList.remove('active');
            });
            
            // Reset create project button state
            const createBtn = document.getElementById('createProjectBtn');
            if (createBtn) {
                createBtn.disabled = false;
                createBtn.innerHTML = 'Create Project';
            }
            
            // Clear form errors
            document.querySelectorAll('.form-error').forEach(el => {
                if (el) {
                    el.style.display = 'none';
                    el.textContent = '';
                }
            });
        }

        function selectTemplate(card, template) {
            if (!card || !template) return;
            
            document.querySelectorAll('.template-card').forEach(c => {
                if (c) c.classList.remove('selected');
            });
            
            card.classList.add('selected');
            selectedTemplate = template;
        }

        async function refreshDashboard() {
            const btn = event.target ? event.target.closest('button') : null;
            if (!btn) return;
            
            const loader = btn.querySelector('.loading');
            if (loader) {
                loader.style.display = 'inline-block';
            }
            
            try {
                await loadProjects();
                const chartContainer = document.querySelector('.chart-container');
                if (chartContainer) {
                    chartContainer.innerHTML = '<div class="chart-placeholder"><div> Interactive charts will appear here when a project is selected</div></div>';
                }
                showNotification('Dashboard refreshed', 'success');
            } finally {
                if (loader) {
                    loader.style.display = 'none';
                }
            }
        }

        // Close modal when clicking outside
        const createProjectModal = document.getElementById('createProjectModal');
        if (createProjectModal) {
            createProjectModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        }

        // Handle browser back/forward
        window.addEventListener('popstate', function(e) {
            try {
                if (e.state && e.state.project) {
                    loadProject(e.state.project);
                } else {
                    showLandingPage();
                }
            } catch (error) {
                debugLog('Popstate error in restricted environment', error);
            }
        });

        // Auto-save when online
        setInterval(() => {
            if (isOnline && currentProjectId) {
                try {
                    saveProjects();
                } catch (error) {
                    debugLog('Auto-save failed', error);
                }
            }
        }, 60000);
        
        // ==================== EXECUTIVE REPORTING MODULE ====================
        
        // Global variables for reporting
        let selectedReportType = 'executive-summary';
        let selectedReportPeriod = 'current-month';
        let reportStartDate = null;
        let reportEndDate = null;
        
        // Time period selection functions
        function selectReportPeriod(element, period) {
            // Remove selected class from all period cards
            document.querySelectorAll('#executiveReportingModal [onclick*="selectReportPeriod"] .template-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selected class to clicked card
            element.classList.add('selected');
            selectedReportPeriod = period;
            
            // Handle custom date range
            const customRange = document.getElementById('customDateRange');
            if (period === 'custom') {
                customRange.style.display = 'block';
                // Set default dates for custom range
                const today = new Date();
                const monthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                document.getElementById('reportStartDate').value = monthAgo.toISOString().split('T')[0];
                document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
            } else {
                customRange.style.display = 'none';
                // Calculate start and end dates for predefined periods
                const dates = calculatePeriodDates(period);
                reportStartDate = dates.start;
                reportEndDate = dates.end;
            }
            
            // Update portfolio metrics for new period
            updatePortfolioMetrics();
            
            debugLog('Report period selected:', period);
        }
        
        // Calculate start and end dates for predefined periods
        function calculatePeriodDates(period) {
            const today = new Date();
            let start, end;
            
            switch (period) {
                case 'current-month':
                    start = new Date(today.getFullYear(), today.getMonth(), 1);
                    end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'last-month':
                    start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    end = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
                case 'current-quarter':
                    const currentQuarter = Math.floor(today.getMonth() / 3);
                    start = new Date(today.getFullYear(), currentQuarter * 3, 1);
                    end = new Date(today.getFullYear(), (currentQuarter + 1) * 3, 0);
                    break;
                case 'last-quarter':
                    const lastQuarter = Math.floor(today.getMonth() / 3) - 1;
                    const year = lastQuarter < 0 ? today.getFullYear() - 1 : today.getFullYear();
                    const quarter = lastQuarter < 0 ? 3 : lastQuarter;
                    start = new Date(year, quarter * 3, 1);
                    end = new Date(year, (quarter + 1) * 3, 0);
                    break;
                case 'current-year':
                    start = new Date(today.getFullYear(), 0, 1);
                    end = new Date(today.getFullYear(), 11, 31);
                    break;
                default:
                    start = new Date(today.getFullYear(), today.getMonth(), 1);
                    end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            }
            
            return {
                start: start.toISOString(),
                end: end.toISOString()
            };
        }
        
        // Update period labels in the UI
        function updatePeriodLabels() {
            const today = new Date();
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            // Current month
            const currentMonthLabel = document.getElementById('currentMonthLabel');
            if (currentMonthLabel) {
                currentMonthLabel.textContent = monthNames[today.getMonth()] + ' ' + today.getFullYear();
            }
            
            // Last month
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const lastMonthLabel = document.getElementById('lastMonthLabel');
            if (lastMonthLabel) {
                lastMonthLabel.textContent = monthNames[lastMonth.getMonth()] + ' ' + lastMonth.getFullYear();
            }
            
            // Current quarter
            const currentQuarter = Math.floor(today.getMonth() / 3) + 1;
            const currentQuarterLabel = document.getElementById('currentQuarterLabel');
            if (currentQuarterLabel) {
                currentQuarterLabel.textContent = 'Q' + currentQuarter + ' ' + today.getFullYear();
            }
            
            // Last quarter
            const lastQuarterNum = currentQuarter === 1 ? 4 : currentQuarter - 1;
            const lastQuarterYear = currentQuarter === 1 ? today.getFullYear() - 1 : today.getFullYear();
            const lastQuarterLabel = document.getElementById('lastQuarterLabel');
            if (lastQuarterLabel) {
                lastQuarterLabel.textContent = 'Q' + lastQuarterNum + ' ' + lastQuarterYear;
            }
            
            // Current year
            const currentYearLabel = document.getElementById('currentYearLabel');
            if (currentYearLabel) {
                currentYearLabel.textContent = today.getFullYear().toString();
            }
        }
        
        // Show executive reporting modal
        function showExecutiveReporting() {
            const modal = document.getElementById('executiveReportingModal');
            if (modal) {
                modal.classList.add('active');
                
                // Show landing page, hide all report pages
                showReportsLanding();
                
                // Update quick metrics for landing page
                updateQuickMetrics();
            }
        }

        // Show the reports landing page
        function showReportsLanding() {
            document.getElementById('reportsLandingPage').style.display = 'block';
            document.getElementById('executiveSummaryReport').style.display = 'none';
            document.getElementById('portfolioAnalysisReport').style.display = 'none';
            document.getElementById('resourceUtilizationReport').style.display = 'none';
            document.getElementById('riskAssessmentReport').style.display = 'none';
            document.getElementById('trendAnalysisReport').style.display = 'none';
            document.getElementById('projectDetailsReport').style.display = 'none';
        }

        // Show individual visual report
        function showVisualReport(reportType) {
            // Hide landing page
            document.getElementById('reportsLandingPage').style.display = 'none';
            
            // Hide all report pages first
            showReportsLanding();
            
            switch (reportType) {
                case 'executive-summary':
                    document.getElementById('executiveSummaryReport').style.display = 'block';
                    initializeExecutiveSummaryReport();
                    break;
                case 'portfolio-analysis':
                    document.getElementById('portfolioAnalysisReport').style.display = 'block';
                    initializePortfolioAnalysisReport();
                    break;
                case 'resource-utilization':
                    document.getElementById('resourceUtilizationReport').style.display = 'block';
                    initializeResourceUtilizationReport();
                    break;
                case 'risk-assessment':
                    document.getElementById('riskAssessmentReport').style.display = 'block';
                    initializeRiskAssessmentReport();
                    break;
                case 'trend-analysis':
                    document.getElementById('trendAnalysisReport').style.display = 'block';
                    initializeTrendAnalysisReport();
                    break;
                case 'project-details':
                    document.getElementById('projectDetailsReport').style.display = 'block';
                    initializeProjectDetailsReport();
                    break;
                default:
                    document.getElementById('reportsLandingPage').style.display = 'block';
            }
        }

        // Back to reports landing page
        function backToReportsLanding() {
            showReportsLanding();
        }

        // Update quick metrics for landing page
        function updateQuickMetrics() {
            try {
                const projectList = Object.values(projects);
                const allTasks = [];
                
                projectList.forEach(project => {
                    if (project && project.tasks) {
                        allTasks.push(...project.tasks.filter(task => task));
                    }
                });

                const totalProjects = projectList.length;
                const activeProjects = projectList.filter(p => p && p.tasks && p.tasks.some(t => t && !t.completed)).length;
                const totalTasks = allTasks.length;
                const completedTasks = allTasks.filter(task => task.completed).length;
                const overallProgress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                
                // Calculate at-risk projects
                const atRiskProjects = projectList.filter(project => {
                    if (!project || !project.tasks) return false;
                    const projectTasks = project.tasks.filter(task => task);
                    const overdueTasks = projectTasks.filter(task => {
                        const dueDate = new Date(task.dueDate);
                        return dueDate < new Date() && !task.completed;
                    }).length;
                    const completedCount = projectTasks.filter(task => task.completed).length;
                    const progress = projectTasks.length > 0 ? (completedCount / projectTasks.length) * 100 : 0;
                    return overdueTasks > 0 || progress < 50;
                }).length;

                // Update UI
                document.getElementById('quickTotalProjects').textContent = totalProjects;
                document.getElementById('quickActiveProjects').textContent = activeProjects;
                document.getElementById('quickOverallProgress').textContent = overallProgress + '%';
                document.getElementById('quickTotalTasks').textContent = totalTasks;
                document.getElementById('quickCompletedTasks').textContent = completedTasks;
                document.getElementById('quickAtRiskProjects').textContent = atRiskProjects;

            } catch (error) {
                console.error('Error updating quick metrics:', error);
            }
        }

        // Initialize Executive Summary Report
        function initializeExecutiveSummaryReport() {
            try {
                // Set default time period
                selectedReportPeriod = 'current-month';
                
                // Calculate period dates
                const dates = calculatePeriodDates(selectedReportPeriod);
                reportStartDate = dates.start;
                reportEndDate = dates.end;
                
                // Update period description
                updatePeriodDescription();
                
                // Load report data
                updateExecutiveSummaryData();
                
            } catch (error) {
                console.error('Error initializing executive summary report:', error);
                // Don't show notifications - individual functions handle their own errors gracefully
            }
        }

        // Update period description
        function updatePeriodDescription() {
            const description = document.getElementById('periodDescription');
            if (description) {
                if (selectedReportPeriod === 'custom') {
                    const startDate = document.getElementById('reportStartDateVisual')?.value || 'Not set';
                    const endDate = document.getElementById('reportEndDateVisual')?.value || 'Not set';
                    description.textContent = `Custom period: ${startDate} to ${endDate}`;
                } else {
                    const dates = calculatePeriodDates(selectedReportPeriod);
                    description.textContent = `${dates.start.toLocaleDateString()} to ${dates.end.toLocaleDateString()}`;
                }
            }
        }

        // Select time period for visual reports
        function selectTimePeriod(element, period) {
            // Remove selected class from all period buttons
            document.querySelectorAll('.btn.small').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Add selected class to clicked button
            element.classList.add('selected');
            selectedReportPeriod = period;
            
            // Handle custom date range
            const customRange = document.getElementById('customDateRangeReport');
            if (period === 'custom') {
                customRange.style.display = 'block';
                // Set default dates
                const today = new Date();
                const monthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                document.getElementById('reportStartDateVisual').value = monthAgo.toISOString().split('T')[0];
                document.getElementById('reportEndDateVisual').value = today.toISOString().split('T')[0];
            } else {
                customRange.style.display = 'none';
                // Calculate period dates
                const dates = calculatePeriodDates(period);
                reportStartDate = dates.start;
                reportEndDate = dates.end;
            }
            
            // Update report data
            updatePeriodDescription();
            updateExecutiveSummaryData();
        }

        // Update visual report data
        function updateVisualReport() {
            updatePeriodDescription();
            updateExecutiveSummaryData();
        }

        // Update Executive Summary Report Data
        function updateExecutiveSummaryData() {
            try {
                // Get portfolio analysis data (uses the time filtering we already built)
                const data = generatePortfolioAnalysis();
                
                if (!data || !data.summary) {
                    console.warn('Executive summary: No data available');
                    return;
                }
                
                // Update KPI cards with safety checks
                const updateElement = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    }
                };
                
                // Safely update elements with fallbacks
                updateElement('execTotalProjects', data.summary.totalProjects || 0);
                updateElement('execPortfolioProgress', (data.summary.overallProgress || 0) + '%');
                
                // Use safe calculation functions
                try {
                    updateElement('execOnTimeDelivery', calculateOnTimeDelivery(data) + '%');
                } catch (e) {
                    updateElement('execOnTimeDelivery', '0%');
                }
                
                try {
                    updateElement('execResourceUtil', calculateResourceUtilization(data) + '%');
                } catch (e) {
                    updateElement('execResourceUtil', '0%');
                }
                
                updateElement('execCriticalRisks', data.summary.criticalRisks || 0);
                
                try {
                    updateElement('execAvgVelocity', calculateAvgVelocity(data) || '0');
                } catch (e) {
                    updateElement('execAvgVelocity', '0');
                }

                // Update health status
                updateHealthStatus(data);
                
                // Update risk assessment
                updateRiskAssessment(data);
                
                // Update project lists
                updateProjectLists(data);
                
                // Add trends (placeholder for now)
                updateTrends();
                
            } catch (error) {
                console.error('Error updating executive summary data:', error);
                // Only show notification for critical infrastructure errors, not data calculation errors
                if (error.message && error.message.includes('generatePortfolioAnalysis')) {
                    showNotification('error', 'Failed to update report data');
                }
            }
        }

        // Calculate on-time delivery rate
        function calculateOnTimeDelivery(data) {
            const completedProjects = data.projects.filter(p => p.progress === 100);
            if (completedProjects.length === 0) return 0;
            
            const onTimeProjects = completedProjects.filter(p => p.onTimeRate >= 80);
            return Math.round((onTimeProjects.length / completedProjects.length) * 100);
        }

        // Calculate resource utilization
        function calculateResourceUtilization(data) {
            const teamMembers = Object.keys(data.teamWorkload || {});
            if (teamMembers.length === 0) return 0;
            
            const totalCapacity = teamMembers.length * 40; // Assume 40 hours per week
            const totalWorkload = Object.values(data.teamWorkload || {}).reduce((sum, member) => sum + member.total, 0);
            
            return Math.min(100, Math.round((totalWorkload / totalCapacity) * 100));
        }

        // Calculate average velocity
        function calculateAvgVelocity(data) {
            const projects = data.projects.filter(p => p.velocity > 0);
            if (projects.length === 0) return '0.0';
            
            const avgVelocity = projects.reduce((sum, p) => sum + p.velocity, 0) / projects.length;
            return (Math.round(avgVelocity * 10) / 10).toFixed(1);
        }

        // Update health status visualization
        function updateHealthStatus(data) {
            if (!data || !data.projects) {
                console.warn('Health status: No project data available');
                return;
            }
            
            const greenProjects = data.projects.filter(p => p.health === 'Green').length;
            const yellowProjects = data.projects.filter(p => p.health === 'Yellow').length;
            const redProjects = data.projects.filter(p => p.health === 'Red').length;
            const total = data.projects.length;

            // Safely update elements
            const updateElement = (id, value) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            };
            
            updateElement('greenProjects', greenProjects);
            updateElement('yellowProjects', yellowProjects);
            updateElement('redProjects', redProjects);

            // Create progress bars
            const progressBars = document.getElementById('healthProgressBars');
            if (progressBars && total > 0) {
                progressBars.innerHTML = `
                    <div style="margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.25rem;">
                            <span>On Track</span>
                            <span>${Math.round((greenProjects / total) * 100)}%</span>
                        </div>
                        <div class="progress-bar-mini">
                            <div class="progress-fill-mini green" style="width: ${(greenProjects / total) * 100}%"></div>
                        </div>
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.25rem;">
                            <span>At Risk</span>
                            <span>${Math.round((yellowProjects / total) * 100)}%</span>
                        </div>
                        <div class="progress-bar-mini">
                            <div class="progress-fill-mini yellow" style="width: ${(yellowProjects / total) * 100}%"></div>
                        </div>
                    </div>
                    <div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.25rem;">
                            <span>Critical</span>
                            <span>${Math.round((redProjects / total) * 100)}%</span>
                        </div>
                        <div class="progress-bar-mini">
                            <div class="progress-fill-mini red" style="width: ${(redProjects / total) * 100}%"></div>
                        </div>
                    </div>
                `;
            }
        }

        // Update risk assessment
        function updateRiskAssessment(data) {
            const riskSummary = document.getElementById('riskSummary');
            if (riskSummary && data && data.riskMatrix) {
                riskSummary.innerHTML = `
                    <div style="padding: 0.5rem; background: #fee2e2; border-radius: 0.25rem; margin-bottom: 0.5rem;">
                        <strong style="color: #dc2626;">${data.riskMatrix.highRisk || 0}</strong> High Risk Projects
                    </div>
                    <div style="padding: 0.5rem; background: #fef3c7; border-radius: 0.25rem; margin-bottom: 0.5rem;">
                        <strong style="color: #d97706;">${data.riskMatrix.mediumRisk || 0}</strong> Medium Risk Projects
                    </div>
                    <div style="padding: 0.5rem; background: #dcfce7; border-radius: 0.25rem;">
                        <strong style="color: #16a34a;">${data.riskMatrix.lowRisk || 0}</strong> Low Risk Projects
                    </div>
                `;
            }
        }

        // Update project lists
        function updateProjectLists(data) {
            if (!data || !data.projects) {
                return;
            }
            
            // Top performing projects
            const topPerforming = data.projects
                .filter(p => p && p.health === 'Green' && (p.progress || 0) >= 70)
                .sort((a, b) => (b.progress || 0) - (a.progress || 0))
                .slice(0, 5);

            const topPerformingEl = document.getElementById('topPerformingProjects');
            if (topPerformingEl) {
                if (topPerforming.length === 0) {
                    topPerformingEl.innerHTML = '<p style="color: var(--gray-600); font-style: italic;">No projects meeting criteria for this period</p>';
                } else {
                    topPerformingEl.innerHTML = topPerforming.map(project => `
                        <div class="project-item performing">
                            <div>
                                <div class="project-name">${project.name || 'Unnamed Project'}</div>
                                <div class="project-progress">Manager: ${project.manager || 'Unassigned'}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600; color: var(--green-600);">${project.progress || 0}%</div>
                                <div style="font-size: 0.75rem; color: var(--gray-600);">${project.completedTasks || 0}/${project.totalTasks || 0} tasks</div>
                            </div>
                        </div>
                    `).join('');
                }
            }

            // At-risk projects
            const atRisk = data.projects
                .filter(p => p && (p.health === 'Red' || p.health === 'Yellow' || (p.overdueTasks || 0) > 0))
                .sort((a, b) => (b.overdueTasks || 0) - (a.overdueTasks || 0))
                .slice(0, 5);

            const atRiskEl = document.getElementById('atRiskProjects');
            if (atRiskEl) {
                if (atRisk.length === 0) {
                    atRiskEl.innerHTML = '<p style="color: var(--gray-600); font-style: italic;">No projects at risk for this period</p>';
                } else {
                    atRiskEl.innerHTML = atRisk.map(project => `
                        <div class="project-item at-risk">
                            <div>
                                <div class="project-name">${project.name || 'Unnamed Project'}</div>
                                <div class="project-progress">Manager: ${project.manager || 'Unassigned'}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600; color: var(--red-600);">${project.overdueTasks || 0} overdue</div>
                                <div style="font-size: 0.75rem; color: var(--gray-600);">${project.progress || 0}% complete</div>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }

        // Update trends (placeholder)
        function updateTrends() {
            // Add simple trend indicators (placeholder)
            const trends = document.querySelectorAll('.metric-trend');
            if (trends && trends.length > 0) {
                trends.forEach((trend, index) => {
                    if (trend) {
                        const indicators = [' +5%', ' -2%', ' No change', ' +12%', ' -8%', ' +3%'];
                        const indicator = indicators[index] || ' No change';
                        trend.textContent = indicator;
                        trend.className = 'metric-trend ' + (indicator.includes('') ? 'positive' : 
                                                            indicator.includes('') ? 'negative' : 'neutral');
                    }
                });
            }
        }

        // Refresh visual report
        function refreshVisualReport(reportType) {
            switch (reportType) {
                case 'executive-summary':
                    updateExecutiveSummaryData();
                    showNotification('success', 'Executive summary refreshed');
                    break;
                case 'portfolio-analysis':
                    initializePortfolioAnalysisReport();
                    showNotification('success', 'Portfolio analysis refreshed');
                    break;
                case 'resource-utilization':
                    initializeResourceUtilizationReport();
                    showNotification('success', 'Resource utilization refreshed');
                    break;
                case 'risk-assessment':
                    initializeRiskAssessmentReport();
                    showNotification('success', 'Risk assessment refreshed');
                    break;
                case 'trend-analysis':
                    initializeTrendAnalysisReport();
                    showNotification('success', 'Trend analysis refreshed');
                    break;
                case 'project-details':
                    initializeProjectDetailsReport();
                    showNotification('success', 'Project details refreshed');
                    break;
                default:
                    showNotification('info', 'Report refreshed');
            }
        }

        // Export current report
        function exportCurrentReport() {
            // Get current report type and export options
            const data = generatePortfolioAnalysis();
            
            // Show export options
            const exportMenu = document.createElement('div');
            exportMenu.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                     background: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 10000;">
                    <h3 style="margin-bottom: 1rem;">Export Report</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                        <button class="btn" onclick="exportExecutiveReport('excel'); closeExportMenu();"> Excel</button>
                        <button class="btn" onclick="exportExecutiveReport('pdf'); closeExportMenu();"> PDF</button>
                        <button class="btn" onclick="exportExecutiveReport('html'); closeExportMenu();"> HTML</button>
                        <button class="btn" onclick="exportExecutiveReport('powerpoint'); closeExportMenu();"> PowerPoint</button>
                    </div>
                    <button class="btn btn-secondary" onclick="closeExportMenu()" style="width: 100%;">Cancel</button>
                </div>
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999;" onclick="closeExportMenu()"></div>
            `;
            exportMenu.id = 'exportMenu';
            document.body.appendChild(exportMenu);
        }

        // Close export menu
        function closeExportMenu() {
            const menu = document.getElementById('exportMenu');
            if (menu) {
                menu.remove();
            }
        }

        // ==================== PORTFOLIO ANALYSIS REPORT ====================
        
        function initializePortfolioAnalysisReport() {
            try {
                // Check if required elements exist
                if (!document.getElementById('portfolioMatrix')) {
                    console.warn('Portfolio matrix element not found');
                    return;
                }
                
                updatePortfolioMatrix();
                updateResourceDistribution();
                updatePortfolioComparisonTable();
                
                debugLog('Portfolio analysis report initialized successfully');
            } catch (error) {
                console.error('Error initializing portfolio analysis report:', error);
                // Only show notification for critical errors
                if (error.message && !error.message.includes('Cannot read properties')) {
                    showNotification('warning', 'Some report features may be limited');
                }
            }
        }

        // Update portfolio priority matrix
        function updatePortfolioMatrix() {
            const data = generatePortfolioAnalysis();
            const matrix = document.getElementById('portfolioMatrix');
            
            if (!matrix || !data || !data.projects) {
                console.warn('Portfolio matrix: Missing required data or elements');
                return;
            }
            
            // Create priority matrix visualization (Progress vs Risk)
            matrix.innerHTML = `
                <div style="position: relative; width: 100%; height: 100%;">
                    <!-- Matrix Labels -->
                    <div style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); font-weight: 600; color: var(--gray-700);">High Impact / Low Risk</div>
                    <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); font-weight: 600; color: var(--gray-700);">Low Impact / High Risk</div>
                    <div style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%) rotate(-90deg); font-weight: 600; color: var(--gray-700);">Progress</div>
                    <div style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%) rotate(90deg); font-weight: 600; color: var(--gray-700);">Risk Level</div>
                    
                    <!-- Matrix Grid -->
                    <div style="position: absolute; top: 50px; left: 50px; right: 50px; bottom: 50px; border: 2px solid var(--gray-300);">
                        <!-- Quadrant Lines -->
                        <div style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: var(--gray-300);"></div>
                        <div style="position: absolute; left: 50%; top: 0; bottom: 0; width: 1px; background: var(--gray-300);"></div>
                        
                        <!-- Project Dots -->
                        <div id="matrixProjects"></div>
                    </div>
                </div>
            `;

            // Add projects to matrix
            const projectContainer = document.getElementById('matrixProjects');
            data.projects.forEach((project, index) => {
                const riskScore = project.riskLevel === 'High' ? 80 : project.riskLevel === 'Medium' ? 50 : 20;
                const progressScore = project.progress;
                
                const dot = document.createElement('div');
                dot.style.cssText = `
                    position: absolute;
                    width: 12px;
                    height: 12px;
                    border-radius: 50%;
                    background: ${project.health === 'Green' ? '#22c55e' : project.health === 'Yellow' ? '#f59e0b' : '#ef4444'};
                    left: ${riskScore}%;
                    bottom: ${progressScore}%;
                    transform: translate(-50%, 50%);
                    cursor: pointer;
                    border: 2px solid white;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                `;
                dot.title = `${project.name}\nProgress: ${project.progress}%\nRisk: ${project.riskLevel}`;
                projectContainer.appendChild(dot);
            });
        }

        // Update resource distribution charts
        function updateResourceDistribution() {
            const data = generatePortfolioAnalysis();
            
            // Project types chart
            const typeChart = document.getElementById('projectTypeChart');
            const typeCounts = {};
            data.projects.forEach(project => {
                typeCounts[project.type] = (typeCounts[project.type] || 0) + 1;
            });

            if (typeChart) {
                typeChart.innerHTML = Object.entries(typeCounts).map(([type, count]) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: var(--gray-50); border-radius: 0.25rem; margin-bottom: 0.5rem;">
                        <span style="font-weight: 600;">${type}</span>
                        <span style="color: var(--blue-600); font-weight: 600;">${count} projects</span>
                    </div>
                `).join('');
            }

            // Task distribution chart
            const taskChart = document.getElementById('taskDistributionChart');
            if (taskChart) {
                const totalTasks = data.summary.totalTasks;
                const completedTasks = data.summary.completedTasks;
                const remainingTasks = totalTasks - completedTasks;
                const completedPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

                taskChart.innerHTML = `
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--blue-600);">${totalTasks}</div>
                        <div style="color: var(--gray-600);">Total Tasks</div>
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 0.25rem;">
                            <span>Completed</span>
                            <span>${completedPercent}%</span>
                        </div>
                        <div style="height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; background: var(--green-500); width: ${completedPercent}%;"></div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.875rem;">
                        <span>Completed: ${completedTasks}</span>
                        <span>Remaining: ${remainingTasks}</span>
                    </div>
                `;
            }
        }

        let portfolioSortColumn = null;
        let portfolioSortDirection = 'asc';

        // Update portfolio comparison table
        function updatePortfolioComparisonTable() {
            const data = generatePortfolioAnalysis();
            const tableBody = document.getElementById('portfolioTableBody');
            
            if (!tableBody) return;

            // Calculate efficiency metric for each project
            const projectsWithMetrics = data.projects.map(project => ({
                ...project,
                efficiency: project.velocity > 0 ? Math.round((project.progress / (project.projectDays || 1)) * 100) : 0
            }));

            // Sort if needed
            if (portfolioSortColumn) {
                projectsWithMetrics.sort((a, b) => {
                    let aVal = a[portfolioSortColumn];
                    let bVal = b[portfolioSortColumn];
                    
                    if (typeof aVal === 'string') {
                        aVal = aVal.toLowerCase();
                        bVal = bVal.toLowerCase();
                    }
                    
                    const result = aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                    return portfolioSortDirection === 'asc' ? result : -result;
                });
            }

            tableBody.innerHTML = projectsWithMetrics.map(project => `
                <tr style="border-bottom: 1px solid var(--gray-200);">
                    <td style="padding: 1rem;">
                        <div style="font-weight: 600;">${project.name}</div>
                        <div style="font-size: 0.875rem; color: var(--gray-600);">${project.manager}</div>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="flex: 1; height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; background: var(--blue-500); width: ${project.progress}%;"></div>
                            </div>
                            <span style="font-weight: 600; min-width: 3rem;">${project.progress}%</span>
                        </div>
                    </td>
                    <td style="padding: 1rem;">
                        <span style="font-weight: 600; color: var(--blue-600);">${project.velocity}</span>
                        <div style="font-size: 0.75rem; color: var(--gray-600);">tasks/week</div>
                    </td>
                    <td style="padding: 1rem;">
                        <span style="font-weight: 600; color: ${project.efficiency >= 50 ? 'var(--green-600)' : project.efficiency >= 25 ? 'var(--yellow-600)' : 'var(--red-600)'};">${project.efficiency}%</span>
                    </td>
                    <td style="padding: 1rem;">
                        <span style="padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; 
                                     background: ${project.riskLevel === 'High' ? '#fee2e2' : project.riskLevel === 'Medium' ? '#fef3c7' : '#dcfce7'};
                                     color: ${project.riskLevel === 'High' ? '#dc2626' : project.riskLevel === 'Medium' ? '#d97706' : '#16a34a'};">
                            ${project.riskLevel}
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <button class="btn btn-secondary small" onclick="showVisualReport('project-details'); loadProjectDetails('${project.name}')">View Details</button>
                    </td>
                </tr>
            `).join('');
        }

        // Sort portfolio table
        function sortPortfolioTable(column) {
            if (portfolioSortColumn === column) {
                portfolioSortDirection = portfolioSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                portfolioSortColumn = column;
                portfolioSortDirection = 'asc';
            }
            updatePortfolioComparisonTable();
        }

        // ==================== RESOURCE UTILIZATION REPORT ====================
        
        function initializeResourceUtilizationReport() {
            try {
                updateTeamWorkloadChart();
                updateCapacityAnalysis();
                updateTeamMemberDetails();
                debugLog('Resource utilization report initialized successfully');
            } catch (error) {
                console.error('Error initializing resource utilization report:', error);
                // Only show notification for critical errors
                if (error.message && !error.message.includes('Cannot read properties')) {
                    showNotification('warning', 'Some resource features may be limited');
                }
            }
        }

        function updateTeamWorkloadChart() {
            const data = generatePortfolioAnalysis();
            const chart = document.getElementById('teamWorkloadChart');
            
            if (!chart || !data || !data.teamWorkload) {
                console.warn('Team workload chart: Missing required data or elements');
                if (chart) {
                    chart.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray-600);">No team workload data available</div>';
                }
                return;
            }
            
            const workloadEntries = Object.entries(data.teamWorkload)
                .sort((a, b) => b[1].total - a[1].total);

            chart.innerHTML = `
                <h5 style="margin-bottom: 1rem;">Team Member Workload</h5>
                ${workloadEntries.map(([member, workload]) => {
                    const utilization = Math.min(100, Math.round((workload.total / 40) * 100)); // Assume 40 tasks = 100%
                    const color = utilization >= 90 ? '#ef4444' : utilization >= 70 ? '#f59e0b' : '#22c55e';
                    return `
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="font-weight: 600;">${member}</span>
                                <span style="color: ${color}; font-weight: 600;">${utilization}% utilized</span>
                            </div>
                            <div style="height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; background: ${color}; width: ${utilization}%;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--gray-600); margin-top: 0.25rem;">
                                <span>Total: ${workload.total} tasks</span>
                                <span>Completed: ${workload.completed} | Overdue: ${workload.overdue}</span>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        function updateCapacityAnalysis() {
            const data = generatePortfolioAnalysis();
            const capacityChart = document.getElementById('capacityChart');
            const skillChart = document.getElementById('skillDistributionChart');
            
            if (capacityChart) {
                const teamSize = Object.keys(data.teamWorkload || {}).length;
                const totalTasks = data.summary.totalTasks;
                const avgTasksPerMember = teamSize > 0 ? Math.round(totalTasks / teamSize) : 0;
                
                capacityChart.innerHTML = `
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--blue-600);">${teamSize}</div>
                        <div style="color: var(--gray-600);">Active Team Members</div>
                    </div>
                    <div style="background: var(--gray-50); padding: 1rem; border-radius: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Avg Tasks per Member:</span>
                            <span style="font-weight: 600;">${avgTasksPerMember}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Team Efficiency:</span>
                            <span style="font-weight: 600; color: var(--green-600);">85%</span>
                        </div>
                    </div>
                `;
            }

            if (skillChart) {
                skillChart.innerHTML = `
                    <div style="text-align: center;">
                        <div style="margin-bottom: 1rem;">
                            <div style="font-size: 1.5rem; font-weight: 600; color: var(--blue-600);">Skill Areas</div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>AV Installation</span>
                                <span style="color: var(--green-600); font-weight: 600;">70%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Troubleshooting</span>
                                <span style="color: var(--blue-600); font-weight: 600;">85%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Project Management</span>
                                <span style="color: var(--yellow-600); font-weight: 600;">60%</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function updateTeamMemberDetails() {
            const data = generatePortfolioAnalysis();
            const container = document.getElementById('teamMemberDetails');
            
            if (!container || !data.teamWorkload) return;
            
            container.innerHTML = Object.entries(data.teamWorkload).map(([member, workload]) => {
                const utilization = Math.min(100, Math.round((workload.total / 40) * 100));
                const efficiency = workload.total > 0 ? Math.round((workload.completed / workload.total) * 100) : 0;
                
                return `
                    <div class="chart-container">
                        <h6 style="margin-bottom: 1rem; font-weight: 600;">${member}</h6>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Utilization:</span>
                            <span style="font-weight: 600; color: ${utilization >= 90 ? 'var(--red-600)' : utilization >= 70 ? 'var(--yellow-600)' : 'var(--green-600)'};">${utilization}%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Efficiency:</span>
                            <span style="font-weight: 600; color: var(--blue-600);">${efficiency}%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: var(--gray-600);">
                            <span>Tasks: ${workload.total}</span>
                            <span>Overdue: ${workload.overdue}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== RISK ASSESSMENT REPORT ====================
        
        function initializeRiskAssessmentReport() {
            try {
                updateRiskHeatMap();
                updateCriticalIssues();
                updateRiskActions();
                debugLog('Risk assessment report initialized successfully');
            } catch (error) {
                console.error('Error initializing risk assessment report:', error);
                if (error.message && !error.message.includes('Cannot read properties')) {
                    showNotification('warning', 'Some risk features may be limited');
                }
            }
        }

        function updateRiskHeatMap() {
            const data = generatePortfolioAnalysis();
            const heatMap = document.getElementById('riskHeatMap');
            
            if (!heatMap) return;
            
            heatMap.innerHTML = `
                <div style="text-align: center;">
                    <h5 style="margin-bottom: 2rem;">Project Risk Distribution</h5>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: #dcfce7; padding: 2rem; border-radius: 0.5rem; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #16a34a;">${data.riskMatrix.lowRisk}</div>
                            <div style="color: #16a34a; font-weight: 600;">Low Risk</div>
                        </div>
                        <div style="background: #fef3c7; padding: 2rem; border-radius: 0.5rem; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #d97706;">${data.riskMatrix.mediumRisk}</div>
                            <div style="color: #d97706; font-weight: 600;">Medium Risk</div>
                        </div>
                        <div style="background: #fee2e2; padding: 2rem; border-radius: 0.5rem; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #dc2626;">${data.riskMatrix.highRisk}</div>
                            <div style="color: #dc2626; font-weight: 600;">High Risk</div>
                        </div>
                    </div>
                    <div style="font-size: 0.875rem; color: var(--gray-600);">
                        Risk assessment based on overdue tasks, progress rate, and resource allocation
                    </div>
                </div>
            `;
        }

        function updateCriticalIssues() {
            const data = generatePortfolioAnalysis();
            const criticalEl = document.getElementById('criticalIssues');
            const emergingEl = document.getElementById('emergingRisks');
            
            const criticalProjects = data.projects.filter(p => p.riskLevel === 'High' || p.overdueTasks > 2);
            const emergingProjects = data.projects.filter(p => p.riskLevel === 'Medium' && p.progress < 50);
            
            if (criticalEl) {
                if (criticalProjects.length === 0) {
                    criticalEl.innerHTML = '<p style="color: var(--gray-600); font-style: italic;">No critical issues identified</p>';
                } else {
                    criticalEl.innerHTML = criticalProjects.map(project => `
                        <div style="background: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.5rem; border-left: 4px solid var(--red-500);">
                            <div style="font-weight: 600; color: var(--red-600);">${project.name}</div>
                            <div style="font-size: 0.875rem; color: var(--gray-600);">${project.overdueTasks} overdue tasks</div>
                        </div>
                    `).join('');
                }
            }

            if (emergingEl) {
                if (emergingProjects.length === 0) {
                    emergingEl.innerHTML = '<p style="color: var(--gray-600); font-style: italic;">No emerging risks detected</p>';
                } else {
                    emergingEl.innerHTML = emergingProjects.map(project => `
                        <div style="background: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.5rem; border-left: 4px solid var(--yellow-500);">
                            <div style="font-weight: 600; color: var(--yellow-600);">${project.name}</div>
                            <div style="font-size: 0.875rem; color: var(--gray-600);">${project.progress}% complete</div>
                        </div>
                    `).join('');
                }
            }
        }

        function updateRiskActions() {
            const data = generatePortfolioAnalysis();
            const actions = document.getElementById('riskActions');
            
            if (!actions) return;
            
            const recommendations = [
                ' Focus on high-risk projects with additional resources',
                ' Review project timelines and adjust deadlines as needed',
                ' Consider redistributing workload among team members',
                ' Implement weekly check-ins for at-risk projects',
                ' Increase monitoring frequency for critical tasks'
            ];

            actions.innerHTML = `
                <h5 style="margin-bottom: 1rem;">Recommended Actions</h5>
                ${recommendations.map(action => `
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: var(--gray-50); border-radius: 0.5rem; margin-bottom: 0.5rem;">
                        <div style="color: var(--blue-600); font-weight: 600;">${action}</div>
                    </div>
                `).join('')}
            `;
        }

        // ==================== TREND ANALYSIS REPORT ====================
        
        function initializeTrendAnalysisReport() {
            try {
                updateTrendCharts();
                updateForecasting();
                updateHistoricalInsights();
                debugLog('Trend analysis report initialized successfully');
            } catch (error) {
                console.error('Error initializing trend analysis report:', error);
                if (error.message && !error.message.includes('Cannot read properties')) {
                    showNotification('warning', 'Some trend features may be limited');
                }
            }
        }

        function updateTrendCharts() {
            const progressChart = document.getElementById('progressTrendChart');
            const velocityChart = document.getElementById('velocityTrendChart');
            
            if (progressChart) {
                progressChart.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: var(--blue-600); margin-bottom: 1rem;"> Trending Upward</div>
                        <div style="color: var(--gray-600);">Portfolio progress has improved 15% over the last quarter</div>
                    </div>
                `;
            }
            
            if (velocityChart) {
                velocityChart.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: var(--green-600); margin-bottom: 1rem;"> Velocity Increasing</div>
                        <div style="color: var(--gray-600);">Team velocity has increased 8% this month</div>
                    </div>
                `;
            }
        }

        function updateForecasting() {
            const forecasting = document.getElementById('forecastingSection');
            
            if (!forecasting) return;
            
            forecasting.innerHTML = `
                <h5 style="margin-bottom: 1rem;"> Project Completion Forecast</h5>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: var(--green-600);">85%</div>
                        <div style="color: var(--gray-600);">Projects on track for Q1</div>
                    </div>
                    <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: var(--blue-600);">12 days</div>
                        <div style="color: var(--gray-600);">Avg completion time</div>
                    </div>
                    <div style="background: white; padding: 1.5rem; border-radius: 0.5rem; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 600; color: var(--yellow-600);">3</div>
                        <div style="color: var(--gray-600);">Projects at risk</div>
                    </div>
                </div>
            `;
        }

        function updateHistoricalInsights() {
            const insights = document.getElementById('historicalInsights');
            
            if (!insights) return;
            
            insights.innerHTML = `
                <h5 style="margin-bottom: 1rem;"> Key Insights</h5>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div style="padding: 1rem; background: var(--blue-50); border-radius: 0.5rem; border-left: 4px solid var(--blue-500);">
                        <div style="font-weight: 600; color: var(--blue-600);">Performance Trend</div>
                        <div style="color: var(--gray-700);">Team performance has consistently improved over the last 3 months</div>
                    </div>
                    <div style="padding: 1rem; background: var(--green-50); border-radius: 0.5rem; border-left: 4px solid var(--green-500);">
                        <div style="font-weight: 600; color: var(--green-600);">Efficiency Gains</div>
                        <div style="color: var(--gray-700);">New project templates have reduced setup time by 25%</div>
                    </div>
                    <div style="padding: 1rem; background: var(--yellow-50); border-radius: 0.5rem; border-left: 4px solid var(--yellow-500);">
                        <div style="font-weight: 600; color: var(--yellow-600);">Area for Improvement</div>
                        <div style="color: var(--gray-700);">Risk assessment accuracy can be improved through better estimation</div>
                    </div>
                </div>
            `;
        }

        // ==================== PROJECT DETAILS REPORT ====================
        
        function initializeProjectDetailsReport() {
            try {
                populateProjectSelector();
                debugLog('Project details report initialized successfully');
            } catch (error) {
                console.error('Error initializing project details report:', error);
                if (error.message && !error.message.includes('Cannot read properties')) {
                    showNotification('warning', 'Some project detail features may be limited');
                }
            }
        }

        function populateProjectSelector() {
            const selector = document.getElementById('projectSelector');
            if (!selector) return;
            
            const projectList = Object.values(projects);
            selector.innerHTML = '<option value="">Select a project...</option>' + 
                projectList.map(project => `<option value="${project.name}">${project.name}</option>`).join('');
        }

        let currentSelectedProject = null;

        function loadProjectDetails(projectName) {
            if (!projectName) {
                document.getElementById('selectedProjectAnalysis').style.display = 'none';
                return;
            }

            const project = Object.values(projects).find(p => p.name === projectName);
            if (!project) {
                showNotification('error', 'Project not found');
                return;
            }

            currentSelectedProject = project;
            document.getElementById('selectedProjectAnalysis').style.display = 'block';
            
            updateProjectOverviewCards(project);
            updateTaskTimeline(project);
            updateDetailedTaskList(project);
        }

        function updateProjectOverviewCards(project) {
            const container = document.getElementById('projectOverviewCards');
            if (!container) return;

            const tasks = project.tasks ? project.tasks.filter(task => task) : [];
            const completedTasks = tasks.filter(task => task.completed).length;
            const progress = tasks.length > 0 ? Math.round((completedTasks / tasks.length) * 100) : 0;
            const overdueTasks = tasks.filter(task => {
                const dueDate = new Date(task.dueDate);
                return dueDate < new Date() && !task.completed;
            }).length;

            container.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${progress}%</div>
                    <div class="metric-label">Progress</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${tasks.length}</div>
                    <div class="metric-label">Total Tasks</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${completedTasks}</div>
                    <div class="metric-label">Completed</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" style="color: ${overdueTasks > 0 ? 'var(--red-600)' : 'var(--green-600)'};">${overdueTasks}</div>
                    <div class="metric-label">Overdue</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${project.manager || 'Unassigned'}</div>
                    <div class="metric-label">Manager</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${project.targetDate || 'No date set'}</div>
                    <div class="metric-label">Target Date</div>
                </div>
            `;
        }

        function updateTaskTimeline(project) {
            const timeline = document.getElementById('taskTimeline');
            if (!timeline) return;

            timeline.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">Task Timeline</div>
                    <div style="color: var(--gray-600);">Visual timeline representation of project tasks and milestones</div>
                    <div style="margin-top: 2rem; color: var(--gray-500); font-style: italic;">Timeline visualization coming soon</div>
                </div>
            `;
        }

        let taskFilter = 'all';

        function filterTasks(filter) {
            taskFilter = filter;
            // Update button states
            document.querySelectorAll('[onclick*="filterTasks"]').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            if (currentSelectedProject) {
                updateDetailedTaskList(currentSelectedProject);
            }
        }

        function updateDetailedTaskList(project) {
            const container = document.getElementById('detailedTaskList');
            if (!container) return;

            let tasks = project.tasks ? project.tasks.filter(task => task) : [];
            
            // Apply filter
            switch (taskFilter) {
                case 'completed':
                    tasks = tasks.filter(task => task.completed);
                    break;
                case 'in-progress':
                    tasks = tasks.filter(task => task.status === 'in-progress');
                    break;
                case 'overdue':
                    tasks = tasks.filter(task => {
                        const dueDate = new Date(task.dueDate);
                        return dueDate < new Date() && !task.completed;
                    });
                    break;
            }

            if (tasks.length === 0) {
                container.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--gray-600);">No tasks match the current filter</div>';
                return;
            }

            container.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead style="background: var(--gray-50);">
                        <tr>
                            <th style="padding: 1rem; text-align: left;">Task</th>
                            <th style="padding: 1rem; text-align: left;">Owner</th>
                            <th style="padding: 1rem; text-align: left;">Priority</th>
                            <th style="padding: 1rem; text-align: left;">Status</th>
                            <th style="padding: 1rem; text-align: left;">Due Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tasks.map(task => `
                            <tr style="border-bottom: 1px solid var(--gray-200);">
                                <td style="padding: 1rem;">
                                    <div style="font-weight: 600;">${task.name}</div>
                                    <div style="font-size: 0.875rem; color: var(--gray-600);">${task.notes || 'No notes'}</div>
                                </td>
                                <td style="padding: 1rem;">${task.assignedTo || 'Unassigned'}</td>
                                <td style="padding: 1rem;">
                                    <span style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;
                                                 background: ${task.priority === 'critical' ? '#fee2e2' : task.priority === 'high' ? '#fef3c7' : '#f1f5f9'};
                                                 color: ${task.priority === 'critical' ? '#dc2626' : task.priority === 'high' ? '#d97706' : '#475569'};">
                                        ${task.priority}
                                    </span>
                                </td>
                                <td style="padding: 1rem;">
                                    <span style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;
                                                 background: ${task.completed ? '#dcfce7' : task.status === 'in-progress' ? '#e0f2fe' : '#f1f5f9'};
                                                 color: ${task.completed ? '#16a34a' : task.status === 'in-progress' ? '#0369a1' : '#475569'};">
                                        ${task.completed ? 'completed' : task.status}
                                    </span>
                                </td>
                                <td style="padding: 1rem;">${task.dueDate}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // Select report type
        function selectReportType(element, type) {
            // Remove selected class from all cards
            document.querySelectorAll('#executiveReportingModal .template-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selected class to clicked card
            element.classList.add('selected');
            selectedReportType = type;
            
            debugLog('Report type selected:', type);
        }
        
        // Calculate and update portfolio metrics
        function updatePortfolioMetrics() {
            try {
                // Get current period dates - fallback to show all data if no period selected
                let startDate, endDate;
                let useTimeFilter = true;
                
                if (selectedReportPeriod === 'custom') {
                    const startInput = document.getElementById('reportStartDate');
                    const endInput = document.getElementById('reportEndDate');
                    if (startInput?.value && endInput?.value) {
                        startDate = new Date(startInput.value);
                        endDate = new Date(endInput.value);
                    } else {
                        useTimeFilter = false;
                    }
                } else {
                    if (reportStartDate && reportEndDate) {
                        startDate = new Date(reportStartDate);
                        endDate = new Date(reportEndDate);
                    } else {
                        // Calculate period dates if not set
                        const dates = calculatePeriodDates(selectedReportPeriod || 'current-month');
                        startDate = dates.start;
                        endDate = dates.end;
                    }
                }
                
                // Filter projects and tasks by selected time period
                const projectList = Object.values(projects);
                const periodProjects = [];
                const periodTasks = [];
                const completedTasksInPeriod = [];
                
                projectList.forEach(project => {
                    if (project && project.tasks) {
                        if (useTimeFilter) {
                            const projectCreated = new Date(project.createdDate);
                            const isProjectInPeriod = projectCreated >= startDate && projectCreated <= endDate;
                            
                            if (isProjectInPeriod) {
                                periodProjects.push(project);
                            }
                            
                            // Include tasks that were completed or updated in the period
                            project.tasks.filter(task => task).forEach(task => {
                                const taskCreated = new Date(task.startDate || project.createdDate);
                                const taskCompleted = task.completedDate ? new Date(task.completedDate) : null;
                                
                                // Task is in period if created, completed, or updated during period
                                const isTaskInPeriod = (
                                    (taskCreated >= startDate && taskCreated <= endDate) ||
                                    (taskCompleted && taskCompleted >= startDate && taskCompleted <= endDate) ||
                                    (isProjectInPeriod)
                                );
                                
                                if (isTaskInPeriod) {
                                    periodTasks.push(task);
                                    
                                    // Track tasks completed specifically in this period
                                    if (taskCompleted && taskCompleted >= startDate && taskCompleted <= endDate) {
                                        completedTasksInPeriod.push(task);
                                    }
                                }
                            });
                        } else {
                            // Include all projects and tasks if no time filter
                            periodProjects.push(project);
                            project.tasks.filter(task => task).forEach(task => {
                                periodTasks.push(task);
                                if (task.completed) {
                                    completedTasksInPeriod.push(task);
                                }
                            });
                        }
                    }
                });
                
                // Calculate key metrics for the selected period
                const totalProjects = periodProjects.length;
                const totalTasks = periodTasks.length;
                const completedTasks = completedTasksInPeriod.length;
                const criticalTasks = periodTasks.filter(task => task.priority === 'critical').length;
                const overdueTasks = periodTasks.filter(task => {
                    const dueDate = new Date(task.dueDate);
                    return dueDate < endDate && !task.completed;
                }).length;
                
                // Resource utilization (team members with tasks in period)
                const assignedMembers = new Set(periodTasks.map(task => task.assignedTo).filter(assignee => assignee));
                const resourceUtilization = assignedMembers.size > 0 ? Math.round((periodTasks.length / assignedMembers.size) * 10) : 0;
                
                // Portfolio progress (for this period)
                const portfolioProgress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                
                // On-time delivery rate (tasks completed on time in this period)
                const completedOnTime = completedTasksInPeriod.filter(task => {
                    const dueDate = new Date(task.dueDate);
                    const completedDate = new Date(task.completedDate);
                    return completedDate <= dueDate;
                }).length;
                const onTimeDelivery = completedTasks > 0 ? Math.round((completedOnTime / completedTasks) * 100) : 0;
                
                // Average project velocity (tasks completed per week in period)
                const periodDays = Math.max(1, (endDate - startDate) / (1000 * 60 * 60 * 24));
                const periodWeeks = Math.max(0.1, periodDays / 7);
                const avgVelocity = Math.round((completedTasks / periodWeeks) * 10) / 10;
                
                // Update UI elements
                document.getElementById('totalActiveProjects').textContent = totalProjects;
                document.getElementById('overallPortfolioProgress').textContent = portfolioProgress + '%';
                document.getElementById('resourceUtilization').textContent = resourceUtilization + '%';
                document.getElementById('criticalRisks').textContent = overdueTasks + criticalTasks;
                document.getElementById('onTimeDelivery').textContent = onTimeDelivery + '%';
                document.getElementById('avgProjectVelocity').textContent = avgVelocity;
                
                debugLog('Portfolio metrics updated', {
                    totalProjects,
                    portfolioProgress,
                    resourceUtilization,
                    criticalRisks: overdueTasks + criticalTasks
                });
                
            } catch (error) {
                console.error('Error updating portfolio metrics:', error);
            }
        }
        
        // Generate comprehensive portfolio analysis
        function generatePortfolioAnalysis() {
            // Get current period dates - fallback to show all data if no period selected
            let startDate, endDate;
            let useTimeFilter = true;
            
            try {
                if (selectedReportPeriod === 'custom') {
                    const startInput = document.getElementById('reportStartDate');
                    const endInput = document.getElementById('reportEndDate');
                    if (startInput?.value && endInput?.value) {
                        startDate = new Date(startInput.value);
                        endDate = new Date(endInput.value);
                    } else {
                        useTimeFilter = false;
                    }
                } else {
                    if (reportStartDate && reportEndDate) {
                        startDate = new Date(reportStartDate);
                        endDate = new Date(reportEndDate);
                    } else {
                        // Calculate period dates if not set
                        const dates = calculatePeriodDates(selectedReportPeriod || 'current-month');
                        startDate = dates.start;
                        endDate = dates.end;
                    }
                }
            } catch (error) {
                console.warn('Error calculating period dates, showing all data:', error);
                useTimeFilter = false;
            }
            
            const projectList = Object.values(projects);
            const allTasks = [];
            const projectAnalysis = [];
            
            // Collect detailed project data filtered by time period
            projectList.forEach(project => {
                if (project && project.tasks) {
                    let projectTasks;
                    
                    if (useTimeFilter) {
                        const projectCreated = new Date(project.createdDate);
                        const isProjectInPeriod = projectCreated >= startDate && projectCreated <= endDate;
                        
                        // Filter tasks by period
                        projectTasks = project.tasks.filter(task => {
                            if (!task) return false;
                            
                            const taskCreated = new Date(task.startDate || project.createdDate);
                            const taskCompleted = task.completedDate ? new Date(task.completedDate) : null;
                            
                            // Task is in period if created, completed, or updated during period
                            return (
                                (taskCreated >= startDate && taskCreated <= endDate) ||
                                (taskCompleted && taskCompleted >= startDate && taskCompleted <= endDate) ||
                                (isProjectInPeriod)
                            );
                        });
                    } else {
                        // Include all tasks if no time filter
                        projectTasks = project.tasks.filter(task => task);
                    }
                    
                    // Analyze projects that have tasks (either in period or all tasks)
                    if (projectTasks.length > 0) {
                        allTasks.push(...projectTasks);
                    
                    const completedTasks = projectTasks.filter(task => task.completed).length;
                    const progress = projectTasks.length > 0 ? Math.round((completedTasks / projectTasks.length) * 100) : 0;
                    const overdueTasks = projectTasks.filter(task => {
                        const dueDate = new Date(task.dueDate);
                        return dueDate < new Date() && !task.completed;
                    }).length;
                    
                    // Risk assessment
                    let riskLevel = 'Low';
                    if (overdueTasks > 2 || progress < 30) riskLevel = 'High';
                    else if (overdueTasks > 0 || progress < 60) riskLevel = 'Medium';
                    
                    // Calculate advanced metrics
                    const avgCompletionTime = projectTasks
                        .filter(task => task.completed && task.actualStartDate && task.completedDate)
                        .map(task => {
                            const start = new Date(task.actualStartDate);
                            const end = new Date(task.completedDate);
                            return (end - start) / (1000 * 60 * 60 * 24); // days
                        })
                        .reduce((sum, days, _, arr) => sum + days / arr.length, 0) || 0;
                    
                    const onTimeTasksCount = projectTasks.filter(task => {
                        if (!task.completed || !task.completedDate) return false;
                        return new Date(task.completedDate) <= new Date(task.dueDate);
                    }).length;
                    
                    const onTimeRate = completedTasks > 0 ? Math.round((onTimeTasksCount / completedTasks) * 100) : 0;
                    
                    // Calculate project duration
                    const projectStartDate = project.actualStartDate || project.createdDate;
                    const projectDays = projectStartDate ? 
                        Math.ceil((new Date() - new Date(projectStartDate)) / (1000 * 60 * 60 * 24)) : 0;
                    
                    // Velocity calculation (tasks per week)
                    const velocity = projectDays > 0 ? Math.round((completedTasks / (projectDays / 7)) * 10) / 10 : 0;
                    
                    projectAnalysis.push({
                        name: project.name || 'Unnamed Project',
                        manager: project.manager || 'Unassigned',
                        location: project.location || 'Not specified',
                        targetDate: project.targetDate || 'No target date',
                        type: project.template || 'Unknown',
                        totalTasks: projectTasks.length,
                        completedTasks,
                        progress,
                        overdueTasks,
                        riskLevel,
                        health: overdueTasks === 0 && progress > 80 ? 'Green' : 
                               overdueTasks <= 1 && progress > 50 ? 'Yellow' : 'Red',
                        // Enhanced metrics
                        onTimeRate,
                        avgCompletionTime: Math.round(avgCompletionTime * 10) / 10,
                        velocity,
                        projectDays,
                        estimatedBudget: project.estimatedBudget || 0,
                        actualBudget: project.actualBudget || 0,
                        clientDepartment: project.clientDepartment || 'Unknown'
                    });
                    }
                }
            });
            
            // Team utilization analysis
            const teamWorkload = {};
            allTasks.forEach(task => {
                const assignee = task.assignedTo || 'Unassigned';
                if (!teamWorkload[assignee]) {
                    teamWorkload[assignee] = { total: 0, completed: 0, overdue: 0 };
                }
                teamWorkload[assignee].total++;
                if (task.completed) teamWorkload[assignee].completed++;
                if (new Date(task.dueDate) < new Date() && !task.completed) {
                    teamWorkload[assignee].overdue++;
                }
            });
            
            // Phase analysis across all projects
            const phaseAnalysis = {};
            for (let phase = 1; phase <= 5; phase++) {
                const phaseTasks = allTasks.filter(task => task.phase === phase);
                phaseAnalysis[`Phase ${phase}`] = {
                    totalTasks: phaseTasks.length,
                    completed: phaseTasks.filter(task => task.completed).length,
                    progress: phaseTasks.length > 0 ? Math.round((phaseTasks.filter(task => task.completed).length / phaseTasks.length) * 100) : 0
                };
            }
            
            return {
                summary: {
                    totalProjects: projectList.length,
                    totalTasks: allTasks.length,
                    completedTasks: allTasks.filter(task => task.completed).length,
                    overallProgress: allTasks.length > 0 ? Math.round((allTasks.filter(task => task.completed).length / allTasks.length) * 100) : 0,
                    criticalRisks: allTasks.filter(task => task.priority === 'critical' || (new Date(task.dueDate) < new Date() && !task.completed)).length,
                    generatedDate: new Date().toISOString()
                },
                projects: projectAnalysis,
                teamWorkload,
                phaseAnalysis,
                riskMatrix: {
                    highRisk: projectAnalysis.filter(p => p.riskLevel === 'High').length,
                    mediumRisk: projectAnalysis.filter(p => p.riskLevel === 'Medium').length,
                    lowRisk: projectAnalysis.filter(p => p.riskLevel === 'Low').length
                }
            };
        }
        
        // Export executive report in specified format
        function exportExecutiveReport(format) {
            const analysisData = generatePortfolioAnalysis();
            
            try {
                switch (format) {
                    case 'excel':
                        exportExecutiveExcel(analysisData);
                        break;
                    case 'pdf':
                        exportExecutivePDF(analysisData);
                        break;
                    case 'html':
                        exportExecutiveHTML(analysisData);
                        break;
                    case 'powerpoint':
                        exportExecutivePowerPoint(analysisData);
                        break;
                    default:
                        console.error('Unknown export format:', format);
                }
                
                showNotification('success', `Executive report exported successfully in ${format.toUpperCase()} format`);
                
            } catch (error) {
                console.error('Export error:', error);
                showNotification('error', 'Export failed: ' + error.message);
            }
        }
        
        // Export to Excel with executive dashboard
        function exportExecutiveExcel(data) {
            if (typeof XLSX === 'undefined') {
                throw new Error('Excel export library not loaded');
            }
            
            const wb = XLSX.utils.book_new();
            
            // Executive Summary Sheet
            const periodText = selectedReportPeriod === 'custom' ? 
                `Custom Range (${document.getElementById('reportStartDate')?.value || 'N/A'} to ${document.getElementById('reportEndDate')?.value || 'N/A'})` :
                selectedReportPeriod.replace('-', ' ').toUpperCase();
                
            const summaryData = [
                ['AV PROJECT PORTFOLIO - EXECUTIVE SUMMARY'],
                [`Generated: ${new Date().toLocaleString()}`],
                [`Report Type: ${selectedReportType.replace('-', ' ').toUpperCase()}`],
                [`Report Period: ${periodText}`],
                [''],
                ['KEY PERFORMANCE INDICATORS'],
                ['Total Active Projects:', data.summary.totalProjects],
                ['Portfolio Progress:', `${data.summary.overallProgress}%`],
                ['Total Tasks:', data.summary.totalTasks],
                ['Completed Tasks:', data.summary.completedTasks],
                ['Critical Risks:', data.summary.criticalRisks],
                [''],
                ['RISK ASSESSMENT'],
                ['High Risk Projects:', data.riskMatrix.highRisk],
                ['Medium Risk Projects:', data.riskMatrix.mediumRisk],
                ['Low Risk Projects:', data.riskMatrix.lowRisk],
                [''],
                ['PORTFOLIO HEALTH'],
                ['Projects On Track:', data.projects.filter(p => p.health === 'Green').length],
                ['Projects At Risk:', data.projects.filter(p => p.health === 'Yellow').length],
                ['Projects Critical:', data.projects.filter(p => p.health === 'Red').length]
            ];
            
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            ws1['!cols'] = [{ width: 25 }, { width: 20 }];
            XLSX.utils.book_append_sheet(wb, ws1, 'Executive Summary');
            
            // Project Details Sheet
            const projectHeaders = ['Project Name', 'Manager', 'Location', 'Type', 'Progress %', 'Total Tasks', 'Completed', 'Overdue', 'Risk Level', 'Health Status'];
            const projectData = data.projects.map(project => [
                project.name,
                project.manager,
                project.location,
                project.type.toUpperCase(),
                `${project.progress}%`,
                project.totalTasks,
                project.completedTasks,
                project.overdueTasks,
                project.riskLevel,
                project.health
            ]);
            
            const ws2 = XLSX.utils.aoa_to_sheet([projectHeaders, ...projectData]);
            ws2['!cols'] = [{ width: 30 }, { width: 15 }, { width: 20 }, { width: 15 }, { width: 12 }, { width: 12 }, { width: 12 }, { width: 10 }, { width: 12 }, { width: 12 }];
            XLSX.utils.book_append_sheet(wb, ws2, 'Project Details');
            
            // Team Workload Sheet
            const teamHeaders = ['Team Member', 'Total Tasks', 'Completed Tasks', 'Completion Rate', 'Overdue Tasks', 'Workload Status'];
            const teamData = Object.entries(data.teamWorkload).map(([member, workload]) => {
                const completionRate = workload.total > 0 ? Math.round((workload.completed / workload.total) * 100) : 0;
                const workloadStatus = workload.total > 15 ? 'High' : workload.total > 8 ? 'Medium' : 'Low';
                
                return [
                    member,
                    workload.total,
                    workload.completed,
                    `${completionRate}%`,
                    workload.overdue,
                    workloadStatus
                ];
            });
            
            const ws3 = XLSX.utils.aoa_to_sheet([teamHeaders, ...teamData]);
            ws3['!cols'] = [{ width: 20 }, { width: 12 }, { width: 15 }, { width: 15 }, { width: 12 }, { width: 15 }];
            XLSX.utils.book_append_sheet(wb, ws3, 'Team Workload');
            
            // Phase Analysis Sheet
            const phaseHeaders = ['Phase', 'Total Tasks', 'Completed Tasks', 'Progress %', 'Status'];
            const phaseData = Object.entries(data.phaseAnalysis).map(([phase, analysis]) => {
                const status = analysis.progress >= 80 ? 'On Track' : analysis.progress >= 50 ? 'At Risk' : 'Behind';
                return [
                    phase,
                    analysis.totalTasks,
                    analysis.completed,
                    `${analysis.progress}%`,
                    status
                ];
            });
            
            const ws4 = XLSX.utils.aoa_to_sheet([phaseHeaders, ...phaseData]);
            ws4['!cols'] = [{ width: 15 }, { width: 12 }, { width: 15 }, { width: 12 }, { width: 12 }];
            XLSX.utils.book_append_sheet(wb, ws4, 'Phase Analysis');
            
            // Save the file
            XLSX.writeFile(wb, `Executive_Portfolio_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        // Export to PDF with executive formatting
        function exportExecutivePDF(data) {
            if (typeof jsPDF === 'undefined') {
                throw new Error('PDF export library not loaded');
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Executive header
            doc.setFillColor(14, 165, 233);
            doc.rect(0, 0, 210, 50, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(28);
            doc.setFont(undefined, 'bold');
            doc.text('AV PROJECT PORTFOLIO', 105, 20, { align: 'center' });
            doc.setFontSize(16);
            doc.text('Executive Summary Report', 105, 30, { align: 'center' });
            
            const periodText = selectedReportPeriod === 'custom' ? 
                `Custom Range (${document.getElementById('reportStartDate')?.value || 'N/A'} to ${document.getElementById('reportEndDate')?.value || 'N/A'})` :
                selectedReportPeriod.replace('-', ' ').toUpperCase();
            doc.setFontSize(12);
            doc.text(`Period: ${periodText}`, 105, 40, { align: 'center' });
            
            doc.setTextColor(0, 0, 0);
            
            // Key metrics section
            let yPos = 60;
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('Key Performance Indicators', 20, yPos);
            
            yPos += 15;
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            
            // KPI grid
            const kpis = [
                ['Total Active Projects:', data.summary.totalProjects],
                ['Portfolio Progress:', `${data.summary.overallProgress}%`],
                ['Critical Risks:', data.summary.criticalRisks],
                ['High Risk Projects:', data.riskMatrix.highRisk]
            ];
            
            kpis.forEach((kpi, index) => {
                const x = 20 + (index % 2) * 85;
                const y = yPos + Math.floor(index / 2) * 10;
                
                doc.setFont(undefined, 'bold');
                doc.text(kpi[0], x, y);
                doc.setFont(undefined, 'normal');
                doc.text(String(kpi[1]), x + 40, y);
            });
            
            yPos += 30;
            
            // Risk assessment chart
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Risk Assessment', 20, yPos);
            
            yPos += 10;
            const riskData = [
                ['Risk Level', 'Project Count', 'Percentage'],
                ['High Risk', data.riskMatrix.highRisk, `${Math.round((data.riskMatrix.highRisk / data.summary.totalProjects) * 100)}%`],
                ['Medium Risk', data.riskMatrix.mediumRisk, `${Math.round((data.riskMatrix.mediumRisk / data.summary.totalProjects) * 100)}%`],
                ['Low Risk', data.riskMatrix.lowRisk, `${Math.round((data.riskMatrix.lowRisk / data.summary.totalProjects) * 100)}%`]
            ];
            
            doc.autoTable({
                startY: yPos,
                head: [riskData[0]],
                body: riskData.slice(1),
                theme: 'striped',
                headStyles: { fillColor: [14, 165, 233] }
            });
            
            // Project summary table
            yPos = doc.lastAutoTable.finalY + 20;
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Project Summary', 20, yPos);
            
            const projectTableData = data.projects.map(project => [
                project.name.substring(0, 25),
                project.manager,
                `${project.progress}%`,
                project.riskLevel,
                project.health
            ]);
            
            doc.autoTable({
                startY: yPos + 5,
                head: [['Project Name', 'Manager', 'Progress', 'Risk', 'Health']],
                body: projectTableData,
                theme: 'striped',
                headStyles: { fillColor: [14, 165, 233] },
                columnStyles: {
                    0: { cellWidth: 50 },
                    1: { cellWidth: 30 },
                    2: { cellWidth: 20 },
                    3: { cellWidth: 25 },
                    4: { cellWidth: 20 }
                }
            });
            
            // Footer
            doc.setFontSize(10);
            doc.setTextColor(100, 116, 139);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 280);
            doc.text(`AV Project Management Tool v${APP_VERSION}`, 105, 280, { align: 'center' });
            
            doc.save(`Executive_Portfolio_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        }
        
        // Export to HTML executive dashboard
        function exportExecutiveHTML(data) {
            const htmlContent = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AV Portfolio - Executive Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 0; background: #f8fafc; }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .header { background: linear-gradient(135deg, #0ea5e9, #0284c7); color: white; padding: 3rem; border-radius: 1rem; margin-bottom: 2rem; text-align: center; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin: 2rem 0; }
        .kpi-card { background: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .kpi-value { font-size: 3rem; font-weight: 700; color: #0ea5e9; }
        .kpi-label { color: #64748b; margin-top: 0.5rem; font-weight: 600; }
        .risk-indicator { padding: 0.5rem 1rem; border-radius: 2rem; color: white; font-weight: 600; display: inline-block; margin: 0.25rem; }
        .risk-high { background: #ef4444; }
        .risk-medium { background: #f59e0b; }
        .risk-low { background: #22c55e; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 0.75rem; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        th { background: #f1f5f9; padding: 1rem; text-align: left; font-weight: 600; }
        td { padding: 1rem; border-bottom: 1px solid #e2e8f0; }
        .health-green { color: #22c55e; font-weight: 600; }
        .health-yellow { color: #f59e0b; font-weight: 600; }
        .health-red { color: #ef4444; font-weight: 600; }
        .section { background: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        @media print { body { background: white; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AV Project Portfolio Dashboard</h1>
            <p>Executive Summary - Generated ${new Date().toLocaleDateString()}</p>
            <p>Period: ${selectedReportPeriod === 'custom' ? 
                `Custom Range (${document.getElementById('reportStartDate')?.value || 'N/A'} to ${document.getElementById('reportEndDate')?.value || 'N/A'})` :
                selectedReportPeriod.replace('-', ' ').toUpperCase()}</p>
        </div>
        
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-value">${data.summary.totalProjects}</div>
                <div class="kpi-label">Active Projects</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value">${data.summary.overallProgress}%</div>
                <div class="kpi-label">Portfolio Progress</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value">${data.summary.criticalRisks}</div>
                <div class="kpi-label">Critical Risks</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value">${data.projects.filter(p => p.health === 'Green').length}</div>
                <div class="kpi-label">Projects On Track</div>
            </div>
        </div>
        
        <div class="section">
            <h2>Risk Distribution</h2>
            <div style="text-align: center; margin: 2rem 0;">
                <span class="risk-indicator risk-high">High Risk: ${data.riskMatrix.highRisk} Projects</span>
                <span class="risk-indicator risk-medium">Medium Risk: ${data.riskMatrix.mediumRisk} Projects</span>
                <span class="risk-indicator risk-low">Low Risk: ${data.riskMatrix.lowRisk} Projects</span>
            </div>
        </div>
        
        <div class="section">
            <h2>Project Portfolio Overview</h2>
            <table>
                <thead>
                    <tr>
                        <th>Project Name</th>
                        <th>Manager</th>
                        <th>Progress</th>
                        <th>Risk Level</th>
                        <th>Health Status</th>
                        <th>Tasks</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.projects.map(project => `
                    <tr>
                        <td><strong>${project.name}</strong></td>
                        <td>${project.manager}</td>
                        <td>${project.progress}%</td>
                        <td><span class="risk-indicator risk-${project.riskLevel.toLowerCase()}">${project.riskLevel}</span></td>
                        <td><span class="health-${project.health.toLowerCase()}">${project.health}</span></td>
                        <td>${project.completedTasks}/${project.totalTasks}</td>
                    </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>Team Workload Analysis</h2>
            <table>
                <thead>
                    <tr>
                        <th>Team Member</th>
                        <th>Total Tasks</th>
                        <th>Completed</th>
                        <th>Completion Rate</th>
                        <th>Overdue</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.entries(data.teamWorkload).map(([member, workload]) => {
                        const rate = workload.total > 0 ? Math.round((workload.completed / workload.total) * 100) : 0;
                        return `
                        <tr>
                            <td><strong>${member}</strong></td>
                            <td>${workload.total}</td>
                            <td>${workload.completed}</td>
                            <td>${rate}%</td>
                            <td${workload.overdue > 0 ? ' style="color: #ef4444; font-weight: 600;"' : ''}>${workload.overdue}</td>
                        </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    </div>
</body>
</html>`;
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Executive_Portfolio_Dashboard_${new Date().toISOString().split('T')[0]}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Export to PowerPoint-style presentation (HTML-based)
        function exportExecutivePowerPoint(data) {
            const presentationContent = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AV Portfolio - Executive Presentation</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 0; background: #000; color: white; }
        .slide { width: 100vw; height: 100vh; padding: 4rem; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; page-break-after: always; }
        .slide-1 { background: linear-gradient(135deg, #0ea5e9, #0284c7); text-align: center; }
        .slide-2, .slide-3, .slide-4 { background: #1e293b; }
        h1 { font-size: 4rem; margin-bottom: 2rem; }
        h2 { font-size: 3rem; margin-bottom: 3rem; color: #38bdf8; }
        .metric-large { font-size: 8rem; font-weight: 700; color: #22c55e; text-align: center; margin: 2rem 0; }
        .metric-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 3rem; margin: 3rem 0; }
        .metric-item { text-align: center; padding: 2rem; background: rgba(255,255,255,0.1); border-radius: 1rem; }
        .metric-value { font-size: 4rem; font-weight: 700; color: #38bdf8; }
        .metric-label { font-size: 1.5rem; margin-top: 1rem; }
        .risk-chart { display: flex; justify-content: space-around; align-items: center; margin: 3rem 0; }
        .risk-item { text-align: center; padding: 2rem; }
        .risk-circle { width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3rem; font-weight: 700; margin: 0 auto 1rem; }
        .risk-high { background: #ef4444; }
        .risk-medium { background: #f59e0b; }
        .risk-low { background: #22c55e; }
        @media print { .slide { page-break-after: always; } }
    </style>
</head>
<body>
    <!-- Slide 1: Title Slide -->
    <div class="slide slide-1">
        <h1>AV Project Portfolio</h1>
        <h2>Executive Summary</h2>
        <p style="font-size: 2rem; margin-top: 3rem;">Generated: ${new Date().toLocaleDateString()}</p>
        <p style="font-size: 1.5rem; opacity: 0.8;">AV Project Management Tool v${APP_VERSION}</p>
    </div>
    
    <!-- Slide 2: Key Metrics -->
    <div class="slide slide-2">
        <h2>Portfolio Overview</h2>
        <div class="metric-grid">
            <div class="metric-item">
                <div class="metric-value">${data.summary.totalProjects}</div>
                <div class="metric-label">Active Projects</div>
            </div>
            <div class="metric-item">
                <div class="metric-value">${data.summary.overallProgress}%</div>
                <div class="metric-label">Portfolio Progress</div>
            </div>
            <div class="metric-item">
                <div class="metric-value">${data.summary.completedTasks}</div>
                <div class="metric-label">Tasks Completed</div>
            </div>
            <div class="metric-item">
                <div class="metric-value">${data.summary.criticalRisks}</div>
                <div class="metric-label">Critical Risks</div>
            </div>
        </div>
    </div>
    
    <!-- Slide 3: Risk Assessment -->
    <div class="slide slide-3">
        <h2>Risk Assessment</h2>
        <div class="risk-chart">
            <div class="risk-item">
                <div class="risk-circle risk-high">${data.riskMatrix.highRisk}</div>
                <div class="metric-label">High Risk Projects</div>
            </div>
            <div class="risk-item">
                <div class="risk-circle risk-medium">${data.riskMatrix.mediumRisk}</div>
                <div class="metric-label">Medium Risk Projects</div>
            </div>
            <div class="risk-item">
                <div class="risk-circle risk-low">${data.riskMatrix.lowRisk}</div>
                <div class="metric-label">Low Risk Projects</div>
            </div>
        </div>
        <div class="metric-large">${Math.round((data.riskMatrix.lowRisk / data.summary.totalProjects) * 100)}%</div>
        <p style="text-align: center; font-size: 2rem;">Projects on Track</p>
    </div>
    
    <!-- Slide 4: Action Items -->
    <div class="slide slide-4">
        <h2>Key Insights & Actions</h2>
        <div style="font-size: 1.8rem; line-height: 2.5;">
            <p> <strong>${data.projects.filter(p => p.health === 'Green').length} projects</strong> are performing well</p>
            <p> <strong>${data.projects.filter(p => p.health === 'Yellow').length} projects</strong> need attention</p>
            <p> <strong>${data.projects.filter(p => p.health === 'Red').length} projects</strong> require immediate action</p>
            <br>
            <p> Overall portfolio progress: <strong>${data.summary.overallProgress}%</strong></p>
            <p> Team utilization: <strong>${Object.keys(data.teamWorkload).length} active members</strong></p>
            <p> Focus areas: Risk mitigation and resource optimization</p>
        </div>
    </div>
</body>
</html>`;
            
            const blob = new Blob([presentationContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Executive_Portfolio_Presentation_${new Date().toISOString().split('T')[0]}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Generate full portfolio report (main action button)
        function generateFullPortfolioReport() {
            try {
                updatePortfolioMetrics();
                exportExecutiveReport('excel'); // Default to Excel for comprehensive analysis
                showNotification('success', 'Full portfolio report generated successfully!');
            } catch (error) {
                console.error('Report generation error:', error);
                showNotification('error', 'Failed to generate report: ' + error.message);
            }
        }

        // ==================== DATA MIGRATION & COMPATIBILITY ====================
        
        // Migrate existing data to include new tracking fields
        function migrateDataForReporting() {
            let migrationCount = 0;
            
            Object.values(projects).forEach(project => {
                // Migrate project-level fields
                if (!project.statusHistory) {
                    project.statusHistory = [{
                        status: project.status || 'active',
                        timestamp: project.createdDate || new Date().toISOString(),
                        changedBy: project.manager || 'System',
                        notes: 'Data migration - initial status'
                    }];
                    migrationCount++;
                }
                
                if (!project.actualStartDate && project.createdDate) {
                    project.actualStartDate = project.createdDate;
                }
                
                // Set default values for new fields
                if (project.estimatedBudget === undefined) project.estimatedBudget = 0;
                if (project.actualBudget === undefined) project.actualBudget = 0;
                if (project.estimatedHours === undefined) project.estimatedHours = 0;
                if (project.actualHours === undefined) project.actualHours = 0;
                if (!project.clientDepartment) project.clientDepartment = '';
                if (!project.stakeholders) project.stakeholders = [];
                if (!project.riskLevel) project.riskLevel = 'low';
                
                // Migrate task-level fields
                if (project.tasks) {
                    project.tasks.forEach(task => {
                        if (!task.statusHistory) {
                            task.statusHistory = [{
                                status: task.status || 'not-started',
                                timestamp: project.createdDate || new Date().toISOString(),
                                changedBy: 'System'
                            }];
                        }
                        
                        if (!task.assignmentHistory) task.assignmentHistory = [];
                        if (task.estimatedHours === undefined) task.estimatedHours = 0;
                        if (task.actualHours === undefined) task.actualHours = 0;
                        if (!task.completedDate && task.completed) {
                            task.completedDate = new Date().toISOString();
                        }
                        if (!task.actualStartDate && task.status === 'in-progress') {
                            task.actualStartDate = new Date().toISOString();
                        }
                    });
                }
            });
            
            if (migrationCount > 0) {
                debugLog(`Data migration completed: ${migrationCount} projects updated`);
                saveProjects();
            }
        }

        // Log initialization complete
        debugLog(`AV Project Management Tool v${APP_VERSION} ready!`);
    </script>
</body>
</html>
